<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  background:#030005;
  color:#e8e6f3;
  font-family:Inter, sans-serif;
  padding:30px;
}

h1 { margin-bottom:20px; }

.user {
  background:#0a0510;
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.badge {
  font-size:.7rem;
  padding:4px 10px;
  border-radius:20px;
  margin-left:6px;
}

.Verified { background:#333; }
.Moderator { background:#2563eb; }
.Admin { background:#7b2cbf; }
.Founder { background:#f59e0b; }

button {
  background:#7b2cbf;
  border:none;
  color:white;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
}

button.secondary { background:#444; }
button.danger { background:#ef4444; }

select {
  background:#111;
  color:white;
  border:1px solid #333;
  border-radius:8px;
  padding:6px;
}
</style>
</head>

<body>

<h1>Admin Panel</h1>
<div id="users"></div>

<script>
const sb = supabase.createClient(
  "https://tstsijdifhgmpaszqknr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4"
);

const ROLE_LEVEL = {
  Verified: 1,
  Moderator: 2,
  Admin: 3,
  Founder: 4
};

let me;

(async () => {
  const { data: { user } } = await sb.auth.getUser();
  if (!user) return location.replace("/");

  const { data, error } = await sb
    .from("profiles")
    .select("id, role, roles")
    .eq("id", user.id)
    .single();

  if (error || ROLE_LEVEL[data.role] < ROLE_LEVEL.Admin) {
    return location.replace("/");
  }

  me = data;
  loadUsers();
})();

async function loadUsers() {
  const { data: users } = await sb
    .from("profiles")
    .select("id, role, roles");

  const wrap = document.getElementById("users");
  wrap.innerHTML = "";

  users.forEach(u => {
    const isHigherOrEqual =
      ROLE_LEVEL[u.role] >= ROLE_LEVEL[me.role];

    const div = document.createElement("div");
    div.className = "user";

    div.innerHTML = `
      <div>
        <strong>${u.id}</strong>
        <span class="badge ${u.role}">${u.role}</span>
      </div>

      <div>
        ${renderRoleSelect(u, isHigherOrEqual)}
      </div>
    `;

    wrap.appendChild(div);
  });
}

function renderRoleSelect(user, locked) {
  if (locked) return `<button class="secondary" disabled>Locked</button>`;

  const options = Object.keys(ROLE_LEVEL)
    .filter(r => ROLE_LEVEL[r] < ROLE_LEVEL[me.role])
    .map(r =>
      `<option value="${r}" ${user.role === r ? "selected" : ""}>${r}</option>`
    ).join("");

  return `
    <select onchange="changeRole('${user.id}', this.value)">
      ${options}
    </select>
  `;
}

async function changeRole(userId, newRole) {
  if (ROLE_LEVEL[newRole] >= ROLE_LEVEL[me.role]) return;

  await sb
    .from("profiles")
    .update({ roles: [newRole] })
    .eq("id", userId);

  loadUsers();
}
</script>

</body>
</html>

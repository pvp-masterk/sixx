<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Loading... | /six</title>
<meta name="description" content="Profile Viewer">

<!-- ASSETS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* =========================================
   1. CORE & RESET
   ========================================= */
:root {
  --bg-dark: #050505;
  --glass-bg: rgba(10, 10, 10, 0.6);
  --glass-border: rgba(255, 255, 255, 0.08);
  --text-main: #ffffff;
  --text-muted: #a1a1aa;
  --accent: #7b2cbf; /* Default, overwritten by JS */
  --accent-glow: rgba(123, 44, 191, 0.4);
  --ease-out: cubic-bezier(0.23, 1, 0.32, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body {
  background: var(--bg-dark);
  color: var(--text-main);
  font-family: 'Inter', sans-serif;
  overflow: hidden; /* Prevent scroll on container */
  height: 100vh;
  width: 100vw;
  cursor: none; /* Custom cursor */
  user-select: none;
}

/* Custom Cursor */
#cursor {
  position: fixed; top: 0; left: 0; width: 20px; height: 20px;
  border: 1px solid rgba(255,255,255,0.5); border-radius: 50%;
  pointer-events: none; z-index: 9999;
  transform: translate(-50%, -50%);
  transition: width 0.3s, height 0.3s, background 0.3s;
  mix-blend-mode: difference;
}
#cursor.hovered { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-color: transparent; }

/* =========================================
   2. BACKGROUND & OVERLAYS
   ========================================= */
.bg-layer { position: fixed; inset: 0; z-index: 0; }
.bg-media {
  width: 100%; height: 100%; object-fit: cover;
  opacity: 0; transition: opacity 1.5s ease;
}
.bg-media.loaded { opacity: 1; }

.vignette {
  position: absolute; inset: 0; pointer-events: none;
  background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 100%);
}
.noise {
  position: absolute; inset: 0; pointer-events: none; opacity: 0.04;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
}

/* =========================================
   3. CLICK TO ENTER
   ========================================= */
#enter-screen {
  position: fixed; inset: 0; z-index: 50;
  background: #000;
  display: flex; align-items: center; justify-content: center;
  transition: opacity 0.8s var(--ease-out), pointer-events 0.8s;
}
#enter-screen.hidden { opacity: 0; pointer-events: none; }
.enter-text {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem; letter-spacing: 2px;
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

/* =========================================
   4. 3D CARD CONTAINER
   ========================================= */
.perspective-container {
  display: flex; align-items: center; justify-content: center;
  height: 100vh; width: 100vw;
  perspective: 1200px;
  position: relative; z-index: 10;
}

.profile-card {
  width: 500px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  position: relative;
  transform-style: preserve-3d;
  will-change: transform;
  /* Initial hidden state */
  opacity: 0; transform: translateY(50px) rotateX(10deg);
  transition: box-shadow 0.3s ease;
}
/* Enhanced Drop Shadow */
.profile-card::after {
  content: ''; position: absolute; inset: 20px; z-index: -1;
  background: var(--accent); opacity: 0; filter: blur(60px);
  transition: opacity 1s ease;
}
.profile-card.active::after { opacity: 0.3; }

/* =========================================
   5. CARD CONTENT
   ========================================= */
.card-banner {
  height: 180px; width: 100%;
  border-radius: 24px 24px 0 0;
  overflow: hidden; position: relative;
  border-bottom: 1px solid var(--glass-border);
}
.banner-img { width: 100%; height: 100%; object-fit: cover; }

.card-content {
  padding: 0 30px 35px;
  position: relative;
  display: flex; flex-direction: column; align-items: center;
  text-align: center;
}

/* Avatar Area */
.avatar-container {
  position: relative; margin-top: -65px; margin-bottom: 15px;
  width: 130px; height: 130px;
  display: flex; justify-content: center; align-items: center;
}

/* Canvas Visualizer Layer */
#visualizer-canvas {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 240px; height: 240px; /* Larger than avatar */
  pointer-events: none; z-index: 0;
}

.avatar-img {
  width: 120px; height: 120px;
  border-radius: 50%;
  background: #111;
  object-fit: cover;
  border: 2px solid rgba(255,255,255,0.1);
  position: relative; z-index: 2;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

/* Text Info */
.username {
  font-size: 1.8rem; font-weight: 700; color: #fff;
  margin-bottom: 6px; position: relative; display: inline-block;
}
.badges {
  display: flex; gap: 6px; justify-content: center; margin-bottom: 15px;
}
.badge {
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; color: var(--text-muted);
  display: flex; align-items: center; gap: 4px;
}
.badge i { color: var(--accent); }

.bio {
  font-size: 0.95rem; line-height: 1.6; color: rgba(255,255,255,0.8);
  margin-bottom: 25px; white-space: pre-wrap; font-weight: 300; width: 100%;
}

.stats {
  display: flex; gap: 20px; width: 100%; justify-content: center;
  padding-top: 20px; border-top: 1px solid var(--glass-border);
}
.stat { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
.stat i { color: var(--accent); font-size: 1rem; }

/* Edit Button */
.edit-btn {
  position: absolute; top: 15px; right: 15px;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff; padding: 6px 12px; border-radius: 20px;
  font-size: 0.75rem; text-decoration: none;
  opacity: 0; transform: translateY(-10px); transition: 0.3s;
}
.edit-btn.show { opacity: 1; transform: translateY(0); }
.edit-btn:hover { background: var(--accent); border-color: var(--accent); }

/* FX Classes */
.fx-glow { text-shadow: 0 0 15px var(--accent-glow); }
.fx-rgb { animation: glitch 2s infinite; text-shadow: 2px 0 var(--accent), -2px 0 cyan; }

/* Loaders */
.skel { background: rgba(255,255,255,0.08); border-radius: 4px; animation: pulse 1s infinite; }
.skel-text { height: 1.5rem; width: 150px; margin: 0 auto 10px; }
.skel-bio { height: 3rem; width: 100%; }

/* Mobile */
@media(max-width: 600px) {
  .profile-card { width: 90%; border-radius: 20px; }
  .perspective-container { perspective: none; } /* Disable 3D on mobile for performance */
  .profile-card { transform: none !important; } 
  #cursor { display: none; }
}
</style>
</head>
<body>

<!-- Custom Cursor -->
<div id="cursor"></div>

<!-- Click Overlay -->
<div id="enter-screen">
  <div class="enter-text">[ CLICK TO ENTER ]</div>
</div>

<!-- Background -->
<div class="bg-layer">
  <div id="bg-container"></div>
  <div class="vignette"></div>
  <div class="noise"></div>
</div>

<!-- Main UI -->
<div class="perspective-container" id="tilt-wrapper">
  <main class="profile-card" id="main-card">
    
    <div class="card-banner">
      <div id="banner-container" style="width:100%;height:100%"></div>
      <a href="#" class="edit-btn" id="btn-edit">
        <i class="ph-bold ph-pencil-simple"></i> Edit
      </a>
    </div>

    <div class="card-content">
      <div class="avatar-container">
        <!-- Canvas inserted here by JS -->
        <canvas id="visualizer-canvas"></canvas>
        <img src="" id="ui-avatar" class="avatar-img">
      </div>

      <div id="ui-identity">
        <div class="skel skel-text"></div>
      </div>
      
      <div id="ui-badges" class="badges"></div>

      <div id="ui-bio" class="bio">
        <div class="skel skel-bio"></div>
      </div>

      <div class="stats">
        <div class="stat"><i class="ph-bold ph-eye"></i> <span id="ui-views">0</span></div>
        <div class="stat"><i class="ph-bold ph-calendar"></i> <span id="ui-joined">-</span></div>
      </div>
    </div>

  </main>
</div>

<script>
/**
 * ==========================================
 * HIGH PERFORMANCE PROFILE ENGINE
 * ==========================================
 */

// --- CONFIG ---
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co", 
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  defaults: {
    avatar: "https://cdn.discordapp.com/embed/avatars/0.png",
    banner: "https://i.pinimg.com/originals/2b/2b/34/2b2b34927d6e477611c977d24275037d.gif"
  }
};

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

// --- AUDIO CONTROLLER (Canvas Visualizer) ---
class AudioVisualizer {
  constructor(videoElement, canvasId, color) {
    this.video = videoElement;
    this.canvas = document.getElementById(canvasId);
    this.ctx = this.canvas.getContext('2d');
    this.color = color;
    this.active = false;
    this.audioCtx = null;
    this.analyser = null;
    this.source = null;
    
    // Resize canvas for high DPI
    const size = 300;
    this.canvas.width = size;
    this.canvas.height = size;
  }

  init() {
    if(this.active) return;
    
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      this.audioCtx = new AudioContext();
      this.analyser = this.audioCtx.createAnalyser();
      this.source = this.audioCtx.createMediaElementSource(this.video);
      
      this.source.connect(this.analyser);
      this.analyser.connect(this.audioCtx.destination); // Connect to speakers
      
      this.analyser.fftSize = 256; // Balance between detail and performance
      this.bufferLength = this.analyser.frequencyBinCount;
      this.dataArray = new Uint8Array(this.bufferLength);
      
      this.active = true;
      this.render();
    } catch(e) {
      console.log("Audio Context prevented (waiting for interaction)", e);
    }
  }

  render() {
    if(!this.active) return;
    
    requestAnimationFrame(this.render.bind(this));
    
    this.analyser.getByteFrequencyData(this.dataArray);
    
    const ctx = this.ctx;
    const width = this.canvas.width;
    const height = this.canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = 65; // Slightly larger than avatar radius (60px)
    
    ctx.clearRect(0, 0, width, height);
    
    ctx.beginPath();
    // Create a circular spectrum
    const bars = 60;
    const step = (Math.PI * 2) / bars;
    
    for (let i = 0; i < bars; i++) {
      // Map frequency data to bars (focus on bass/mids)
      const value = this.dataArray[i % (this.bufferLength / 2)]; 
      const barHeight = (value / 255) * 50; 
      
      const angle = i * step;
      
      // Start point (on circle edge)
      const x1 = centerX + Math.cos(angle) * radius;
      const y1 = centerY + Math.sin(angle) * radius;
      
      // End point (radiating out)
      const x2 = centerX + Math.cos(angle) * (radius + barHeight);
      const y2 = centerY + Math.sin(angle) * (radius + barHeight);
      
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
    }
    
    ctx.strokeStyle = this.color;
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    
    // Add glow
    ctx.shadowBlur = 15;
    ctx.shadowColor = this.color;
    
    ctx.stroke();
    ctx.shadowBlur = 0; // Reset for performance
  }
}

// --- MAIN CONTROLLER ---
class ProfileApp {
  constructor() {
    this.els = {
      card: document.getElementById('main-card'),
      wrapper: document.getElementById('tilt-wrapper'),
      bg: document.getElementById('bg-container'),
      banner: document.getElementById('banner-container'),
      avatar: document.getElementById('ui-avatar'),
      identity: document.getElementById('ui-identity'),
      badges: document.getElementById('ui-badges'),
      bio: document.getElementById('ui-bio'),
      views: document.getElementById('ui-views'),
      joined: document.getElementById('ui-joined'),
      enterScreen: document.getElementById('enter-screen'),
      editBtn: document.getElementById('btn-edit'),
      cursor: document.getElementById('cursor')
    };

    this.state = {
      user: null,
      audioVisualizer: null,
      videoBlobUrl: null
    };

    this.initCursor();
    this.init();
  }

  // 1. Fetch Data
  async init() {
    // Get username from URL or fallback to current auth user
    let username = window.location.pathname.split('/@')[1];
    
    if (!username) {
      const { data: { user } } = await sb.auth.getUser();
      if (user) {
        const { data } = await sb.from("profiles").select("username").eq("id", user.id).single();
        if(data) username = data.username;
      }
    }

    if (!username) return this.showError("User not found");

    const { data, error } = await sb
      .from("profiles")
      .select("*")
      .eq("username", username)
      .maybeSingle();

    if (error || !data) return this.showError("404 Not Found");

    this.state.user = data;
    this.renderProfile(data);
    this.setupInteractions();
    
    // Increment view count
    sb.rpc('increment_views', { row_id: data.id });
  }

  // 2. Render UI
  renderProfile(data) {
    document.title = `${data.username} | /six`;
    
    const accent = data.theme_color || '#7b2cbf';
    document.documentElement.style.setProperty('--accent', accent);
    document.documentElement.style.setProperty('--accent-glow', accent + '66');

    // Avatar
    this.els.avatar.src = data.avatar || CONFIG.defaults.avatar;

    // Username & Effects
    const nameEl = document.createElement('div');
    nameEl.className = `username fx-${data.username_effect || 'none'}`;
    nameEl.textContent = data.username;
    this.els.identity.innerHTML = '';
    this.els.identity.appendChild(nameEl);

    // Badges (Example Logic)
    const roles = { 'Admin': 'ph-crown', 'Verified': 'ph-seal-check' };
    // Hardcoded example roles, replace with your DB logic
    let badgeHTML = '';
    if(data.id) badgeHTML += `<div class="badge"><i class="ph-fill ph-user"></i> Member</div>`;
    this.els.badges.innerHTML = badgeHTML;

    // Bio
    this.els.bio.innerHTML = this.escapeHtml(data.bio || "No biography provided.");

    // Stats
    this.els.views.innerText = (data.views || 0).toLocaleString();
    this.els.joined.innerText = new Date(data.created_at).toLocaleDateString();

    // Banner
    const bannerUrl = data.banner_url || CONFIG.defaults.banner;
    this.els.banner.innerHTML = `<img src="${bannerUrl}" class="banner-img">`;

    // Background & Media Preparation
    this.prepareBackground(data);
    
    // Check Ownership for Edit Button
    this.checkOwner();
  }

  // 3. Background System (CORS & Performance)
  async prepareBackground(data) {
    if (data.bg_value && data.bg_type === "video") {
      // Fetch Blob to handle CORS for visualizer
      try {
        const response = await fetch(data.bg_value);
        const blob = await response.blob();
        this.state.videoBlobUrl = URL.createObjectURL(blob);
        
        const video = document.createElement('video');
        video.src = this.state.videoBlobUrl;
        video.loop = true;
        video.muted = false;
        video.playsInline = true;
        video.className = 'bg-media';
        
        this.els.bg.innerHTML = '';
        this.els.bg.appendChild(video);

        // Init Visualizer Logic (Waiting for start)
        this.state.audioVisualizer = new AudioVisualizer(
          video, 
          'visualizer-canvas', 
          data.theme_color || '#7b2cbf'
        );

      } catch (e) {
        console.error("Video Fetch Error", e);
        this.els.bg.innerHTML = `<img src="${CONFIG.defaults.banner}" class="bg-media loaded">`;
      }
    } else {
      // Image Background
      const imgUrl = data.bg_value || CONFIG.defaults.banner;
      this.els.bg.innerHTML = `<img src="${imgUrl}" class="bg-media loaded">`;
      // Hide canvas if no audio
      document.getElementById('visualizer-canvas').style.display = 'none';
    }
  }

  // 4. Interaction (Click to Enter + Tilt)
  setupInteractions() {
    // Click to Enter
    this.els.enterScreen.addEventListener('click', () => {
      this.els.enterScreen.classList.add('hidden');
      
      // Reveal Card
      this.els.card.style.opacity = '1';
      this.els.card.style.transform = 'translateY(0) rotateX(0)';
      this.els.card.classList.add('active');

      // Play Media
      const video = document.querySelector('video');
      if (video) {
        video.volume = 0.5;
        video.play().then(() => {
          video.classList.add('loaded');
          // Start Visualizer
          if(this.state.audioVisualizer) this.state.audioVisualizer.init();
        }).catch(e => console.log("Play failed", e));
      }
    });

    // 3D Tilt Logic
    if(window.innerWidth > 600) {
      document.addEventListener('mousemove', (e) => this.handleTilt(e));
    }
  }

  handleTilt(e) {
    const card = this.els.card;
    const x = e.clientX;
    const y = e.clientY;
    const w = window.innerWidth;
    const h = window.innerHeight;
    
    // Calculate rotation (max 15deg)
    const rotateX = ((y - h / 2) / h) * -15;
    const rotateY = ((x - w / 2) / w) * 15;

    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
  }

  // Custom Cursor Logic
  initCursor() {
    const cursor = this.els.cursor;
    
    // Smooth follow using simpler logic for performance
    document.addEventListener('mousemove', (e) => {
      cursor.style.left = e.clientX + 'px';
      cursor.style.top = e.clientY + 'px';
    });

    // Hover effects
    document.querySelectorAll('a, button, .profile-card').forEach(el => {
      el.addEventListener('mouseenter', () => cursor.classList.add('hovered'));
      el.addEventListener('mouseleave', () => cursor.classList.remove('hovered'));
    });
  }

  async checkOwner() {
    const { data: { session } } = await sb.auth.getSession();
    if (session && this.state.user && session.user.id === this.state.user.id) {
      this.els.editBtn.classList.add('show');
      this.els.editBtn.href = `/@${this.state.user.username}/edit`;
    }
  }

  escapeHtml(str) {
    const div = document.createElement('div');
    div.innerText = str;
    return div.innerHTML;
  }

  showError(msg) {
    this.els.enterScreen.style.display = 'none';
    this.els.card.innerHTML = `<div style="padding:40px">${msg}</div>`;
    this.els.card.style.opacity = 1;
    this.els.card.style.transform = 'none';
  }
}

// Start App
document.addEventListener('DOMContentLoaded', () => new ProfileApp());

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loading Profile...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Icons (Phosphor Icons) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root {
      --bg-color: #09090b;
      --card-bg: rgba(24, 24, 27, 0.6);
      --border-color: rgba(255, 255, 255, 0.1);
      --accent: #5865F2; /* Discord Blurple */
      --accent-hover: #4752c4;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: var(--bg-color);
      /* Subtle animated background */
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      color: var(--text-main);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Main Card */
    .profile-card {
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      margin: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
      position: relative;
    }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* Banner Area */
    .banner-container {
      height: 160px;
      width: 100%;
      background-color: #27272a;
      position: relative;
    }

    .banner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Profile Header Info */
    .profile-header {
      padding: 0 24px;
      position: relative;
      margin-bottom: 16px;
    }

    .header-top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end; /* Aligns avatar bottom with button bottom */
      margin-top: -50px; /* Pull avatar up into banner */
      margin-bottom: 10px;
      position: relative;
    }

    .avatar-wrapper {
      position: relative;
      z-index: 2;
    }

    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #18181b; /* Matches card bg to create cutout effect */
      background: #27272a;
      transition: transform 0.3s ease;
    }
    
    .avatar:hover { transform: scale(1.05); }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      gap: 8px;
      padding-top: 54px; /* Push down to clear banner area visually if needed */
      z-index: 5;
    }

    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px; /* Pill shape */
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      border: 1px solid transparent;
    }

    .btn-icon-only {
      padding: 8px;
      border-radius: 50%;
    }

    /* Edit Button (Primary) */
    .btn-primary {
      background-color: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
    }
    
    .btn-primary:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(88, 101, 242, 0.5);
    }

    /* Share Button (Secondary/Glass) */
    .btn-glass {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-main);
    }

    .btn-glass:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .profile-name {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.username-row {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.verified-badge {
  width: 16px;
  height: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-top: 1px; /* ðŸ‘ˆ optical alignment fix */
}

.verified-badge img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}


.role-row {
  font-size: 0.85rem;
  color: var(--text-muted);
  display: none;
}



    .username {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(88, 101, 242, 0.15);
      border: 1px solid rgba(88, 101, 242, 0.3);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      margin-top: 8px;
    }
    
    .badge i { font-size: 14px; }

    /* Bio Section */
    .content {
      padding: 0 24px 32px 24px;
    }

    .bio {
      margin-top: 12px;
      color: var(--text-muted);
      line-height: 1.6;
      font-size: 15px;
      white-space: pre-wrap; 
    }

    /* States */
    .error-state {
      text-align: center;
      padding: 40px;
      color: #ef4444;
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #27272a 25%, #3f3f46 50%, #27272a 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    .sk-banner { height: 160px; width: 100%; }
    .sk-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #18181b; margin-top: -50px; }
    .sk-text { height: 20px; margin-bottom: 8px; }
    .w-50 { width: 50%; }
    .w-80 { width: 80%; }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .role-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .role-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 400;
      text-transform: capitalize;
      color: white;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-shadow: 0 0 1px rgba(0,0,0,0.15);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .role-badge img {
      width: 14px;
      height: 14px;
      object-fit: contain;
      border-radius: 50%;
    }

    .role-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }
  </style>
</head>
<body>

<div id="app" class="profile-card">
  <!-- Initial Skeleton Loader -->
  <div class="banner-container sk-banner skeleton"></div>
  <div class="profile-header">
    <div class="header-top-row">
       <div class="sk-avatar skeleton"></div>
    </div>
    <div class="sk-text w-50 skeleton" style="margin-top: 15px;"></div>
    <div class="sk-text w-80 skeleton"></div>
  </div>
</div>

<script>
  // -- CONFIG --
  const SUPABASE_URL = "https://tstsijdifhgmpaszqknr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4";
  
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // -- UTILS --
  function escapeHtml(unsafe) {
    if (!unsafe) return "";
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  const path = window.location.pathname;
  const username = decodeURIComponent(
    path.startsWith("/@") ? path.slice(2).replace(/\//g, "") : ""
  );

  // -- MAIN LOGIC --

  async function loadProfile() {
    console.log("Fetching profile for:", username);

    if (!username) {
      renderError("No username provided in URL.");
      return;
    }

    // 1. Fetch the Profile Data
    const { data: profile, error } = await supabaseClient
      .from("profiles")
      .select("*")
      .eq("username", username)
      .eq("public", true)
      .single();

    if (error || !profile) {
      console.error(error);
      renderError("Profile not found or is private.");
      return;
    }

    // 2. Render the Profile immediately (Fast UI)
    renderProfile(profile);

    // 3. Check for Ownership (Asynchronous/Non-blocking)
    checkAndRenderEditButton(profile.id); // Passing the profile's UUID
  }

  function renderProfile(user) {
    document.title = `${user.username} (@${user.username}) | Profile`;

    const avatar = user.avatar || "https://cdn.discordapp.com/embed/avatars/0.png";
    const bannerHTML = user.banner_url 
      ? `<img class="banner" src="${escapeHtml(user.banner_url)}" alt="Banner">`
      : `<div class="banner" style="background: linear-gradient(45deg, #4f46e5, #9333ea);"></div>`;

    const safeBio = escapeHtml(user.bio);

    document.getElementById("app").innerHTML = `
      <div class="banner-container">
        ${bannerHTML}
      </div>

      <div class="profile-header">
        <div class="header-top-row">
          <div class="avatar-wrapper">
            <img class="avatar" src="${escapeHtml(avatar)}" alt="${escapeHtml(user.username)}" />
          </div>
          
          <!-- Action Buttons Container (Initially Empty or just Share) -->
          <div class="action-buttons" id="actionButtons">
             <button class="btn btn-glass btn-icon-only" onclick="copyProfileLink()" title="Copy Profile Link">
                <i class="ph-bold ph-share-network"></i>
             </button>
          </div>
        </div>

        <div class="profile-name">
  <div class="username-row">
    <span class="username">${escapeHtml(user.username)}</span>
    ${
      Array.isArray(user.roles) && user.roles.includes("Verified")
        ? `
          <span class="verified-badge">
            <img src="/assets/verified.png" alt="Verified">
          </span>
        `
        : ""
    }
  </div>

  <div class="role-row">
    ${user.role ? escapeHtml(user.role) : ""}
  </div>
</div>




        <div class="badge">
          <i class="ph-fill ph-seal-check"></i>
          <span>Verified via Discord</span>
        </div>

        <div id="roleContainer" class="role-container"></div>
      </div>

      <div class="content">
        ${safeBio ? `<div class="bio">${safeBio}</div>` : `<div class="bio" style="font-style:italic; opacity:0.5">No bio available.</div>`}
      </div>
    `;

    // Render Roles
    const roleContainer = document.getElementById("roleContainer");
    if (user.roles && user.roles.length > 0) {
      user.roles.forEach(roleName => {
        const span = document.createElement("span");
        span.className = `role-badge role-${roleName.toLowerCase()}`;
        
        // Error handling for missing images
        const img = document.createElement("img");
        img.src = `/assets/${roleName.toLowerCase()}.png`;
        img.onerror = function() { this.style.display = 'none'; }; // Hide icon if missing
        
        span.appendChild(img);
        span.appendChild(document.createTextNode(roleName));
        roleContainer.appendChild(span);
      });
    }
  }

  // -- OWNERSHIP CHECK --
  async function checkAndRenderEditButton(profileId) {
    // Check local session
    const { data: { session } } = await supabaseClient.auth.getSession();
    
    // If logged in AND the user ID matches the profile ID
    if (session && session.user && session.user.id === profileId) {
      
      const actionsDiv = document.getElementById("actionButtons");
      if(!actionsDiv) return;

      // Create Edit Button
      const editBtn = document.createElement("a");
     editBtn.href = `/@${encodeURIComponent(username)}/edit`; // Dynamic link based on username
      editBtn.className = "btn btn-primary";
      editBtn.innerHTML = `<i class="ph-bold ph-pencil-simple"></i> Edit Profile`;
      
      // Prepend so it sits to the left of the Share button
      actionsDiv.prepend(editBtn);
    }
  }

  // -- EXTRA FEATURES --
  function copyProfileLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
      // Simple visual feedback
      const btn = document.querySelector('.ph-share-network').parentElement;
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="ph-bold ph-check"></i>';
      setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
    });
  }

  function renderError(msg) {
    document.title = "Profile Not Found";
    document.getElementById("app").innerHTML = `
      <div class="error-state">
        <i class="ph ph-warning-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
        <h3>Ooops!</h3>
        <p>${msg}</p>
      </div>
    `;
  }

  loadProfile();
</script>

</body>
</html>

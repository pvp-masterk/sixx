<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Loading Profile... | /six</title>

<!-- EXTERNAL ASSETS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Cinzel:wght@400;700&family=Orbitron:wght@600&family=Playfair+Display:ital,wght@0,600;1,600&family=UnifrakturMaguntia&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">

<style>
/* =========================================
   1. CORE VARIABLES & THEME
   ========================================= */
:root {
  --bg-deep: #030303;
  --glass-surface: rgba(15, 15, 15, 0.65);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-highlight: rgba(255, 255, 255, 0.05);
  
  --text-main: #ffffff;
  --text-muted: #9ca3af;
  
  /* Dynamic Accent (Set by JS) */
  --accent: #7b2cbf;
  --accent-glow: rgba(123, 44, 191, 0.5);
  
  --radius-card: 24px;
  --ease-lux: cubic-bezier(0.22, 1, 0.36, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background-color: var(--bg-deep);
  color: var(--text-main);
  font-family: 'Inter', sans-serif;

  min-height: 100vh;
  overflow-x: hidden;

  /* REMOVE THESE */
  display: block;
  padding: 0;
}

/* =========================================
   2. IMMERSIVE BACKGROUND SYSTEM
   ========================================= */
.bg-layer {
  position: fixed;
  inset: 0;
  z-index: -1;
  overflow: hidden;
}


/* Dynamic Background (User Image/Video) */
.user-bg-media {
  position: absolute;
  inset: 0;

  width: 100%;
  height: 100%;
  object-fit: cover;

  transition:
    filter 0.6s cubic-bezier(0.22, 1, 0.36, 1),
    opacity 0.6s ease,
    transform 0.6s ease;

  will-change: filter, transform;
}

/* BLURRED MODE (default / guns.lol style) */
.bg-blurred .user-bg-media {
  filter: blur(32px) brightness(0.7);
  transform: scale(1.08);
  opacity: 0.9;
}

/* CLEAN CINEMATIC MODE */
.bg-clean .user-bg-media {
  filter: none;
  transform: scale(1);
  opacity: 1;
}


/* Noise Overlay */
.noise-overlay {
  position: absolute; inset: 0; pointer-events: none;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhZWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
  opacity: 0.12;
   mix-blend-mode: overlay;
}

/* Vignette */
.vignette {
  background: radial-gradient(circle at center,
    rgba(0,0,0,0) 0%,
    rgba(0,0,0,0.6) 80%,
    rgba(0,0,0,0.9) 100%
  );
}


/* =========================================
   3. THE GLASS CARD
   ========================================= */
.profile-card {
  width: 100%; max-width: 550px;
  background: var(--glass-surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-card);
  box-shadow: 0 40px 100px -20px rgba(0,0,0,0.7);
  overflow: hidden;
  position: relative;
  opacity: 0; transform: translateY(30px) scale(0.95);
  animation: entrance 1s var(--ease-lux) forwards 0.2s;
}

@keyframes entrance {
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Glossy Shine Reflection */
.profile-card::before {
  content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 2;
  background: linear-gradient(125deg, transparent 0%, rgba(255,255,255,0.03) 40%, transparent 60%);
}

/* =========================================
   4. PROFILE CONTENT
   ========================================= */
.card-header { position: relative; width: 100%; height: 200px; overflow: hidden; background: #000; }

/* Banner */
.banner-media {
  width: 100%; height: 100%; object-fit: cover;
  mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
  -webkit-mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
  transition: transform 10s ease;
}
.profile-card:hover .banner-media { transform: scale(1.05); }

/* Edit Button (Floating) */
.edit-btn {
  position: absolute; top: 20px; right: 20px; z-index: 10;
  background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  color: #fff; padding: 8px 16px; border-radius: 20px;
  font-size: 0.75rem; font-weight: 600; text-decoration: none;
  display: flex; align-items: center; gap: 6px;
  transition: 0.2s; opacity: 0; transform: translateY(-10px);
}
.edit-btn.visible { opacity: 1; transform: translateY(0); }
.edit-btn:hover { background: var(--accent); border-color: var(--accent); }

.card-body {
  padding: 0 32px 40px; margin-top: -60px; position: relative; z-index: 3;
}

/* Avatar */
.avatar-wrapper {
  width: 120px; height: 120px;
  border-radius: 50%; padding: 4px;
  background: rgba(20,20,20,0.8);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  margin-bottom: 16px;
}
.avatar-img {
  width: 100%; height: 100%; border-radius: 50%;
  object-fit: cover; background: #111;
  display: block;
}

/* Username & Identity */
.identity-row { margin-bottom: 12px; }

/* --- USERNAME EFFECTS --- */
.username {
  font-size: 2rem; line-height: 1.1; margin-bottom: 6px;
  display: inline-block;
}

/* 1. Neon Glow */
.fx-glow {
  color: #fff;
  text-shadow: 0 0 10px var(--accent-glow), 0 0 20px var(--accent), 0 0 40px var(--accent);
}

/* 2. RGB Glitch */
.fx-rgb {
  position: relative; color: #fff;
  text-shadow: 2px 0 var(--accent), -2px 0 #00ffff;
  animation: glitch-skew 3s infinite linear alternate-reverse;
}
@keyframes glitch-skew {
  0% { transform: skew(0deg); }
  20% { transform: skew(-2deg); }
  40% { transform: skew(1deg); }
  60% { transform: skew(-1deg); }
  80% { transform: skew(2deg); }
  100% { transform: skew(0deg); }
}

/* 3. Luxury Gradient */
.fx-gradient {
  background: linear-gradient(135deg, #fff 20%, var(--accent) 50%, #fff 80%);
  background-size: 200% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shine 5s linear infinite;
}
@keyframes shine { to { background-position: 200% center; } }

/* Role Badges */
.badges-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.role-pill {
  height: 24px; padding: 0 10px;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-muted); display: flex; align-items: center; gap: 6px;
  transition: 0.2s;
}
.role-pill:hover { border-color: var(--accent); color: #fff; background: rgba(255,255,255,0.08); }
.role-pill i { color: var(--accent); font-size: 0.8rem; }

/* Bio */
.bio-text {
  font-size: 0.95rem; line-height: 1.6; color: rgba(255,255,255,0.8);
  margin: 20px 0; white-space: pre-wrap; font-weight: 300;
}

/* Footer Stats */
.card-footer {
  border-top: 1px solid var(--glass-border);
  padding-top: 20px; margin-top: 20px;
  display: flex; gap: 24px;
}
.stat-item {
  display: flex; align-items: center; gap: 8px;
  font-size: 0.8rem; color: var(--text-muted); font-weight: 500;
}
.stat-item i { color: var(--accent); font-size: 1rem; }

/* --- SKELETON LOADER --- */
.skel { background: rgba(255,255,255,0.05); border-radius: 6px; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 0.8; } 100% { opacity: 0.4; } }

.loading-view .banner-media { opacity: 0; }
.loading-view .avatar-img { opacity: 0; }
.loading-view .skel-avatar { position: absolute; inset:0; border-radius: 50%; }
.loading-view .skel-title { width: 60%; height: 32px; margin-bottom: 10px; }
.loading-view .skel-bio { width: 100%; height: 60px; }

/* Utilities */
.hidden { display: none !important; }

/* Mobile */
@media (max-width: 480px) {
  .profile-card { border-radius: 0; min-height: 100vh; box-shadow: none; border: none; }
  .card-header { height: 160px; }
  .avatar-wrapper { width: 100px; height: 100px; }
  .bio-text { font-size: 0.9rem; }
}
   .profile-wrapper {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.audio-visualizer {
  position: absolute;
  right: 24px;
  top: 24px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  pointer-events: none;
}

.stroke {
  width: 4px;
  height: 20px;
  border-radius: 6px;
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent-glow);
  transition: background 0.2s linear;
}

</style>
</head>
<body>

<!-- Background Layer -->
<div class="bg-layer">
  <div id="dynamic-bg-container"></div> <!-- Video or Image injected here -->
  <div class="vignette"></div>
  <div class="noise-overlay"></div>
</div>

<!-- Main Card -->
   <div class="profile-wrapper">
<main class="profile-card loading-view" id="main-card">
  
  <div class="card-header">
    <div id="banner-container"></div> <!-- Banner injected here -->
    <a href="#" class="edit-btn" id="btn-edit-profile">
      <i class="ph-bold ph-pencil-simple"></i> Edit Profile
    </a>
  </div>

  <div class="card-body">
    <div class="avatar-wrapper">
      <img src="" id="ui-avatar" class="avatar-img">
      <div class="skel skel-avatar"></div>
    </div>

    <div class="identity-row">
      <h1 id="ui-username" class="username">
        <!-- Text injected -->
        <div class="skel skel-title"></div>
      </h1>
       <div class="audio-visualizer hidden" id="audio-visualizer">
  <div class="stroke left"></div>
  <div class="stroke right"></div>
</div>
      <div id="ui-badges" class="badges-container"></div>
    </div>

    <div id="ui-bio" class="bio-text">
      <div class="skel skel-bio"></div>
    </div>

    <div class="card-footer">
      <div class="stat-item">
        <i class="ph-bold ph-eye"></i> <span id="ui-views">0</span> Views
      </div>
      <div class="stat-item">
        <i class="ph-bold ph-calendar-blank"></i> <span id="ui-joined">2024</span>
      </div>
    </div>
  </div>

</main>
</div>
<script>
/**
 * ==========================================
 * PROFILE VIEWER ENGINE (CORS FIXED + VISUALIZER WORKING)
 * ==========================================
 */
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co", 
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  defaults: {
    avatar: "https://cdn.discordapp.com/embed/avatars/0.png",
    banner: "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
  },
  roles: {
    'Admin': 'ph-crown',
    'Verified': 'ph-seal-check',
    'Member': 'ph-user'
  }
};

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

class ProfileViewer {
  constructor() {
    this.dom = {
      card: document.getElementById('main-card'),
      bgContainer: document.getElementById('dynamic-bg-container'),
      bannerContainer: document.getElementById('banner-container'),
      avatar: document.getElementById('ui-avatar'),
      username: document.getElementById('ui-username'),
      badges: document.getElementById('ui-badges'),
      bio: document.getElementById('ui-bio'),
      views: document.getElementById('ui-views'),
      joined: document.getElementById('ui-joined'),
      editBtn: document.getElementById('btn-edit-profile')
    };

    this.audioCtx = null;
    this.init();
  }

  async init() {
    let username = window.location.pathname.split('/@')[1];

    if (!username) {
      const { data: { user } } = await sb.auth.getUser();
      if (user) {
        const { data } = await sb.from("profiles")
          .select("username")
          .eq("id", user.id)
          .single();
        if (data) username = data.username;
      }
    }

    if (!username) return this.renderError("User not found");

    const { data: profile, error } = await sb
      .from("profiles")
      .select("*")
      .eq("username", username)
      .maybeSingle();

    if (error || !profile)
      return this.renderError("404: Profile Not Found");

    await this.loadCustomFont(profile);
    this.render(profile);
    this.checkOwnership(profile.id, profile.username);
    this.incrementViews(profile.id);
  }

  render(data) {
    document.title = `${data.username} | /six`;

    const accent = data.theme_color || '#7b2cbf';
    document.documentElement.style.setProperty('--accent', accent);
    document.documentElement.style.setProperty('--accent-glow', accent + '66');

    /* ===== BACKGROUND (CORS FIXED) ===== */
    if (data.bg_value && data.bg_type === "video") {
      this.loadVideoWithCORSFix(data.bg_value);
    } else if (data.bg_value) {
      this.dom.bgContainer.innerHTML =
        `<img src="${data.bg_value}" class="user-bg-media">`;
    } else {
      this.dom.bgContainer.innerHTML =
        `<div style="width:100%;height:100%;background:radial-gradient(circle at center, ${accent}40 0%, transparent 70%)"></div>`;
    }

    /* ===== HEADER ===== */
    this.dom.avatar.src = data.avatar || CONFIG.defaults.avatar;

    const bannerUrl = data.banner_url || CONFIG.defaults.banner;
    if (bannerUrl.match(/\.(mp4|webm)$/)) {
      this.dom.bannerContainer.innerHTML =
        `<video src="${bannerUrl}" autoplay muted loop playsinline class="banner-media"></video>`;
    } else {
      this.dom.bannerContainer.innerHTML =
        `<img src="${bannerUrl}" class="banner-media">`;
    }

    /* ===== USER INFO ===== */
    this.dom.username.textContent = data.username;
    this.dom.username.className =
      `username fx-${data.username_effect || 'none'}`;

    this.dom.bio.innerHTML =
      this.escapeHtml(data.bio || "No biography provided.");

    this.dom.views.innerText =
      (data.views || 0).toLocaleString();

    this.dom.joined.innerText =
      new Date(data.created_at)
        .toLocaleDateString(undefined, { year: 'numeric', month: 'short' });

    this.dom.card.classList.remove('loading-view');
  }

  /* ===== CORS FIX METHOD ===== */
  async loadVideoWithCORSFix(url) {
    try {
      const response = await fetch(url);
      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);

      this.dom.bgContainer.innerHTML = `
        <video
          src="${objectUrl}"
          class="user-bg-media"
          autoplay
          loop
          playsinline
          muted
          preload="auto"
          id="bg-video">
        </video>
      `;

      const video = document.getElementById("bg-video");

      const startAudio = async () => {
        video.muted = false;
        await video.play().catch(() => {});

        if (!this.audioCtx) {
          this.initVisualizer(video);
        }

        document.removeEventListener("click", startAudio);
        document.removeEventListener("touchstart", startAudio);
      };

      document.addEventListener("click", startAudio);
      document.addEventListener("touchstart", startAudio);

    } catch (err) {
      console.error("Video load failed:", err);
    }
  }

  /* ===== VISUALIZER ===== */
  initVisualizer(videoEl) {
    const visualizer = document.getElementById("audio-visualizer");
    if (!visualizer) return;

    const left = visualizer.querySelector(".left");
    const right = visualizer.querySelector(".right");

    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = this.audioCtx.createMediaElementSource(videoEl);
    const analyser = this.audioCtx.createAnalyser();

    analyser.fftSize = 256;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    source.connect(analyser);
    analyser.connect(this.audioCtx.destination);

    visualizer.classList.remove("hidden");

    const animate = () => {
      requestAnimationFrame(animate);

      analyser.getByteFrequencyData(dataArray);

      let bass = 0;
      for (let i = 0; i < 10; i++) bass += dataArray[i];
      bass /= 10;

      const intensity = bass / 255;

      const height = 20 + intensity * 25;
      const thickness = 4 + intensity * 6;
      const hue = 270 + intensity * 80;
      const glow = 10 + intensity * 40;

      left.style.height = `${height}px`;
      right.style.height = `${height * 0.8}px`;

      left.style.width = `${thickness}px`;
      right.style.width = `${thickness}px`;

      left.style.background = `hsl(${hue}, 80%, 60%)`;
      right.style.background = `hsl(${hue}, 80%, 60%)`;

      left.style.boxShadow = `0 0 ${glow}px hsl(${hue}, 80%, 60%)`;
      right.style.boxShadow = `0 0 ${glow}px hsl(${hue}, 80%, 60%)`;
    };

    animate();
  }

  async checkOwnership(profileId, username) {
    const { data: { session } } = await sb.auth.getSession();
    if (session && session.user.id === profileId) {
      this.dom.editBtn.href = `/@${username}/edit`;
      this.dom.editBtn.classList.add('visible');
    }
  }

  async loadCustomFont(data) {
    if (data.username_font === 'custom' && data.custom_font_url) {
      const font = new FontFace('CustomProfileFont',
        `url(${data.custom_font_url})`);
      await font.load();
      document.fonts.add(font);
    }
  }

  incrementViews(id) {
    sb.rpc('increment_views', { row_id: id });
  }

  escapeHtml(str) {
    return str.replace(/[&<>"']/g, m =>
      ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])
    );
  }

  renderError(msg) {
    this.dom.card.innerHTML =
      `<div style="padding:40px;text-align:center">${msg}</div>`;
  }
}

document.addEventListener('DOMContentLoaded', () => new ProfileViewer());
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loading Profile...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Icons (Phosphor Icons) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root {
      --bg-color: #09090b;
      --card-bg: rgba(24, 24, 27, 0.6);
      --border-color: rgba(255, 255, 255, 0.1);
      --accent: #5865F2; /* Discord Blurple */
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: var(--bg-color);
      /* Subtle animated background */
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      color: var(--text-main);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Main Card */
    .profile-card {
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      margin: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* Banner Area */
    .banner-container {
      height: 160px;
      width: 100%;
      background-color: #27272a;
      position: relative;
    }

    .banner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Profile Header Info */
    .profile-header {
      padding: 0 24px;
      position: relative;
      margin-bottom: 16px;
    }

    .avatar-wrapper {
      margin-top: -50px; /* Pull avatar up into banner */
      display: inline-block;
      position: relative;
    }

    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #18181b; /* Matches card bg to create cutout effect */
      background: #27272a;
    }

    .username-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .username {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(88, 101, 242, 0.15);
      border: 1px solid rgba(88, 101, 242, 0.3);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      margin-top: 8px;
    }
    
    .badge i { font-size: 14px; }

    /* Bio Section */
    .content {
      padding: 0 24px 32px 24px;
    }

    .bio {
      margin-top: 12px;
      color: var(--text-muted);
      line-height: 1.6;
      font-size: 15px;
      white-space: pre-wrap; /* Preserves line breaks */
    }

    /* States */
    .error-state {
      text-align: center;
      padding: 40px;
      color: #ef4444;
    }

    /* Skeleton Loading Animation */
    .skeleton {
      background: linear-gradient(90deg, #27272a 25%, #3f3f46 50%, #27272a 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    .sk-banner { height: 160px; width: 100%; }
    .sk-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #18181b; margin-top: -50px; }
    .sk-text { height: 20px; margin-bottom: 8px; }
    .w-50 { width: 50%; }
    .w-80 { width: 80%; }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .role-container {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.role-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85rem; /* 13.5-14px */
  font-weight: 400; /* normal, not bold */
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; /* clean & luxury */
  text-transform: none;
  color: white;
-webkit-font-smoothing: antialiased; /* for Chrome, Safari */
-moz-osx-font-smoothing: grayscale;  /* for Firefox */

  /* Glass/frosted effect */
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  /* iOS-like stroke */
  border: 1px solid rgba(255, 255, 255, 0.2);

  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.role-badge img {
  width: 14px;
  height: 14px;
  object-fit: contain;
  border-radius: 50%;
}

/* Remove colored backgrounds for individual roles */
.role-founder,
.role-admin,
.role-mod,
.role-verified {
  background: inherit; /* inherit glass background from .role-badge */
  color: inherit; /* keep white text */
}

.role-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
}


  </style>
</head>
<body>

<div id="app" class="profile-card">
  <!-- Initial Skeleton Loader -->
  <div class="banner-container sk-banner skeleton"></div>
  <div class="profile-header">
    <div class="sk-avatar skeleton"></div>
    <div class="sk-text w-50 skeleton" style="margin-top: 15px;"></div>
    <div class="sk-text w-80 skeleton"></div>
    <div id="roleContainer" class="role-container"></div>
  </div>
</div>

<script>
  // -- CONFIG --
  const SUPABASE_URL = "https://tstsijdifhgmpaszqknr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4";
  
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // -- UTILS --
  
  // Prevent XSS attacks from user Bio
  function escapeHtml(unsafe) {
    if (!unsafe) return "";
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Parse Username
  const path = window.location.pathname;
  const username = decodeURIComponent(
    path.startsWith("/@") ? path.slice(2).replace(/\//g, "") : ""
  );

  // -- MAIN LOGIC --

  async function loadProfile() {
    console.log("Fetching profile for:", username);

    if (!username) {
      renderError("No username provided in URL.");
      return;
    }

    const { data, error } = await supabaseClient
      .from("profiles")
      .select("*")
      .eq("username", username)
      .eq("public", true) // Assuming you have a boolean for public/private
      .single();

    if (error || !data) {
      console.error(error);
      renderError("Profile not found or is private.");
      return;
    }

    renderProfile(data);
  }

  function renderProfile(user) {
  document.title = `${user.username} (@${user.username}) | Profile`;

  // Fallback assets
  const avatar = user.avatar_url || "https://cdn.discordapp.com/embed/avatars/0.png";
  const bannerHTML = user.banner_url 
    ? `<img class="banner" src="${escapeHtml(user.banner_url)}" alt="Banner">`
    : `<div class="banner" style="background: linear-gradient(45deg, #4f46e5, #9333ea);"></div>`;

  // Sanitize bio to prevent XSS
  const safeBio = escapeHtml(user.bio);

  // Render main profile card
  document.getElementById("app").innerHTML = `
    <div class="banner-container">
      ${bannerHTML}
    </div>

    <div class="profile-header">
      <div class="avatar-wrapper">
        <img class="avatar" src="${escapeHtml(avatar)}" alt="${escapeHtml(user.username)}" />
      </div>

      <div class="username-row">
        <div class="username">@${escapeHtml(user.username)}</div>
      </div>

      <!-- Verified Badge -->
      <div class="badge">
        <i class="ph-fill ph-seal-check"></i>
        <span>Verified via Discord</span>
      </div>

      <!-- Role Container -->
      <div id="roleContainer" class="role-container"></div>
    </div>

    <div class="content">
      ${safeBio ? `<div class="bio">${safeBio}</div>` : `<div class="bio" style="font-style:italic; opacity:0.5">No bio available.</div>`}
    </div>
  `;

  // Render roles dynamically
  const roleContainer = document.getElementById("roleContainer");
  roleContainer.innerHTML = ''; // clear previous

  // Example: user.roles should be an array like ['Admin', 'Verified', 'Founder']
  if (user.roles && user.roles.length > 0) {
    user.roles.forEach(roleName => {
      const span = document.createElement("span");
      span.className = `role-badge role-${roleName.toLowerCase()}`;

      // Add role icon from /assets/
      const img = document.createElement("img");
      // Make icon name lowercase and replace spaces with underscores if needed
      img.src = `/assets/${roleName.toLowerCase()}.png`;
      img.alt = roleName;
      span.appendChild(img);

      // Add role text
      const text = document.createTextNode(roleName);
      span.appendChild(text);

      roleContainer.appendChild(span);
    });
  }
}


  function renderError(msg) {
    document.title = "Profile Not Found";
    document.getElementById("app").innerHTML = `
      <div class="error-state">
        <i class="ph ph-warning-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
        <h3>Ooops!</h3>
        <p>${msg}</p>
        <p style="font-size: 12px; margin-top: 20px; color: #666;">If you believe this is an error, please contact support.</p>
      </div>
    `;
  }

  // Start
  loadProfile();
</script>

</body>
</html>

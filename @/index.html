<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile | /six</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Cinzel:wght@700&family=Orbitron:wght@700&family=Playfair+Display:wght@700&family=UnifrakturMaguntia&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
/* ======================= VARIABLES ======================= */
:root {
  --c-bg: #030005;
  --c-bg-alt: #0a0510;
  
  /* Defaults (Updated via JS) */
  --c-accent: #7b2cbf;
  --c-accent-glow: rgba(123, 44, 191, 0.4);
  
  --c-text-main: #e8e6f3;
  --c-text-dim: #8f8ba0;
  
  --c-glass: rgba(10, 5, 20, 0.7);
  --c-glass-border: rgba(255, 255, 255, 0.08);
  
  --font-main: 'Inter', sans-serif;
  --font-brand: 'Diecide Remain', serif;
  --font-display: 'Cinzel', serif; /* Updated via JS */
  
  --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
}

@font-face {
  font-family: 'Diecide Remain';
  src: url('fonts/DeicideRemain.otf') format('opentype');
  font-display: swap;
}
  
* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  font-family: var(--font-main);
  background: var(--c-bg);
  color: var(--c-text-main);
  min-height: 100vh;

  display: flex;
  justify-content: center;   /* horizontal */
  align-items: center;       /* vertical */

  overflow-x: hidden;
  line-height: 1.6;
}
/* Background Texture */
body::after {
  content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 900;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhZWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
  opacity: 0.05;
}

/* ======================= LAYOUT ======================= */
.app-container {
  position: relative;
  z-index: 10;

  max-width: 650px;
  width: 100%;

  padding: 20px;
  
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.8s var(--ease-out) forwards;
}

@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

.header-brand {
  position: absolute;
  top: 30px;
  left: 30px;

  font-family: var(--font-brand), 'Cinzel', serif;
  font-size: 2.5rem;      /* ‚Üê make it header-sized */
  line-height: 1.1;

  background: linear-gradient(135deg, #e0aaff, #9d4edd, #7b2cbf);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;

  text-shadow: 0 0 25px rgba(157, 78, 221, 0.5);
  font-weight: 900;
  letter-spacing: 1px;

  text-decoration: none;
}



/* ======================= PROFILE CARD ======================= */
.profile-card {
  background: var(--c-glass);
  border: 1px solid var(--c-glass-border);
  border-radius: 24px;
  overflow: hidden;
  position: relative;
  backdrop-filter: blur(20px);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

/* Theme Hover Effect */
.profile-card:hover { 
  border-color: var(--c-accent); 
  box-shadow: 0 0 40px var(--c-accent-glow);
}

/* Banner Fade Effect */
.profile-banner {
  width: 100%; height: 250px;
  position: relative;
  background-color: #1a1a1a;
  /* This creates the seamless fade into the card body */
  mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
  -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
}
.profile-banner img, .profile-banner video {
  width: 100%; height: 100%; object-fit: cover;
  transition: transform 0.6s ease;
}
.profile-card:hover .profile-banner img { transform: scale(1.03); }

/* Content Area */
.profile-content {
  padding: 0 35px 40px;
  position: relative;
  margin-top: -70px; /* Pulls content up into the faded banner */
  z-index: 2;
}

/* Avatar */
.avatar-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
.avatar-wrapper {
  padding: 5px;
  background: var(--c-glass); /* Glass border around avatar */
  backdrop-filter: blur(10px);
  border-radius: 28px;
  border: 1px solid var(--c-glass-border);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.profile-avatar {
  width: 110px; height: 110px;
  border-radius: 24px; object-fit: cover; display: block;
}

/* Action Buttons */
.action-btn {
  padding: 8px 18px; border-radius: 10px;
  font-size: 13px; font-weight: 600; text-decoration: none;
  display: flex; align-items: center; gap: 8px;
  transition: 0.2s; cursor: pointer;
}
.action-btn.secondary {
  background: rgba(255,255,255,0.03); border: 1px solid var(--c-glass-border); color: #ccc;
}
.action-btn.secondary:hover { background: rgba(255,255,255,0.08); color: #fff; border-color: #fff; }

.action-btn.primary {
  background: var(--c-accent); color: #fff; border: none;
  box-shadow: 0 4px 15px var(--c-accent-glow);
}
.action-btn.primary:hover { transform: translateY(-2px); filter: brightness(1.2); }

/* Identity */
.username { 
  font-family: var(--font-display); 
  font-size: 38px; color: #fff; line-height: 1.1; margin-right: 8px;
  text-shadow: 0 0 25px var(--c-accent-glow);
}
.badge-verified {
  color: var(--c-accent); font-size: 22px;
  filter: drop-shadow(0 0 8px var(--c-accent-glow));
}

.bio-text {
  color: var(--c-text-dim); font-size: 15px; margin-top: 15px;
  white-space: pre-wrap;
}

/* Roles */
.roles-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; }
.role-chip {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
  padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; color: #aaa;
  display: flex; align-items: center; gap: 6px; transition: 0.2s;
}
.role-chip:hover { 
  border-color: var(--c-accent); color: #fff; 
  box-shadow: 0 0 10px var(--c-accent-glow); 
}

/* Stats Footer */
.stats-bar {
  display: flex; gap: 20px; margin-top: 25px; padding-top: 20px;
  border-top: 1px solid rgba(255,255,255,0.05);
}
.stat-item {
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--c-text-dim); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
}
.stat-item i { font-size: 16px; color: var(--c-accent); }

/* Backgrounds */
.bg-fixed { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
.bg-media { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; }
.bg-blob { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.3; }
.bg-blob.one { top:-20%; left:-10%; width:70vw; height:70vw; background: radial-gradient(var(--c-accent), transparent 70%); }

/* Loading */
.skeleton { background: rgba(255,255,255,0.03); border-radius: 8px; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
</style>
</head>
<body>

  <div class="bg-fixed" id="profile-bg">
    <div class="bg-blob one"></div>
  </div>

  <a href="/" class="header-brand">/six</a>

  <main class="app-container">
    <div id="profile-target">
      <!-- Loading State -->
      <div class="profile-card">
        <div class="profile-banner skeleton"></div>
        <div class="profile-content">
          <div class="avatar-row">
            <div class="avatar-wrapper"><div class="profile-avatar skeleton"></div></div>
          </div>
          <div class="skeleton" style="height:40px; width:50%; margin-bottom:15px"></div>
          <div class="skeleton" style="height:15px; width:80%"></div>
        </div>
      </div>
    </div>
  </main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const CONFIG = {
    supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co",
    supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
    fonts: {
      'Diecide Remain': "'Diecide Remain', 'Cinzel', serif",
      'Cinzel': "'Cinzel', serif",
      'Orbitron': "'Orbitron', sans-serif",
      'UnifrakturMaguntia': "'UnifrakturMaguntia', cursive",
      'Playfair Display': "'Playfair Display', serif",
      'Roboto Mono': "'Roboto Mono', monospace"
    }
  };

  const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

  const app = {
    init: () => {
      app.loadProfile();
    },

    escapeHtml: (str) => {
      if(!str) return "";
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    },

    loadProfile: async () => {
      const path = window.location.pathname;
      const username = decodeURIComponent(path.startsWith("/@") ? path.slice(2).replace(/\//g, "") : "");
      
      if (!username) return app.renderError("User identity not found.");

      const { data: profile, error } = await sb
        .from("profiles")
        .select("*")
        .eq("username", username)
        .single();

      if (error || !profile) return app.renderError("Profile restricted or non-existent.");

      // Increment Views (Optimistic UI - don't wait for result)
      sb.rpc('increment_views', { row_id: profile.id });

      app.renderProfile(profile);
      app.checkAuth(profile);
    },

    renderProfile: (user) => {
      // 1. Theme Engine Application
      const themeColor = user.theme_color || '#7b2cbf';
      document.documentElement.style.setProperty('--c-accent', themeColor);
      document.documentElement.style.setProperty('--c-accent-glow', themeColor + '66');
      
      // 2. Font Application
      const userFont = CONFIG.fonts[user.username_font] || CONFIG.fonts['Cinzel'];
      document.documentElement.style.setProperty('--font-display', userFont);

        if (user.username_font === 'custom' && user.custom_font_url) {
  const font = new FontFace(
    'UserCustomFont',
    `url(${user.custom_font_url})`
  );

  font.load().then(() => {
    document.fonts.add(font);
    document.documentElement.style.setProperty(
      '--font-display',
      "'UserCustomFont', serif"
    );
  });
}

      // 3. Background Setup
      const bgEl = document.getElementById('profile-bg');
      if(user.bg_type === 'image' && user.bg_value) bgEl.innerHTML = `<img src="${user.bg_value}" class="bg-media">`;
      else if(user.bg_type === 'video' && user.bg_value) bgEl.innerHTML = `<video src="${user.bg_value}" autoplay muted loop playsinline class="bg-media"></video>`;
      else bgEl.innerHTML = `<div class="bg-blob one"></div>`; // Fallback blob

      // 4. HTML Generation
      const avatar = user.avatar || "https://cdn.discordapp.com/embed/avatars/0.png";
      const banner = user.banner_url 
        ? (user.banner_url.match(/\.(mp4|webm)$/) 
            ? `<video src="${user.banner_url}" autoplay loop muted playsinline></video>` 
            : `<img src="${user.banner_url}">`)
        : `<div style="width:100%;height:100%;background:${themeColor}"></div>`;

      const isVerified = user.roles && user.roles.includes("Verified");
      
      let rolesHTML = (user.roles || []).map(r => `
        <div class="role-chip"><i class="ph-fill ph-seal-check"></i> ${app.escapeHtml(r)}</div>
      `).join('');

      const html = `
        <div class="profile-card">
          <div class="profile-banner">
            ${banner}
          </div>
          
          <div class="profile-content">
            <div class="avatar-row">
              <div class="avatar-wrapper">
                <img class="profile-avatar" src="${app.escapeHtml(avatar)}">
              </div>
              <div id="action-buttons" style="display:flex; gap:10px;">
                <button class="action-btn secondary" onclick="app.copyLink()"><i class="ph-bold ph-share-network"></i> Share</button>
              </div>
            </div>

            <div class="user-identity">
              <div style="display:flex; align-items:center;">
                <h1 class="username">${app.escapeHtml(user.username)}</h1>
                ${isVerified ? `<i class="ph-fill ph-seal-check badge-verified"></i>` : ''}
              </div>
              <div style="color:var(--c-accent); font-size:11px; font-weight:800; letter-spacing:2px; text-transform:uppercase; margin-top:5px;">
                ${app.escapeHtml(user.role || 'Member')}
              </div>
            </div>

            <div class="bio-text">${app.escapeHtml(user.bio || "No bio provided.")}</div>

            <div class="roles-grid">${rolesHTML}</div>

            <div class="stats-bar">
               <div class="stat-item">
                 <i class="ph-bold ph-eye"></i>
                 <span>${(user.views || 0).toLocaleString()} Views</span>
               </div>
               <div class="stat-item">
                 <i class="ph-bold ph-calendar-blank"></i>
                 <span>Joined ${new Date(user.created_at || Date.now()).getFullYear()}</span>
               </div>
            </div>

          </div>
        </div>
      `;

      document.getElementById('profile-target').innerHTML = html;
      document.title = `${user.username} | /six`;
    },

    checkAuth: async (profile) => {
      const { data: { session } } = await sb.auth.getSession();
      if (session && session.user && session.user.id === profile.id) {
        const btn = document.createElement('a');
        btn.href = `/@${encodeURIComponent(profile.username)}/edit`;
        btn.className = 'action-btn primary';
        btn.innerHTML = `<i class="ph-bold ph-pencil-simple"></i> Edit Profile`;
        document.getElementById('action-buttons').prepend(btn);
      }
    },

    copyLink: () => {
      navigator.clipboard.writeText(window.location.href);
      const btn = document.querySelector('.ph-share-network').parentElement;
      const old = btn.innerHTML;
      btn.innerHTML = `<i class="ph-bold ph-check"></i> Copied`;
      setTimeout(() => btn.innerHTML = old, 2000);
    },

    renderError: (msg) => {
      document.getElementById('profile-target').innerHTML = `<div style="text-align:center; padding:50px; color:#ff5555">${msg}</div>`;
    }
  };

  window.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>

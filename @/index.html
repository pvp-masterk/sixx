<!-- START OF FILE view.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile | /six</title>

<!-- PRELOAD CRITICAL ASSETS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Cinzel:wght@700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
/* --- SHARED THEME ENGINE --- */
:root {
  --bg: #050505;
  --accent: #7b2cbf; /* Dynamic */
  --accent-glow: rgba(123, 44, 191, 0.4);
  --text-main: #ffffff;
  --text-dim: #a1a1aa;
  
  --card-bg: rgba(10, 10, 12, 0.6);
  --card-border: rgba(255, 255, 255, 0.06);
  --glass-blur: blur(20px);
  
  --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text-main);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  display: grid; place-items: center;
  overflow-x: hidden;
}

/* Background Layer */
.scene-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
.noise-overlay {
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhZWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
  opacity: 0.05;
}
.blob {
  position: absolute; width: 60vw; height: 60vw;
  background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
  opacity: 0.15; filter: blur(80px);
  top: -20%; left: -10%;
  animation: float 20s infinite alternate ease-in-out;
}
@keyframes float { to { transform: translate(50px, 30px); } }

.bg-media { width: 100%; height: 100%; object-fit: cover; opacity: 0.3; }

/* --- PROFILE CARD --- */
.profile-card {
  width: 90%; max-width: 550px;
  background: var(--card-bg);
  backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--card-border);
  border-radius: 24px;
  overflow: hidden;
  position: relative;
  transform: translateY(20px); opacity: 0;
  animation: entrance 0.8s var(--ease-elastic) forwards;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
}

@keyframes entrance { to { transform: translateY(0); opacity: 1; } }

/* Visuals */
.banner {
  height: 220px; background: #111; position: relative;
  mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
  -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
}
.banner img, .banner video { width: 100%; height: 100%; object-fit: cover; }

.content { padding: 0 30px 40px; position: relative; margin-top: -60px; }

/* Avatar Row */
.header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }

.avatar-container {
  padding: 4px; background: rgba(20,20,20,0.8);
  border: 1px solid var(--card-border);
  border-radius: 24px; backdrop-filter: blur(10px);
}
.avatar { width: 100px; height: 100px; border-radius: 20px; object-fit: cover; display: block; background: #000; }

.action-btn {
  padding: 8px 16px; border-radius: 12px;
  background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
  color: #fff; text-decoration: none; font-size: 13px; font-weight: 600;
  transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { background: var(--accent); border-color: var(--accent); }

/* Identity */
.username-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 8px; }

/* --- EFFECTS ENGINE --- */
/* The Signature Effect: Ethereal */
.fx-ethereal {
  font-family: 'Cinzel', serif;
  font-size: 36px; font-weight: 700;
  background: linear-gradient(135deg, #fff 40%, var(--accent) 50%, #fff 60%);
  background-size: 200% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shimmer 4s infinite linear;
  letter-spacing: -0.5px;
}
@keyframes shimmer { to { background-position: 200% center; } }

.fx-glitch { 
  font-family: 'Space Grotesk', sans-serif; font-size: 32px;
  text-shadow: 2px 0 var(--accent), -2px 0 #00ffff; 
}
.fx-glow { 
  font-family: 'Inter', sans-serif; font-size: 32px; font-weight: 800;
  text-shadow: 0 0 20px var(--accent); 
}
.fx-none { font-size: 32px; font-weight: 700; }

/* Role Badge */
.role-badge {
  display: flex; align-items: center; height: 28px; padding: 0 10px;
  background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
  border-radius: 8px; font-size: 11px; font-weight: 600; color: var(--text-dim);
  gap: 6px;
}
.role-badge img { width: 14px; height: 14px; }

/* Bio & Stats */
.bio { color: var(--text-dim); line-height: 1.6; font-size: 14px; white-space: pre-wrap; margin-bottom: 24px; }

.stats {
  display: flex; gap: 20px; padding-top: 20px;
  border-top: 1px solid var(--card-border);
}
.stat { font-size: 12px; color: var(--text-dim); font-weight: 500; display: flex; align-items: center; gap: 6px; }
.stat i { color: var(--accent); font-size: 16px; }

/* Loading State */
.loading-skel { animation: pulse 1.5s infinite; background: rgba(255,255,255,0.05); border-radius: 8px; }
@keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

</style>
</head>
<body>

<div class="scene-layer noise-overlay"></div>
<div class="scene-layer" id="scene-bg"><div class="blob"></div></div>

<main id="app">
  <!-- SKELETON LOADER -->
  <div class="profile-card">
    <div class="banner loading-skel"></div>
    <div class="content">
      <div class="header-row">
        <div class="avatar-container"><div class="avatar loading-skel"></div></div>
      </div>
      <div class="loading-skel" style="height:40px; width:50%; margin-bottom:15px"></div>
      <div class="loading-skel" style="height:15px; width:80%; margin-bottom:10px"></div>
      <div class="loading-skel" style="height:15px; width:60%"></div>
    </div>
  </div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co",
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  roles: {
    Founder: { icon: "https://img.icons8.com/ios-filled/50/ffffff/crown.png" },
    Verified: { icon: "https://img.icons8.com/ios-filled/50/ffffff/verified-badge.png" }
  }
};

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

const app = {
  escape: (str) => str ? str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])) : "",

  async init() {
    const path = window.location.pathname;
    const username = decodeURIComponent(path.startsWith("/@") ? path.slice(2) : ""); // Extract after /@
    
    if(!username) return document.body.innerHTML = "<h2 style='text-align:center'>User Not Found</h2>";

    const { data: profile } = await sb.from("profiles").select("*").eq("username", username).maybeSingle();
    
    if(!profile) return document.body.innerHTML = "<h2 style='text-align:center'>404 Profile</h2>";
    
    // Increment View (Fire & Forget)
    sb.rpc('increment_views', { row_id: profile.id });
    
    // Load Custom Font if exists
    if(profile.username_font === 'custom' && profile.custom_font_url) {
        const font = new FontFace('CustomFont', `url(${profile.custom_font_url})`);
        await font.load();
        document.fonts.add(font);
    }

    this.render(profile);
    this.checkOwner(profile.id, profile.username);
  },

  render(user) {
    // 1. Apply Theme Variables
    const root = document.documentElement;
    const color = user.theme_color || '#7b2cbf';
    root.style.setProperty('--accent', color);
    
    // 2. Background Logic
    const bgEl = document.getElementById('scene-bg');
    if(user.bg_type === 'video' && user.bg_value) {
      bgEl.innerHTML = `<video src="${user.bg_value}" autoplay muted loop class="bg-media"></video>`;
    } else if (user.bg_type === 'image' && user.bg_value) {
      bgEl.innerHTML = `<img src="${user.bg_value}" class="bg-media">`;
    } else {
      bgEl.innerHTML = `<div class="blob"></div>`; // Default Blob
    }

    // 3. Media Logic
    const avatar = user.avatar || "https://cdn.discordapp.com/embed/avatars/0.png";
    const banner = user.banner_url 
      ? (user.banner_url.match(/\.(mp4|webm)$/) 
          ? `<video src="${user.banner_url}" autoplay muted loop playsinline></video>` 
          : `<img src="${user.banner_url}">`) 
      : `<div style="width:100%;height:100%;background:#111"></div>`;

    // 4. Role Logic
    let roleHtml = '';
    if(user.show_role_icon !== false && user.roles && user.roles.length > 0) {
      // Simple logic: take first role or specific priority
      const roleName = user.roles[0]; 
      const roleData = CONFIG.roles[roleName] || { icon: null };
      if(roleData.icon) {
         roleHtml = `<div class="role-badge"><img src="${roleData.icon}"> ${roleName}</div>`;
      }
    }

    // 5. Build HTML
    const html = `
      <div class="profile-card">
        <div class="banner">${banner}</div>
        <div class="content">
          <div class="header-row">
            <div class="avatar-container">
              <img src="${avatar}" class="avatar">
            </div>
            <div id="owner-actions"></div>
          </div>

          <div class="username-row">
            <h1 class="fx-${user.username_effect || 'none'}" 
                style="${user.username_font === 'custom' ? 'font-family:CustomFont, sans-serif' : ''}">
              ${this.escape(user.username)}
            </h1>
            ${roleHtml}
          </div>

          <div class="bio">${this.escape(user.bio || "No biography set.")}</div>

          <div class="stats">
            <div class="stat"><i class="ph-bold ph-eye"></i> ${user.views || 0} Views</div>
            <div class="stat"><i class="ph-bold ph-calendar"></i> ${new Date(user.created_at).getFullYear()}</div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('app').innerHTML = html;
    document.title = `${user.username} | /six`;
  },

  async checkOwner(profileId, username) {
    const { data: { session } } = await sb.auth.getSession();
    if(session && session.user.id === profileId) {
      const btn = `<a href="/@${username}/edit" class="action-btn"><i class="ph-bold ph-pencil-simple"></i> Edit Profile</a>`;
      document.getElementById('owner-actions').innerHTML = btn;
    }
  }
};

window.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>

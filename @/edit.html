<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Edit Profile | /six</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<!-- LIBS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Cinzel:wght@500;700&family=Outfit:wght@500;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
/* --- VARIABLES & RESET --- */
:root {
  --bg-core: #030303;
  --bg-panel: #0a0a0a;
  --bg-card: #111111;
  --bg-input: #161616;
  
  --border-subtle: rgba(255,255,255,0.06);
  --border-active: rgba(255,255,255,0.15);
  
  --accent: #7b2cbf;
  --accent-glow: rgba(123, 44, 191, 0.25);
  --text-primary: #ffffff;
  --text-secondary: #888888;
  --text-tertiary: #555555;
  
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 20px;
  
  --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
  --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg-core);
  color: var(--text-primary);
  font-family: 'Inter', sans-serif;
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* Scrollbar Polish */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #444; }

/* --- APP SHELL --- */
.app-shell {
  display: flex;
  width: 100%;
  max-width: 1600px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* --- SIDEBAR --- */
.sidebar {
  width: 260px;
  background: var(--bg-panel);
  border-right: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  padding: 24px;
  gap: 32px;
  z-index: 10;
}

.brand {
  font-family: 'Cinzel', serif;
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: #fff;
  padding-left: 8px;
}

.nav-menu { display: flex; flex-direction: column; gap: 4px; }

.nav-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 14px; font-weight: 500;
  transition: all 0.2s var(--ease-smooth);
  border: 1px solid transparent;
}
.nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
.nav-item.active {
  background: rgba(255,255,255,0.05);
  color: #fff;
  border-color: var(--border-subtle);
}
.nav-item i { font-size: 18px; }

.action-area { margin-top: auto; }

.btn-primary {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-md);
  border: none;
  background: var(--text-primary);
  color: #000;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: transform 0.1s;
}
.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }

/* --- MAIN EDITOR --- */
.main-area {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 420px; /* Editor | Preview */
  height: 100%;
}

.editor-scroll {
  padding: 40px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 40px;
}

.panel-header { margin-bottom: 20px; animation: fadeIn 0.4s var(--ease-smooth); }
.panel-header h2 { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; margin-bottom: 6px; }
.panel-header p { color: var(--text-secondary); font-size: 14px; }

/* Form Components */
.section { display: flex; flex-direction: column; gap: 24px; animation: slideUp 0.3s var(--ease-smooth); }
.section.hidden { display: none; }

.card {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 24px;
}

.input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
.input-group:last-child { margin-bottom: 0; }
.label { font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; }

input[type="text"], textarea {
  background: var(--bg-input);
  border: 1px solid var(--border-subtle);
  color: #fff;
  padding: 14px 16px;
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 14px;
  transition: 0.2s; width: 100%;
  resize: none;
}
input[type="text"]:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

/* File Upload Enhanced */
.file-drop {
  position: relative;
  background: var(--bg-input);
  border: 1px dashed var(--border-subtle);
  border-radius: var(--radius-md);
  height: 160px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 12px;
  cursor: pointer; overflow: hidden;
  transition: 0.2s;
}
.file-drop:hover { border-color: var(--text-secondary); background: rgba(255,255,255,0.03); }
.file-drop.drag-over { border-color: var(--accent); background: var(--accent-glow); }
.file-drop img, .file-drop video {
  position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
  opacity: 0.5; z-index: 0; transition: 0.3s;
}
.file-drop:hover img { opacity: 0.3; transform: scale(1.05); }
.drop-content { z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
.drop-tag { font-size: 12px; color: var(--text-secondary); background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; backdrop-filter: blur(4px); }

/* Color Picker Custom */
.color-picker-wrapper {
  display: flex; align-items: center; gap: 16px;
  padding: 8px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
  background: var(--bg-input); width: fit-content;
}
.color-swatch {
  width: 32px; height: 32px; border-radius: 6px;
  border: none; padding: 0; cursor: pointer;
}
.hex-display { font-family: 'Space Grotesk', monospace; font-size: 14px; color: var(--text-secondary); }

/* Effects Grid */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.fx-card {
  padding: 16px;
  background: var(--bg-input);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  cursor: pointer;
  display: flex; align-items: center; gap: 12px;
  transition: 0.2s;
}
.fx-card:hover { border-color: var(--text-secondary); }
.fx-card.active {
  background: rgba(123, 44, 191, 0.1);
  border-color: var(--accent);
}
.fx-icon { width: 32px; height: 32px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

/* --- PREVIEW PANE (Sticky) --- */
.preview-pane {
  border-left: 1px solid var(--border-subtle);
  background: var(--bg-core);
  padding: 40px;
  display: flex; flex-direction: column; align-items: center;
}

.preview-container {
  position: sticky; top: 40px;
  width: 100%;
}

.preview-label {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 16px;
}
.badge-live {
  background: rgba(0, 255, 136, 0.1); color: #00ff88;
  font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 100px;
  text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid rgba(0,255,136,0.2);
}

.mockup {
  width: 100%; aspect-ratio: 9/15;
  border-radius: 24px;
  border: 1px solid var(--border-subtle);
  overflow: hidden;
  position: relative;
  background: #000;
  box-shadow: 0 40px 80px -20px rgba(0,0,0,0.8);
  transition: border-color 0.3s;
}

.m-banner { height: 35%; background: #222; position: relative; overflow: hidden; }
.m-banner img, .m-banner video { width: 100%; height: 100%; object-fit: cover; }

.m-avatar-container {
  position: absolute; top: 35%; left: 24px; transform: translateY(-50%);
  width: 96px; height: 96px; border-radius: 50%;
  padding: 4px; background: var(--bg-card); /* Cutout effect */
}
.m-avatar {
  width: 100%; height: 100%; border-radius: 50%;
  background: #1a1a1a; overflow: hidden;
}
.m-avatar img { width: 100%; height: 100%; object-fit: cover; }

.m-content {
  margin-top: 50px; padding: 0 24px;
}

.m-username {
  font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 8px;
}
.m-bio {
  font-size: 13px; line-height: 1.6; color: var(--text-secondary);
  white-space: pre-wrap; font-weight: 400;
}

/* --- TOAST --- */
.toast-container {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
  z-index: 100; display: flex; flex-direction: column; gap: 10px;
}
.toast {
  background: #1a1a1a; border: 1px solid var(--border-subtle);
  color: #fff; padding: 12px 20px; border-radius: 50px;
  font-size: 13px; font-weight: 500;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
  animation: slideUpFade 0.3s var(--ease-spring);
}
.toast.success i { color: #00ff88; }
.toast.error i { color: #ff4444; }

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* Effect Classes */
.fx-ethereal {
  font-family: 'Cinzel', serif;
  background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, #fff 100%);
  background-size: 200% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shine 5s linear infinite;
}
.fx-glitch { font-family: 'Space Grotesk', sans-serif; text-shadow: 2px 0 var(--accent), -2px 0 #fff; letter-spacing: -1px; }
.fx-neon { text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent); }
.fx-none { color: #fff; }

@keyframes shine { to { background-position: 200% center; } }

/* Responsive */
@media (max-width: 1000px) {
  .sidebar { width: 80px; padding: 20px 10px; align-items: center; }
  .brand, .nav-item span, .btn-primary span { display: none; }
  .nav-item { justify-content: center; padding: 16px; }
  .btn-primary { width: 48px; height: 48px; padding: 0; border-radius: 50%; }
  .preview-pane { display: none; }
  .main-area { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
  .app-shell { flex-direction: column; height: 100vh; }
  .sidebar {
    width: 100%; height: auto; flex-direction: row; justify-content: space-between;
    padding: 10px 20px; border-right: none; border-bottom: 1px solid var(--border-subtle);
  }
  .nav-menu { flex-direction: row; }
  .btn-primary { display: none; } /* Add a mobile save header instead if needed */
  .editor-scroll { padding: 20px; }
}
</style>
</head>
<body>

<div class="toast-container" id="toast-area"></div>

<div class="app-shell">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">/six</div>
    
    <nav class="nav-menu">
      <div class="nav-item active" onclick="switchTab('identity', this)">
        <i class="ph ph-fingerprint"></i> <span>Identity</span>
      </div>
      <div class="nav-item" onclick="switchTab('visuals', this)">
        <i class="ph ph-image"></i> <span>Visuals</span>
      </div>
      <div class="nav-item" onclick="switchTab('style', this)">
        <i class="ph ph-palette"></i> <span>Aesthetics</span>
      </div>
    </nav>
    
    <div class="action-area">
      <button id="btn-save" class="btn-primary">
        <i class="ph-bold ph-floppy-disk"></i>
        <span>Save Changes</span>
      </button>
    </div>
  </aside>

  <main class="main-area">
    <!-- EDITOR COLUMN -->
    <div class="editor-scroll">
      
      <!-- 1. IDENTITY -->
      <section id="tab-identity" class="section">
        <div class="panel-header">
          <h2>Identity</h2>
          <p>Define how you appear to others.</p>
        </div>

        <div class="card">
          <div class="input-group">
            <span class="label">Biography</span>
            <textarea id="in-bio" rows="4" placeholder="Tell your story..."></textarea>
          </div>
        </div>
      </section>

      <!-- 2. VISUALS -->
      <section id="tab-visuals" class="section hidden">
        <div class="panel-header">
          <h2>Visuals</h2>
          <p>Upload your media assets.</p>
        </div>

        <div class="grid-2">
          <div class="card" style="padding:16px;">
            <div class="input-group">
              <span class="label">Avatar</span>
              <div class="file-drop" id="drop-avatar">
                <div class="drop-content">
                  <i class="ph ph-upload-simple" style="font-size:24px;"></i>
                  <span class="drop-tag">Max 5MB</span>
                </div>
                <input type="file" id="file-avatar" hidden accept="image/*">
                <img id="prev-avatar-img" style="opacity:0; z-index:-1">
              </div>
            </div>
          </div>

          <div class="card" style="padding:16px;">
            <div class="input-group">
              <span class="label">Banner</span>
              <div class="file-drop" id="drop-banner">
                <div class="drop-content">
                  <i class="ph ph-image" style="font-size:24px;"></i>
                  <span class="drop-tag">Img / Video</span>
                </div>
                <input type="file" id="file-banner" hidden accept="image/*,video/*">
                <img id="prev-banner-img" style="opacity:0; z-index:-1">
                <video id="prev-banner-vid" muted loop autoplay style="opacity:0; z-index:-1"></video>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3. STYLE -->
      <section id="tab-style" class="section hidden">
        <div class="panel-header">
          <h2>Aesthetics</h2>
          <p>Customize your theme and effects.</p>
        </div>

        <div class="card">
          <span class="label" style="display:block; margin-bottom:12px">Accent Color</span>
          <div class="color-picker-wrapper">
            <input type="color" id="in-color" class="color-swatch" value="#7b2cbf">
            <span id="hex-display" class="hex-display">#7B2CBF</span>
          </div>
        </div>

        <div class="card">
          <span class="label" style="display:block; margin-bottom:12px">Username Effect</span>
          <div class="grid-2" id="effect-grid">
            <!-- JS Populated -->
          </div>
        </div>
      </section>
    </div>

    <!-- PREVIEW COLUMN -->
    <aside class="preview-pane">
      <div class="preview-container">
        <div class="preview-label">
          <span class="label">Live Preview</span>
          <span class="badge-live">Live</span>
        </div>
        
        <div class="mockup" id="mockup-card">
          <div class="m-banner" id="m-banner-area"></div>
          <div class="m-avatar-container">
            <div class="m-avatar">
              <img id="m-avatar-img" src="https://cdn.discordapp.com/embed/avatars/0.png">
            </div>
          </div>
          <div class="m-content">
            <h1 id="m-username" class="m-username">Username</h1>
            <div id="m-bio" class="m-bio">...</div>
          </div>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
// --- CONFIGURATION ---
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co",
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  effects: [
    { id: 'ethereal', name: 'Ethereal', icon: 'ph-sparkle' },
    { id: 'glitch', name: 'Glitch', icon: 'ph-lightning' },
    { id: 'neon', name: 'Neon', icon: 'ph-lightbulb' },
    { id: 'none', name: 'Clean', icon: 'ph-circle' }
  ]
};

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
let userSession = null;
let staging = { avatar: null, banner: null, effect: 'none' };

// --- UTILITIES ---

// 1. Debounce (Prevent Lag)
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    const context = this;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

// 2. Toast Notification
function showToast(msg, type = 'success') {
  const area = document.getElementById('toast-area');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<i class="ph-bold ${type === 'success' ? 'ph-check-circle' : 'ph-warning-circle'}"></i> ${msg}`;
  area.appendChild(el);
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(10px)';
    setTimeout(() => el.remove(), 300);
  }, 3000);
}

// 3. Tab Switcher
window.switchTab = (id, btn) => {
  document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
  document.getElementById(`tab-${id}`).classList.remove('hidden');
  
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  btn.classList.add('active');
};

// --- CORE LOGIC ---

(async function init() {
  const { data: { user } } = await sb.auth.getUser();
  if(!user) return window.location.href = '/login'; 
  
  userSession = user;
  
  // Load Effects Grid
  const grid = document.getElementById('effect-grid');
  grid.innerHTML = CONFIG.effects.map(fx => `
    <div class="fx-card" onclick="applyEffect('${fx.id}')" id="fx-btn-${fx.id}">
      <div class="fx-icon"><i class="ph ${fx.icon}"></i></div>
      <span style="font-size:13px; font-weight:500;">${fx.name}</span>
    </div>
  `).join('');

  // Fetch Data
  const { data } = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
  if(data) loadProfile(data);
  else document.getElementById('m-username').innerText = user.email.split('@')[0];

  setupListeners();
})();

function loadProfile(data) {
  // Text
  document.getElementById('in-bio').value = data.bio || '';
  document.getElementById('m-bio').innerText = data.bio || '';
  document.getElementById('m-username').innerText = data.username || 'User';
  
  // Visuals
  if(data.avatar) {
    document.getElementById('m-avatar-img').src = data.avatar;
    document.getElementById('prev-avatar-img').src = data.avatar;
    document.getElementById('prev-avatar-img').style.opacity = '0.5';
  }
  if(data.banner_url) updateBannerPreview(data.banner_url, data.banner_url.match(/\.(mp4|webm)$/));

  // Style
  const color = data.theme_color || '#7b2cbf';
  updateColor(color);
  applyEffect(data.username_effect || 'none');
}

function updateColor(hex) {
  document.documentElement.style.setProperty('--accent', hex);
  document.documentElement.style.setProperty('--accent-glow', hex + '40'); // 25% opacity
  document.getElementById('in-color').value = hex;
  document.getElementById('hex-display').innerText = hex.toUpperCase();
  document.getElementById('mockup-card').style.borderColor = hex;
}

function applyEffect(id) {
  staging.effect = id;
  // UI Update
  document.querySelectorAll('.fx-card').forEach(c => c.classList.remove('active'));
  const btn = document.getElementById(`fx-btn-${id}`);
  if(btn) btn.classList.add('active');
  
  // Live Preview Update
  const nameEl = document.getElementById('m-username');
  nameEl.className = `m-username fx-${id}`;
}

function updateBannerPreview(url, isVideo) {
  const area = document.getElementById('m-banner-area');
  const dropImg = document.getElementById('prev-banner-img');
  const dropVid = document.getElementById('prev-banner-vid');

  // Update Mockup
  area.innerHTML = isVideo 
    ? `<video src="${url}" autoplay muted loop style="width:100%;height:100%;object-fit:cover"></video>`
    : `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;

  // Update Dropzone
  if(isVideo) {
    dropImg.style.opacity = 0;
    dropVid.src = url; dropVid.style.opacity = 0.5;
  } else {
    dropVid.style.opacity = 0; dropVid.pause();
    dropImg.src = url; dropImg.style.opacity = 0.5;
  }
}

// --- EVENT LISTENERS ---

function setupListeners() {
  // Bio (Debounced)
  document.getElementById('in-bio').addEventListener('input', debounce((e) => {
    document.getElementById('m-bio').innerText = e.target.value;
  }, 50));

  // Color
  document.getElementById('in-color').addEventListener('input', debounce((e) => {
    updateColor(e.target.value);
  }, 10)); // Color needs to be snappy but optimized

  // File Upload Logic
  setupUpload('drop-avatar', 'file-avatar', (file, url) => {
    staging.avatar = file;
    document.getElementById('m-avatar-img').src = url;
    const prev = document.getElementById('prev-avatar-img');
    prev.src = url; prev.style.opacity = 0.5;
  });

  setupUpload('drop-banner', 'file-banner', (file, url) => {
    staging.banner = file;
    updateBannerPreview(url, file.type.startsWith('video'));
  });

  // Save Button
  document.getElementById('btn-save').addEventListener('click', saveProfile);
}

function setupUpload(zoneId, inputId, cb) {
  const zone = document.getElementById(zoneId);
  const input = document.getElementById(inputId);

  zone.onclick = () => input.click();
  
  zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('drag-over'); };
  zone.ondragleave = () => zone.classList.remove('drag-over');
  
  const handleFile = (file) => {
    zone.classList.remove('drag-over');
    const url = URL.createObjectURL(file);
    cb(file, url);
  };

  zone.ondrop = (e) => { e.preventDefault(); if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };
  input.onchange = () => { if(input.files[0]) handleFile(input.files[0]); };
}

// --- SAVE LOGIC ---

async function saveProfile() {
  const btn = document.getElementById('btn-save');
  const originalText = btn.innerHTML;
  btn.disabled = true; 
  btn.innerHTML = `<i class="ph ph-spinner ph-spin"></i> <span>Saving...</span>`;

  try {
    const updates = {
      updated_at: new Date(),
      bio: document.getElementById('in-bio').value,
      theme_color: document.getElementById('in-color').value,
      username_effect: staging.effect
    };

    // Helper for Storage
    const upload = async (file, bucket) => {
      const ext = file.name.split('.').pop();
      const path = `${userSession.id}/${Date.now()}.${ext}`;
      const { error } = await sb.storage.from(bucket).upload(path, file);
      if(error) throw error;
      return sb.storage.from(bucket).getPublicUrl(path).data.publicUrl;
    };

    if(staging.avatar) updates.avatar = await upload(staging.avatar, 'avatars');
    if(staging.banner) updates.banner_url = await upload(staging.banner, 'banners');

    const { error } = await sb.from('profiles').upsert({ id: userSession.id, ...updates });
    if(error) throw error;

    showToast('Profile updated successfully');
    
  } catch (err) {
    console.error(err);
    showToast('Failed to save changes', 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}
</script>
</body>
</html>

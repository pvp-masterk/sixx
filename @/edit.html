<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>/six - Edit Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<!-- 1. EXTERNAL LIBRARIES -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">

<style>
/* ======================= 1. CORE VARIABLES & RESET ======================= */
:root {
  --c-bg: #030005;
  --c-bg-alt: #0a0510;
  --c-accent: #7b2cbf;
  --c-accent-hover: #9d4edd;
  --c-accent-glow: rgba(123, 44, 191, 0.5);
  
  --c-text-main: #e8e6f3;
  --c-text-dim: #8f8ba0;
  
  --c-glass: rgba(10, 5, 20, 0.75); /* Slightly darker for better contrast */
  --c-glass-border: rgba(255, 255, 255, 0.08);
  --c-glass-highlight: rgba(255, 255, 255, 0.03);
  
  --radius-lg: 24px;
  --radius-md: 12px;
  --radius-sm: 8px;
  
  --font-main: 'Inter', sans-serif;
  --font-brand: 'Cinzel', serif;
  
  --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  background-color: var(--c-bg);
  color: var(--c-text-main);
  font-family: var(--font-main);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  overflow-x: hidden;
}

/* Optimized Scanline Texture */
body::after {
  content: "";
  position: fixed; inset: 0; pointer-events: none; z-index: 999;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
  background-size: 100% 3px, 3px 100%;
  opacity: 0.6;
}

/* ======================= 2. BACKGROUND ANIMATION ======================= */
.bg-fixed { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }

.bg-blob {
  position: absolute; border-radius: 50%; 
  filter: blur(80px); opacity: 0.4;
  will-change: transform; /* Performance Boost */
  animation: float 20s infinite alternate ease-in-out;
}
.bg-blob.one { top: -10%; left: -10%; width: 50vw; height: 50vw; background: radial-gradient(circle, #4a0072 0%, transparent 70%); }
.bg-blob.two { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, #240046 0%, transparent 70%); animation-delay: -5s; }

@keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(20px, -20px) scale(1.1); } }

/* ======================= 3. MAIN CONTAINER ======================= */
.container {
  position: relative; z-index: 10;
  width: 100%; max-width: 520px;
  background: var(--c-glass);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--c-glass-border);
  border-radius: var(--radius-lg);
  box-shadow: 0 20px 50px rgba(0,0,0,0.6);
  overflow: hidden;
  transform: translateZ(0); /* GPU Promotion */
  opacity: 0; animation: fadeIn 0.8s var(--ease-spring) forwards;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* --- HEADER --- */
.header-area {
  padding: 25px 30px;
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}

h2 {
  font-family: var(--font-brand); font-size: 1.5rem; font-weight: 700;
  background: linear-gradient(135deg, #e0aaff 0%, #7b2cbf 100%);
  -webkit-background-clip: text; background-clip: text; color: transparent;
  letter-spacing: 1px;
}

/* --- PREVIEW SECTION --- */
.preview-area {
  position: relative; width: 100%; height: 180px;
  background: #05020a;
}

.banner-display {
  width: 100%; height: 100%; object-fit: cover;
  opacity: 0.8; transition: opacity 0.3s;
}

.avatar-wrapper {
  position: absolute; bottom: -40px; left: 30px;
  width: 90px; height: 90px;
  padding: 4px;
  background: var(--c-bg-alt);
  border: 1px solid var(--c-glass-border);
  border-radius: 20px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.5);
  z-index: 2;
}

.avatar-display {
  width: 100%; height: 100%;
  border-radius: 14px; object-fit: cover;
  background-color: #1a1a1a;
}

/* --- FORM SECTION --- */
.form-area { padding: 50px 30px 30px 30px; }

.input-group { margin-bottom: 20px; }
.input-group label {
  display: block; margin-bottom: 8px;
  font-size: 0.75rem; font-weight: 600;
  color: var(--c-text-dim); text-transform: uppercase; letter-spacing: 1.5px;
}

/* Inputs */
.input-wrapper { position: relative; }
input[type="text"], textarea {
  width: 100%; padding: 14px 16px;
  border-radius: var(--radius-md);
  border: 1px solid var(--c-glass-border);
  background: rgba(0, 0, 0, 0.4);
  color: var(--c-text-main);
  font-family: inherit; font-size: 0.9rem;
  transition: all 0.2s ease;
}

input:focus, textarea:focus {
  border-color: var(--c-accent);
  background: rgba(123, 44, 191, 0.05);
  box-shadow: 0 0 0 4px rgba(123, 44, 191, 0.1);
}

textarea { min-height: 90px; resize: none; line-height: 1.5; }

/* Roles Grid */
.roles-container {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px; margin-top: 5px;
}

.role-card {
  background: var(--c-glass-highlight);
  border: 1px solid transparent;
  border-radius: var(--radius-md);
  padding: 10px;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
  cursor: pointer; transition: all 0.2s ease;
}

.role-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }

.role-card.active {
  background: rgba(123, 44, 191, 0.2);
  border-color: var(--c-accent);
  box-shadow: 0 4px 12px rgba(123, 44, 191, 0.15);
}

.role-icon-img {
  width: 24px; height: 24px; object-fit: contain;
  opacity: 0.6; filter: grayscale(100%); transition: 0.3s;
}

.role-card.active .role-icon-img { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
.role-name { font-size: 0.75rem; color: var(--c-text-dim); font-weight: 500; }
.role-card.active .role-name { color: #fff; }

/* Button */
.action-btn {
  width: 100%; margin-top: 25px; padding: 15px;
  background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
  border: 1px solid var(--c-glass-border);
  color: #fff; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; font-size: 0.85rem;
  border-radius: var(--radius-md);
  cursor: pointer; transition: all 0.3s var(--ease-spring);
  position: relative; overflow: hidden;
  display: flex; justify-content: center; align-items: center; gap: 10px;
}

.action-btn:hover { 
  background: var(--c-accent); border-color: var(--c-accent);
  box-shadow: 0 0 25px var(--c-accent-glow);
  transform: translateY(-2px);
}
.action-btn:active { transform: scale(0.98); }
.action-btn:disabled { opacity: 0.6; cursor: wait; pointer-events: none; }

/* Loading Spinner */
.spinner {
  width: 18px; height: 18px;
  border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
  border-radius: 50%; animation: spin 0.8s linear infinite;
  display: none;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast {
  position: fixed; bottom: 30px; left: 50%;
  transform: translate(-50%, 50px); opacity: 0;
  background: #0f0518; border: 1px solid var(--c-glass-border);
  padding: 12px 24px; border-radius: 50px;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  transition: all 0.4s var(--ease-spring);
  z-index: 1000; pointer-events: none;
}
.toast.show { transform: translate(-50%, 0); opacity: 1; }
.toast span { font-size: 0.9rem; font-weight: 500; }
.toast.success { border-color: #4ade80; color: #4ade80; }
.toast.error { border-color: #ef4444; color: #ef4444; }

/* Helper classes */
.hidden { display: none !important; }

</style>
</head>
<body>

<!-- Background -->
<div class="bg-fixed">
  <div class="bg-blob one"></div>
  <div class="bg-blob two"></div>
</div>

<div class="container">
  

  <!-- Preview -->
  <div class="preview-area">
    <img id="prev-banner" class="banner-display" src="" alt="">
    <div class="avatar-wrapper">
      <img id="prev-avatar" class="avatar-display" src="" alt="">
    </div>
  </div>

  <!-- Form -->
  <div class="form-area">
    <form id="profileForm">
      
      <div class="input-group">
  <label>Avatar</label>
  <input type="file" id="in-avatar-file" accept="image/*">
</div>

      <div class="input-group">
  <label>Banner (Image or Video)</label>
  <input type="file" id="in-banner-file" accept="image/*,video/mp4,video/webm">
</div>

      <div class="input-group">
        <label>About You</label>
        <textarea id="in-bio" placeholder="Tell us about yourself..."></textarea>
      </div>
      
<div class="input-group">
  <label>Theme Color</label>
  <input type="color" id="in-theme-color" value="#7b2cbf">
</div>
<div class="input-group">
  <label>Background Type</label>
  <select id="in-bg-type">
    <option value="gradient">Gradient (Default)</option>
    <option value="color">Solid Color</option>
    <option value="image">Image URL</option>
    <option value="video">Video URL</option>
  </select>
</div>

<div class="input-group">
  <label>Background Upload (Image or Video)</label>
  <input type="file" id="in-bg-file" accept="image/*,video/mp4,video/webm">
</div>


      <div class="input-group">
        <label>Roles</label>
        <div id="roles-grid" class="roles-container">
          <!-- JS Injected -->
        </div>
      </div>

      <button type="submit" id="save-btn" class="action-btn">
        <div class="spinner"></div>
        <span class="btn-text">Save Changes</span>
      </button>

    </form>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <i class="ph-bold" id="toast-icon"></i>
  <span id="toast-msg"></span>
</div>

<script>
/* ================= CONFIGURATION ================= */
// REPLACE with your actual Project URL & Public Key
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co", 
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  
  defaultAvatar: "https://cdn.discordapp.com/embed/avatars/0.png",
  defaultBanner: "https://i.pinimg.com/originals/2b/2b/28/2b2b287959954e38e6840d0497557457.gif", // Dark aesthetic fallback

  // Roles available for selection
  roles: [
    { id: 'Founder',   label: 'Founder',   icon: 'founder.png' },
    { id: 'Admin',     label: 'Admin',     icon: 'admin.png' },
    { id: 'Moderator', label: 'Mod',       icon: 'moderator.png' },
    { id: 'Verified',  label: 'Verified',  icon: 'verified.png' }
  ]
};

/* ================= APP LOGIC ================= */
const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
let currentProfileId = null;

// UI Elements
const els = {
  avatarFile: document.getElementById('in-avatar-file'),
  bannerFile: document.getElementById('in-banner-file'),
  bgFile: document.getElementById('in-bg-file'),
  themeColorIn: document.getElementById('in-theme-color'),
  bgTypeIn: document.getElementById('in-bg-type'),
  bgValueIn: document.getElementById('in-bg-value'),
  form: document.getElementById('profileForm'),
  bioIn: document.getElementById('in-bio'),
  prevAvatar: document.getElementById('prev-avatar'),
  prevBanner: document.getElementById('prev-banner'),
  rolesGrid: document.getElementById('roles-grid'),
  btn: document.getElementById('save-btn'),
  spinner: document.querySelector('.spinner'),
  btnText: document.querySelector('.btn-text'),
  toast: document.getElementById('toast'),
  toastMsg: document.getElementById('toast-msg'),
  toastIcon: document.getElementById('toast-icon')
};

// 1. Initialize
(async function init() {
  renderRoles([]);
  

  setLoading(true, "Authenticating...");
  
  // Auth Check
  const { data: { user }, error: authErr } = await sb.auth.getUser();
  if (authErr || !user) {
    showToast("Not logged in", "error");
    setLoading(false, "Login Required");
    els.btn.disabled = true;
    return;
  }

  // Fetch Profile
  setLoading(true, "Loading Profile...");
  const { data, error } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();

  if (data) {
  currentProfileId = data.id;
  els.bioIn.value = data.bio || "";
  els.themeColorIn.value = data.theme_color || "#7b2cbf";
  if (els.bgTypeIn) {
  els.bgTypeIn.value = data.bg_type || "gradient";
}

if (els.bgValueIn) {
  els.bgValueIn.value = data.bg_value || "";
}

  document.documentElement.style.setProperty(
    '--c-accent',
    els.themeColorIn.value
  );

  renderRoles(data.roles || []);
  
} else {
    // New user fallback
    currentProfileId = user.id;
  }
  
  setLoading(false);
})();


els.form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentProfileId) return;

  setLoading(true, "Uploading...");

  let avatarUrl = null;
  let bannerUrl = null;
  let bgType = els.bgTypeIn.value;
  let bgValue = null;

  try {
    // AVATAR
    if (els.avatarFile.files[0]) {
      const file = els.avatarFile.files[0];
      const ext = file.name.split('.').pop();
      avatarUrl = await uploadFile(
        'avatars',
        file,
        `${currentProfileId}.${ext}`
      );
    }

    // BANNER (image or video)
    if (els.bannerFile.files[0]) {
      const file = els.bannerFile.files[0];
      const ext = file.name.split('.').pop();
      bannerUrl = await uploadFile(
        'banners',
        file,
        `${currentProfileId}.${ext}`
      );
    }

    // BACKGROUND (image or video)
    if (els.bgFile.files[0]) {
      const file = els.bgFile.files[0];
      const ext = file.name.split('.').pop();
      bgValue = await uploadFile(
        'backgrounds',
        file,
        `${currentProfileId}.${ext}`
      );

      bgType = file.type.startsWith('video') ? 'video' : 'image';
    }

    const activeRoles = Array.from(
      document.querySelectorAll('.role-card.active')
    ).map(el => el.dataset.roleId);

    const updates = {
      avatar: avatarUrl,
      banner_url: bannerUrl,
      theme_color: els.themeColorIn.value,
      bg_type: bgType,
      bg_value: bgValue,
      bio: els.bioIn.value.trim() || null,
      roles: activeRoles,
      updated_at: new Date().toISOString()
    };

    const { error } = await sb
      .from("profiles")
      .update(updates)
      .eq("id", currentProfileId);

    if (error) throw error;

    showToast("Profile updated", "success");

  } catch (err) {
    console.error(err);
    showToast("Upload failed", "error");
  }

  setLoading(false);
});

els.themeColorIn.addEventListener('input', e => {
  document.documentElement.style.setProperty('--c-accent', e.target.value);
});
/* ================= HELPERS ================= */

// Debounce: Prevents lag by waiting until user stops typing to execute heavy tasks (like image loading)
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}



function renderRoles(selectedRoles) {
  els.rolesGrid.innerHTML = "";

  // Only render roles that the user currently has
  CONFIG.roles
    .filter(role => selectedRoles.includes(role.id))
    .forEach(role => {
      const card = document.createElement('div');
      card.className = `role-card active`; // Always active because user has it
      card.dataset.roleId = role.id;

      // Create role inner HTML
      card.innerHTML = `
        <img src="../assets/${role.icon}" class="role-icon-img" onerror="this.style.display='none'">
        <span class="role-name">${role.label}</span>
      `;

      // Optional: clicking can still toggle active if you want editing
      card.addEventListener('click', () => card.classList.toggle('active'));

      els.rolesGrid.appendChild(card);
    });
}


function setLoading(isLoading, text = "Save Changes") {
  els.btn.disabled = isLoading;
  els.btnText.textContent = text;
  els.spinner.style.display = isLoading ? "block" : "none";
}

function showToast(msg, type) {
  els.toastMsg.innerText = msg;
  els.toast.className = `toast show ${type}`;
  els.toastIcon.className = type === 'success' ? 'ph-bold ph-check-circle' : 'ph-bold ph-warning-circle';
  
  setTimeout(() => els.toast.classList.remove('show'), 3000);
}
  async function uploadFile(bucket, file, path) {
  const { error } = await sb.storage
    .from(bucket)
    .upload(path, file, { upsert: true });

  if (error) throw error;

  const { data } = sb.storage.from(bucket).getPublicUrl(path);
  return data.publicUrl;
}

</script>
</body>
</html>

<!-- START OF FILE edit.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Edit Profile | /six</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<!-- LIBS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Cinzel:wght@500;700&family=Outfit:wght@700;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
/* --- CORE THEME --- */
:root {
  --bg: #050505;
  --surface: #0f0f11;
  --surface-highlight: #1a1a1e;
  --border: rgba(255,255,255,0.08);
  
  --accent: #7b2cbf;
  --accent-glow: rgba(123, 44, 191, 0.4);
  
  --text-main: #ffffff;
  --text-dim: #888888;
  
  --radius: 16px;
  --ease: cubic-bezier(0.22, 1, 0.36, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg); color: var(--text-main);
  font-family: 'Inter', sans-serif;
  height: 100vh; overflow: hidden; /* App-like feel */
  display: flex;
}

/* Texture */
body::before {
  content:""; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhZWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
  opacity: 0.03;
}

/* --- LAYOUT --- */
.app-shell {
  display: flex; width: 100%; height: 100%; z-index: 1;
  max-width: 1400px; margin: 0 auto;
}

/* Sidebar */
.sidebar {
  width: 280px; padding: 30px; border-right: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 40px;
  background: rgba(5,5,5,0.8); backdrop-filter: blur(20px);
}

.brand { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 700; letter-spacing: -1px; }

.nav-menu { display: flex; flex-direction: column; gap: 8px; }

.nav-item {
  padding: 12px 16px; border-radius: 10px;
  color: var(--text-dim); cursor: pointer;
  display: flex; align-items: center; gap: 12px;
  font-weight: 500; font-size: 14px;
  transition: 0.2s var(--ease);
}
.nav-item:hover { color: #fff; background: var(--surface-highlight); }
.nav-item.active { background: var(--surface-highlight); color: #fff; border-left: 3px solid var(--accent); }
.nav-item i { font-size: 18px; }

/* Main Area */
.main-content {
  flex: 1; padding: 40px; overflow-y: auto;
  display: grid; grid-template-columns: 1fr 380px; gap: 40px;
}

.editor-panel { display: none; flex-direction: column; gap: 24px; animation: fadeIn 0.4s var(--ease); }
.editor-panel.active { display: flex; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.panel-header h2 { font-size: 24px; font-weight: 600; margin-bottom: 6px; }
.panel-header p { color: var(--text-dim); font-size: 14px; }

/* Preview Column (Sticky) */
.preview-column { position: relative; }
.preview-sticky { position: sticky; top: 0; }

/* --- COMPONENTS --- */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
}

.input-group { display: flex; flex-direction: column; gap: 10px; }
.label { font-size: 12px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

input[type="text"], textarea {
  width: 100%; background: #000; border: 1px solid var(--border);
  padding: 14px; border-radius: 8px; color: #fff; font-family: inherit;
  transition: 0.2s;
}
input:focus, textarea:focus { border-color: var(--accent); }

/* File Drop */
.file-drop {
  height: 140px; border: 1px dashed var(--border); border-radius: var(--radius);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 10px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
}
.file-drop:hover { background: rgba(255,255,255,0.02); border-color: var(--text-dim); }
.file-drop img, .file-drop video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; }

/* Effect Grid */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.selection-card {
  padding: 15px; background: var(--surface-highlight);
  border: 1px solid transparent; border-radius: 8px; cursor: pointer;
  text-align: center; transition: 0.2s;
}
.selection-card:hover { transform: translateY(-2px); border-color: var(--border); }
.selection-card.active { border-color: var(--accent); background: rgba(123,44,191,0.1); }

/* --- EFFECTS PREVIEW --- */
/* The Signature "Ethereal" Effect */
.fx-ethereal {
  font-family: 'Cinzel', serif;
  background: linear-gradient(120deg, #fff 30%, var(--accent) 50%, #fff 70%);
  background-size: 200% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shine 4s linear infinite;
  letter-spacing: 1px; font-weight: 700;
}
@keyframes shine { to { background-position: 200% center; } }

.fx-glitch { font-family: 'Space Grotesk', sans-serif; text-shadow: 2px 0 #ff00ea, -2px 0 #00d0ff; }
.fx-glow { text-shadow: 0 0 15px var(--accent); }
.fx-none { color: #fff; }

/* --- PREVIEW CARD --- */
.preview-card {
  width: 100%; aspect-ratio: 9/13;
  border-radius: 24px; overflow: hidden; position: relative;
  box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
  border: 1px solid var(--border);
}
.p-banner { height: 35%; background: #222; position: relative; }
.p-banner img, .p-banner video { width: 100%; height: 100%; object-fit: cover; }
.p-avatar {
  width: 90px; height: 90px; border-radius: 50%;
  background: #000; padding: 4px;
  position: absolute; bottom: -45px; left: 20px;
}
.p-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.p-body { padding: 50px 20px 20px; background: rgba(15,15,15,0.9); height: 65%; backdrop-filter: blur(20px); }

/* --- MODAL --- */
.modal-overlay {
  position: fixed; inset: 0; z-index: 999;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: 0.3s;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal-box {
  width: 400px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; padding: 24px; transform: scale(0.95); transition: 0.3s var(--ease);
}
.modal-overlay.open .modal-box { transform: scale(1); }

/* Save Button */
.save-float {
  margin-top: auto; width: 100%; padding: 16px;
  background: var(--accent); border: none; border-radius: 12px;
  color: #fff; font-weight: 600; cursor: pointer;
  display: flex; justify-content: center; align-items: center; gap: 8px;
  transition: 0.2s;
}
.save-float:hover { filter: brightness(1.1); transform: translateY(-1px); }
.save-float:disabled { opacity: 0.5; cursor: wait; }

/* Responsive */
@media (max-width: 900px) {
  .app-shell { flex-direction: column; overflow-y: auto; }
  .sidebar { width: 100%; padding: 15px; border-right: none; border-bottom: 1px solid var(--border); }
  .nav-menu { flex-direction: row; overflow-x: auto; }
  .nav-item { white-space: nowrap; }
  .main-content { grid-template-columns: 1fr; padding: 20px; overflow: visible; }
  .preview-column { display: none; } /* Hide live preview on mobile to save space */
}
</style>
</head>
<body>

<!-- MODAL CONTAINER -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box" id="modal-content"></div>
</div>

<div class="app-shell">
  
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">/six</div>
    <nav class="nav-menu">
      <div class="nav-item active" onclick="tabs.switch('identity')">
        <i class="ph ph-fingerprint"></i> Identity
      </div>
      <div class="nav-item" onclick="tabs.switch('visuals')">
        <i class="ph ph-image"></i> Visuals
      </div>
      <div class="nav-item" onclick="tabs.switch('style')">
        <i class="ph ph-palette"></i> Style
      </div>
    </nav>
    
    <button id="btn-save" class="save-float">
      <i class="ph-bold ph-floppy-disk"></i> Save Profile
    </button>
  </aside>

  <!-- CONTENT -->
  <main class="main-content">
    
    <!-- 1. IDENTITY TAB -->
    <div id="tab-identity" class="editor-panel active">
      <div class="panel-header">
        <h2>Who are you?</h2>
        <p>Set your core details and bio.</p>
      </div>

      <div class="card">
        <div class="input-group">
          <span class="label">Biography</span>
          <textarea id="in-bio" rows="4" placeholder="Write something iconic..."></textarea>
        </div>
      </div>
      
      <div class="card">
        <span class="label" style="margin-bottom:12px; display:block;">Role Badge</span>
        <div class="grid-2">
           <label class="selection-card" style="display:flex;align-items:center;gap:10px;justify-content:center;">
             <input type="checkbox" id="in-show-role"> Show Highest Rank
           </label>
        </div>
      </div>
    </div>

    <!-- 2. VISUALS TAB -->
    <div id="tab-visuals" class="editor-panel">
      <div class="panel-header">
        <h2>Visuals</h2>
        <p>Your avatar, banner, and background.</p>
      </div>

      <div class="grid-2">
        <div class="input-group">
          <span class="label">Avatar</span>
          <div class="file-drop" id="drop-avatar">
            <i class="ph ph-user-circle" style="font-size:32px;"></i>
            <span style="font-size:12px">Upload Image</span>
            <input type="file" id="file-avatar" hidden accept="image/*">
            <img id="prev-avatar-img" class="hidden">
          </div>
        </div>
        
        <div class="input-group">
          <span class="label">Banner</span>
          <div class="file-drop" id="drop-banner">
            <i class="ph ph-rectangle" style="font-size:32px;"></i>
            <span style="font-size:12px">Img / Video</span>
            <input type="file" id="file-banner" hidden accept="image/*,video/*">
            <img id="prev-banner-img" class="hidden">
            <video id="prev-banner-vid" class="hidden" muted loop autoplay></video>
          </div>
        </div>
      </div>

      <div class="input-group">
        <span class="label">Page Background</span>
        <div class="file-drop" id="drop-bg" style="height:100px">
           <i class="ph ph-monitor-play"></i>
           <span id="bg-name" style="font-size:12px">Upload Wallpaper / Loop</span>
           <input type="file" id="file-bg" hidden accept="image/*,video/*">
        </div>
      </div>
    </div>

    <!-- 3. STYLE TAB -->
    <div id="tab-style" class="editor-panel">
      <div class="panel-header">
        <h2>Aesthetics</h2>
        <p>Define your signature look.</p>
      </div>

      <div class="card">
        <span class="label">Accent Color</span>
        <div style="display:flex; align-items:center; gap:15px; margin-top:10px;">
          <input type="color" id="in-color" value="#7b2cbf" style="width:50px; height:50px; padding:0; border:none; border-radius:50%; overflow:hidden; cursor:pointer;">
          <span id="hex-val" style="font-family:monospace; color:var(--text-dim);">#7b2cbf</span>
        </div>
      </div>

      <div class="card">
        <span class="label" style="margin-bottom:12px; display:block;">Username Effect</span>
        <div class="grid-2" id="effect-grid">
          <!-- Populated by JS -->
        </div>
        <input type="hidden" id="in-effect" value="none">
      </div>
      
      <div class="card">
         <span class="label">Custom Font</span>
         <button class="selection-card" style="width:100%; margin-top:8px" id="btn-import-font">
           Upload .OTF / .TTF
         </button>
      </div>
    </div>

    <!-- PREVIEW COLUMN -->
    <aside class="preview-column">
      <div class="preview-sticky">
        <span class="label" style="margin-bottom:10px; display:block;">Live Preview</span>
        <div class="preview-card" id="live-card">
          <div class="p-banner" id="p-banner-area"></div>
          <div class="p-avatar">
            <img id="p-avatar-img" src="https://cdn.discordapp.com/embed/avatars/0.png">
          </div>
          <div class="p-body">
            <h1 id="p-username" style="font-size:24px; margin-bottom:4px; margin-top:10px;">User</h1>
            <div style="font-size:12px; color:var(--text-dim); line-height:1.5; white-space:pre-wrap;" id="p-bio">...</div>
          </div>
        </div>
      </div>
    </aside>

  </main>
</div>

<script>
// --- CONFIG & STATE ---
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co",
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  effects: [
    { id: 'ethereal', name: 'Ethereal', icon: 'ph-sparkle' }, /* Signature Effect */
    { id: 'glitch', name: 'Cyber', icon: 'ph-lightning' },
    { id: 'glow', name: 'Neon', icon: 'ph-lightbulb' },
    { id: 'none', name: 'Classic', icon: 'ph-circle' }
  ]
};

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
let userSession = null;
let currentProfile = {};
const staging = { avatar: null, banner: null, bg: null, font: null };

// --- UI SYSTEMS ---

// 1. Modal Manager
const Modal = {
  el: document.getElementById('modal-overlay'),
  content: document.getElementById('modal-content'),
  open(html) {
    this.content.innerHTML = html;
    this.el.classList.add('open');
  },
  close() {
    this.el.classList.remove('open');
  }
};
document.getElementById('modal-overlay').onclick = (e) => {
  if(e.target.id === 'modal-overlay') Modal.close();
}

// 2. Tab Manager
const tabs = {
  switch(id) {
    document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(`tab-${id}`).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }
};

// 3. Effects Manager
function renderEffects(activeId) {
  const grid = document.getElementById('effect-grid');
  grid.innerHTML = CONFIG.effects.map(fx => `
    <div class="selection-card ${fx.id === activeId ? 'active' : ''}" 
         onclick="setEffect('${fx.id}')">
      <i class="ph ${fx.icon}" style="font-size:24px; margin-bottom:8px; display:block;"></i>
      <div class="fx-${fx.id}" style="font-size:14px;">${fx.name}</div>
    </div>
  `).join('');
  
  // Update Live Preview
  const pName = document.getElementById('p-username');
  pName.className = `fx-${activeId}`;
  document.getElementById('in-effect').value = activeId;
}

window.setEffect = (id) => renderEffects(id);

// --- INIT ---
(async function init() {
  const { data: { user } } = await sb.auth.getUser();
  if(!user) return window.location.href = '/login'; // Redirect if no auth
  
  userSession = user;
  
  // Fetch Profile
  const { data } = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
  if(data) {
    currentProfile = data;
    populate(data);
  } else {
    // New Profile Logic
    document.getElementById('p-username').innerText = user.email.split('@')[0];
  }
  
  setupListeners();
})();

// --- DATA HANDLING ---

function populate(data) {
  // Text
  document.getElementById('in-bio').value = data.bio || '';
  document.getElementById('p-bio').innerText = data.bio || '';
  document.getElementById('p-username').innerText = data.username || 'User';
  document.getElementById('in-show-role').checked = data.show_role_icon !== false;
  
  // Color
  const color = data.theme_color || '#7b2cbf';
  document.getElementById('in-color').value = color;
  document.getElementById('hex-val').innerText = color;
  updateTheme(color);

  // Effects
  renderEffects(data.username_effect || 'none');
  
  // Images
  if(data.avatar) {
    document.getElementById('p-avatar-img').src = data.avatar;
    document.querySelector('#drop-avatar img').src = data.avatar;
    document.querySelector('#drop-avatar img').classList.remove('hidden');
  }
  
  if(data.banner_url) {
    const isVid = data.banner_url.match(/\.(mp4|webm)$/);
    updateBannerPreview(data.banner_url, isVid);
  }
}

function updateTheme(hex) {
  document.documentElement.style.setProperty('--accent', hex);
  document.documentElement.style.setProperty('--accent-glow', hex + '44');
  // Update preview card styles
  document.getElementById('live-card').style.borderColor = hex;
}

function updateBannerPreview(url, isVideo) {
  const area = document.getElementById('p-banner-area');
  area.innerHTML = isVideo 
    ? `<video src="${url}" autoplay muted loop style="width:100%;height:100%;object-fit:cover"></video>` 
    : `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
    
  // Update Dropzone visual
  const dImg = document.getElementById('prev-banner-img');
  const dVid = document.getElementById('prev-banner-vid');
  
  if(isVideo) {
    dImg.classList.add('hidden');
    dVid.src = url; dVid.classList.remove('hidden');
  } else {
    dVid.classList.add('hidden');
    dImg.src = url; dImg.classList.remove('hidden');
  }
}

// --- INTERACTIONS ---

function setupListeners() {
  // Live Bio
  document.getElementById('in-bio').addEventListener('input', (e) => {
    document.getElementById('p-bio').innerText = e.target.value;
  });

  // Theme Color (Debounced)
  document.getElementById('in-color').addEventListener('input', (e) => {
    document.getElementById('hex-val').innerText = e.target.value;
    updateTheme(e.target.value);
  });

  // File Uploads
  setupDrop('drop-avatar', 'file-avatar', (f, u) => {
    staging.avatar = f;
    document.getElementById('p-avatar-img').src = u;
    const img = document.getElementById('prev-avatar-img');
    img.src = u; img.classList.remove('hidden');
  });

  setupDrop('drop-banner', 'file-banner', (f, u) => {
    staging.banner = f;
    updateBannerPreview(u, f.type.startsWith('video'));
  });

  setupDrop('drop-bg', 'file-bg', (f, u) => {
    staging.bg = f;
    document.getElementById('bg-name').innerText = f.name;
    document.getElementById('bg-name').style.color = 'var(--accent)';
  });
  
  // Font Import
  document.getElementById('btn-import-font').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = '.ttf,.otf';
      input.onchange = e => {
          const file = e.target.files[0];
          if(file) {
              staging.font = file;
              document.getElementById('btn-import-font').innerText = "Font Selected: " + file.name;
              document.getElementById('btn-import-font').classList.add('active');
          }
      };
      input.click();
  }

  // Save
  document.getElementById('btn-save').addEventListener('click', saveProfile);
}

function setupDrop(zoneId, inputId, callback) {
  const zone = document.getElementById(zoneId);
  const input = document.getElementById(inputId);
  
  zone.onclick = () => input.click();
  input.onchange = () => { if(input.files[0]) callback(input.files[0], URL.createObjectURL(input.files[0])); };
  zone.ondragover = e => { e.preventDefault(); zone.style.borderColor = 'var(--accent)'; };
  zone.ondragleave = () => { zone.style.borderColor = 'var(--border)'; };
  zone.ondrop = e => {
    e.preventDefault(); zone.style.borderColor = 'var(--border)';
    if(e.dataTransfer.files[0]) callback(e.dataTransfer.files[0], URL.createObjectURL(e.dataTransfer.files[0]));
  };
}

// --- SAVING LOGIC ---

async function saveProfile() {
  const btn = document.getElementById('btn-save');
  btn.disabled = true; btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> Saving...';
  
  try {
    const updates = {
      updated_at: new Date(),
      bio: document.getElementById('in-bio').value,
      theme_color: document.getElementById('in-color').value,
      username_effect: document.getElementById('in-effect').value,
      show_role_icon: document.getElementById('in-show-role').checked
    };

    // Upload Helper
    const uploadFile = async (file, bucket) => {
      const ext = file.name.split('.').pop();
      const path = `${userSession.id}/${Date.now()}.${ext}`;
      const { error } = await sb.storage.from(bucket).upload(path, file, { upsert:true });
      if(error) throw error;
      return sb.storage.from(bucket).getPublicUrl(path).data.publicUrl;
    };

    if(staging.avatar) updates.avatar = await uploadFile(staging.avatar, 'avatars');
    if(staging.banner) updates.banner_url = await uploadFile(staging.banner, 'banners');
    if(staging.bg) {
      updates.bg_value = await uploadFile(staging.bg, 'backgrounds');
      updates.bg_type = staging.bg.type.startsWith('video') ? 'video' : 'image';
    }
    if(staging.font) {
        updates.custom_font_url = await uploadFile(staging.font, 'fonts');
        updates.username_font = 'custom';
    }

    const { error } = await sb.from('profiles').upsert({ id: userSession.id, ...updates });
    if(error) throw error;

    btn.innerHTML = '<i class="ph-bold ph-check"></i> Saved';
    setTimeout(() => { btn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> Save Profile'; btn.disabled = false; }, 2000);

  } catch (err) {
    console.error(err);
    alert('Error saving profile');
    btn.disabled = false;
    btn.innerText = 'Try Again';
  }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Edit Profile | /six</title>

<!-- DEPENDENCIES -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* =========================================
   1. CORE THEME & RESET
   ========================================= */
:root {
  --bg-dark: #050505;
  --panel-bg: rgba(18, 18, 18, 0.7);
  --panel-border: rgba(255, 255, 255, 0.08);
  --accent: #7b2cbf;
  --accent-glow: rgba(123, 44, 191, 0.5);
  --text-main: #ffffff;
  --text-muted: #a1a1aa;
  --radius: 16px;
  --ease: cubic-bezier(0.23, 1, 0.32, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg-dark);
  color: var(--text-main);
  font-family: 'Inter', sans-serif;
  height: 100vh; overflow: hidden;
  display: flex;
}

/* Background Noise */
.bg-noise {
  position: fixed; inset: 0; pointer-events: none; z-index: -1; opacity: 0.05;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhZWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
::-webkit-scrollbar-track { background: transparent; }

/* =========================================
   2. LAYOUT: SPLIT SCREEN
   ========================================= */
.editor-layout {
  display: flex; width: 100%; height: 100%;
}

/* LEFT: PREVIEW AREA */
.preview-pane {
  flex: 1;
  display: flex; align-items: center; justify-content: center;
  position: relative;
  background: radial-gradient(circle at center, rgba(20,20,20,0.5), transparent 70%);
  overflow: hidden;
}

/* RIGHT: CONTROLS AREA */
.settings-pane {
  width: 420px;
  background: rgba(10, 10, 10, 0.8);
  backdrop-filter: blur(20px);
  border-left: 1px solid var(--panel-border);
  display: flex; flex-direction: column;
}

.settings-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--panel-border);
  display: flex; justify-content: space-between; align-items: center;
}
.settings-title { font-weight: 600; font-size: 1.1rem; display: flex; gap: 8px; align-items: center; }

.settings-scroll {
  flex: 1; overflow-y: auto; padding: 20px;
}

.settings-footer {
  padding: 20px;
  border-top: 1px solid var(--panel-border);
  background: rgba(0,0,0,0.2);
}

/* =========================================
   3. 3D CARD PREVIEW (Exact copy of Viewer)
   ========================================= */
.profile-card {
  width: 400px;
  background: rgba(15, 15, 15, 0.65);
  border: 1px solid var(--panel-border);
  border-radius: 24px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.1s; /* Fast for mouse movement */
  box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
  user-select: none;
}

.card-banner {
  height: 140px; width: 100%; border-radius: 24px 24px 0 0;
  overflow: hidden; position: relative; border-bottom: 1px solid var(--panel-border);
}
.banner-media { width: 100%; height: 100%; object-fit: cover; }

.card-content {
  padding: 0 24px 30px;
  display: flex; flex-direction: column; align-items: center; text-align: center;
}

.avatar-wrapper {
  margin-top: -50px; margin-bottom: 12px;
  width: 100px; height: 100px; position: relative;
  display: flex; justify-content: center; align-items: center;
}

/* Visualizer Canvas */
#preview-visualizer {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 200px; height: 200px;
  pointer-events: none; z-index: 0;
}

.avatar-img {
  width: 90px; height: 90px; border-radius: 50%;
  background: #111; object-fit: cover;
  border: 2px solid rgba(255,255,255,0.1);
  position: relative; z-index: 2;
}

.username { font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
.bio { font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.5; white-space: pre-wrap; margin-top: 8px;}

/* =========================================
   4. FORM ELEMENTS & ACCORDION
   ========================================= */
.accordion-item {
  border: 1px solid var(--panel-border);
  border-radius: 12px;
  background: rgba(255,255,255,0.02);
  margin-bottom: 12px; overflow: hidden;
}

.accordion-header {
  padding: 16px; cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  font-size: 0.9rem; font-weight: 600; color: var(--text-muted);
  transition: 0.2s;
}
.accordion-header:hover { background: rgba(255,255,255,0.05); color: #fff; }
.accordion-header i { transition: transform 0.3s; }
.accordion-item.active .accordion-header i { transform: rotate(180deg); color: var(--accent); }

.accordion-body {
  padding: 0 16px 16px; display: none;
  animation: slideDown 0.3s var(--ease);
}
.accordion-item.active .accordion-body { display: block; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* Inputs */
.input-group { margin-bottom: 16px; }
label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; }

input[type="text"], textarea, select {
  width: 100%; background: rgba(0,0,0,0.3);
  border: 1px solid var(--panel-border);
  padding: 12px; border-radius: 8px;
  color: #fff; font-family: inherit; font-size: 0.9rem;
  transition: 0.2s;
}
input:focus, textarea:focus, select:focus { border-color: var(--accent); }
textarea { resize: none; min-height: 80px; }

/* Color Picker */
.color-row { display: flex; gap: 10px; align-items: center; }
input[type="color"] {
  background: none; border: none; width: 40px; height: 40px; cursor: pointer;
}

/* File Upload */
.upload-btn {
  width: 100%; padding: 12px;
  background: rgba(255,255,255,0.05); border: 1px dashed var(--panel-border);
  border-radius: 8px; color: var(--text-muted); font-size: 0.8rem;
  cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: 0.2s;
}
.upload-btn:hover { border-color: var(--accent); color: #fff; background: rgba(123,44,191,0.1); }

/* Save Button */
.btn-save {
  width: 100%; padding: 14px;
  background: var(--accent); color: #fff; border: none;
  border-radius: 12px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: 0.2s;
}
.btn-save:hover { box-shadow: 0 0 20px var(--accent-glow); transform: translateY(-1px); }
.btn-save:disabled { opacity: 0.7; cursor: not-allowed; filter: grayscale(1); }

/* Toggles */
.toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; inset: 0; background-color: #333; border-radius: 34px; transition: .4s;
}
.slider:before {
  position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s;
}
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(18px); }

/* Mobile Responsive */
@media(max-width: 900px) {
  .editor-layout { flex-direction: column; overflow-y: auto; }
  .preview-pane { height: 400px; flex: none; border-bottom: 1px solid var(--panel-border); }
  .settings-pane { width: 100%; border-left: none; flex: 1; }
  .profile-card { transform: scale(0.8) !important; }
}
</style>
</head>
<body>

<div class="bg-noise"></div>

<div class="editor-layout">

  <!-- LEFT: LIVE PREVIEW -->
  <section class="preview-pane" id="preview-container">
    <div class="profile-card" id="card-3d">
      <div class="card-banner">
        <div id="prev-banner-container" style="width:100%;height:100%">
          <img src="" class="banner-media" id="prev-banner-img">
        </div>
      </div>
      <div class="card-content">
        <div class="avatar-wrapper">
          <canvas id="preview-visualizer"></canvas>
          <img src="" class="avatar-img" id="prev-avatar">
        </div>
        <div class="username" id="prev-username">Username</div>
        <div class="bio" id="prev-bio">Bio...</div>
      </div>
    </div>
  </section>

  <!-- RIGHT: CONTROLS -->
  <aside class="settings-pane">
    <div class="settings-header">
      <div class="settings-title"><i class="ph-bold ph-faders"></i> Profile Editor</div>
      <button class="upload-btn" style="width:auto; padding:8px 12px;" onclick="window.location.href='/dashboard'">Exit</button>
    </div>

    <div class="settings-scroll">
      
      <!-- IDENTITY -->
      <div class="accordion-item active">
        <div class="accordion-header">
          <span>Identity</span> <i class="ph-bold ph-caret-down"></i>
        </div>
        <div class="accordion-body">
          <div class="input-group">
            <label>Bio</label>
            <textarea id="inp-bio" placeholder="Tell your story..."></textarea>
          </div>
          <div class="input-group">
            <label>Avatar</label>
            <label class="upload-btn">
              <i class="ph-bold ph-upload-simple"></i> Upload New Avatar
              <input type="file" hidden id="file-avatar" accept="image/*">
            </label>
          </div>
        </div>
      </div>

      <!-- VISUALIZER (NEW) -->
      <div class="accordion-item">
        <div class="accordion-header">
          <span>Audio Visualizer</span> <i class="ph-bold ph-caret-down"></i>
        </div>
        <div class="accordion-body">
          <div class="toggle-row">
            <label style="margin:0">Enable Visualizer</label>
            <label class="switch">
              <input type="checkbox" id="inp-vis-enable">
              <span class="slider"></span>
            </label>
          </div>
          <div style="font-size:0.75rem; color:var(--text-muted); margin:8px 0 16px;">
            Reacts to your banner video audio. Use the "Test Audio" button below to preview without uploading.
          </div>
          
          <div class="input-group">
            <label>Visualizer Color</label>
            <div class="color-row">
              <input type="color" id="inp-vis-color" value="#7b2cbf">
              <input type="text" id="inp-vis-color-text" value="#7b2cbf" style="width:100px;">
            </div>
          </div>
          
          <button class="upload-btn" id="btn-test-audio">
            <i class="ph-fill ph-play"></i> Play Demo Audio for Preview
          </button>
        </div>
      </div>

      <!-- THEME -->
      <div class="accordion-item">
        <div class="accordion-header">
          <span>Theme & Banner</span> <i class="ph-bold ph-caret-down"></i>
        </div>
        <div class="accordion-body">
          <div class="input-group">
            <label>Accent Color</label>
            <div class="color-row">
              <input type="color" id="inp-accent" value="#7b2cbf">
              <span style="font-size:0.8rem; color:#aaa;">Changes buttons & glow</span>
            </div>
          </div>
          
          <div class="input-group">
            <label>Banner (Image or Video)</label>
            <label class="upload-btn">
              <i class="ph-bold ph-file-video"></i> Upload Media
              <input type="file" hidden id="file-banner" accept="image/*,video/mp4">
            </label>
          </div>
        </div>
      </div>

    </div>

    <div class="settings-footer">
      <button class="btn-save" id="btn-save">
        <i class="ph-bold ph-floppy-disk"></i> Save Changes
      </button>
    </div>
  </aside>

</div>

<!-- HIDDEN AUDIO FOR TESTING -->
<audio id="demo-audio" loop crossorigin="anonymous" src="https://assets.codepen.io/217233/bensound-sunny.mp3"></audio>

<script>
/**
 * ==========================================
 * EDITOR ENGINE with LIVE PREVIEW
 * ==========================================
 */
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co", 
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  defaults: {
    avatar: "https://cdn.discordapp.com/embed/avatars/0.png",
    banner: "https://media.giphy.com/media/26BRy67X26yX1eLhm/giphy.gif"
  }
};

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

// --- VISUALIZER ENGINE (Reused from Viewer) ---
class PreviewVisualizer {
  constructor(canvasId) {
    this.canvas = document.getElementById(canvasId);
    this.ctx = this.canvas.getContext('2d');
    this.active = false;
    this.audioCtx = null;
    this.analyser = null;
    this.source = null;
    this.color = '#7b2cbf';
    
    // High DPI
    this.canvas.width = 400;
    this.canvas.height = 400;
  }

  setSource(mediaElement) {
    if (this.source) return; // Already set
    
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      this.audioCtx = new AudioContext();
      this.analyser = this.audioCtx.createAnalyser();
      this.source = this.audioCtx.createMediaElementSource(mediaElement);
      
      this.source.connect(this.analyser);
      this.analyser.connect(this.audioCtx.destination);
      
      this.analyser.fftSize = 128;
      this.bufferLength = this.analyser.frequencyBinCount;
      this.dataArray = new Uint8Array(this.bufferLength);
      
      this.active = true;
      this.render();
    } catch(e) {
      console.log("Audio Context Error", e);
    }
  }

  updateColor(hex) {
    this.color = hex;
  }

  toggle(shouldPlay) {
    this.canvas.style.display = shouldPlay ? 'block' : 'none';
  }

  render() {
    if (!this.active) return;
    requestAnimationFrame(this.render.bind(this));
    
    this.analyser.getByteFrequencyData(this.dataArray);
    
    const ctx = this.ctx;
    const w = this.canvas.width;
    const h = this.canvas.height;
    const cx = w/2;
    const cy = h/2;
    const r = 110; // Radius
    
    ctx.clearRect(0, 0, w, h);
    
    ctx.beginPath();
    const bars = 40;
    const step = (Math.PI * 2) / bars;
    
    for (let i = 0; i < bars; i++) {
      const val = this.dataArray[i % this.bufferLength];
      const barH = (val / 255) * 60;
      
      const angle = i * step;
      const x1 = cx + Math.cos(angle) * r;
      const y1 = cy + Math.sin(angle) * r;
      const x2 = cx + Math.cos(angle) * (r + barH);
      const y2 = cy + Math.sin(angle) * (r + barH);
      
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
    }
    
    ctx.strokeStyle = this.color;
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.shadowBlur = 15;
    ctx.shadowColor = this.color;
    ctx.stroke();
    ctx.shadowBlur = 0;
  }
}

// --- MAIN APP ---
class EditorApp {
  constructor() {
    this.user = null;
    this.visualizer = new PreviewVisualizer('preview-visualizer');
    
    this.dom = {
      card: document.getElementById('card-3d'),
      avatar: document.getElementById('prev-avatar'),
      bannerContainer: document.getElementById('prev-banner-container'),
      username: document.getElementById('prev-username'),
      bio: document.getElementById('prev-bio'),
      // Inputs
      bioInp: document.getElementById('inp-bio'),
      visEnable: document.getElementById('inp-vis-enable'),
      visColor: document.getElementById('inp-vis-color'),
      accentInp: document.getElementById('inp-accent'),
      fileAvatar: document.getElementById('file-avatar'),
      fileBanner: document.getElementById('file-banner'),
      saveBtn: document.getElementById('btn-save'),
      testAudioBtn: document.getElementById('btn-test-audio')
    };

    this.filesToUpload = { avatar: null, banner: null };

    this.init();
    this.setupAccordions();
    this.setup3DTilt();
  }

  async init() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) return alert("Please login");
    
    this.user = user;
    const { data } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();
    
    if (data) this.loadData(data);
    this.setupListeners();
  }

  loadData(data) {
    // Fill Inputs
    this.dom.bioInp.value = data.bio || "";
    this.dom.visEnable.checked = data.visualizer_enabled !== false;
    this.dom.visColor.value = data.visualizer_color || '#7b2cbf';
    this.dom.accentInp.value = data.theme_color || '#7b2cbf';

    // Update Preview
    this.dom.username.innerText = data.username;
    this.dom.bio.innerText = data.bio || "No bio set.";
    this.dom.avatar.src = data.avatar || CONFIG.defaults.avatar;
    
    // Banner Handling
    this.updateBannerPreview(data.banner_url || CONFIG.defaults.banner);

    // Set Theme
    this.updateTheme(this.dom.accentInp.value);
    
    // Visualizer Init
    this.visualizer.updateColor(this.dom.visColor.value);
    this.visualizer.toggle(this.dom.visEnable.checked);
  }

  setupListeners() {
    // Real-time Bio
    this.dom.bioInp.addEventListener('input', (e) => {
      this.dom.bio.innerText = e.target.value;
    });

    // Theme Colors
    this.dom.accentInp.addEventListener('input', (e) => this.updateTheme(e.target.value));
    
    // Visualizer Controls
    this.dom.visColor.addEventListener('input', (e) => {
      this.visualizer.updateColor(e.target.value);
      document.getElementById('inp-vis-color-text').value = e.target.value;
    });
    this.dom.visEnable.addEventListener('change', (e) => {
      this.visualizer.toggle(e.target.checked);
    });

    // Audio Test
    this.dom.testAudioBtn.addEventListener('click', () => {
      const audio = document.getElementById('demo-audio');
      if (audio.paused) {
        audio.play();
        this.visualizer.setSource(audio);
        this.dom.testAudioBtn.innerHTML = '<i class="ph-fill ph-pause"></i> Pause Demo';
      } else {
        audio.pause();
        this.dom.testAudioBtn.innerHTML = '<i class="ph-fill ph-play"></i> Play Demo Audio';
      }
    });

    // File Previews
    this.dom.fileAvatar.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file) {
        this.filesToUpload.avatar = file;
        this.dom.avatar.src = URL.createObjectURL(file);
      }
    });

    this.dom.fileBanner.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file) {
        this.filesToUpload.banner = file;
        this.updateBannerPreview(URL.createObjectURL(file), file.type.startsWith('video'));
      }
    });

    // Save
    this.dom.saveBtn.addEventListener('click', () => this.saveProfile());
  }

  updateBannerPreview(url, isVideo = false) {
    // Simple check if url ends in video extension if type not provided
    if (!isVideo && url.match(/\.(mp4|webm)$/)) isVideo = true;

    this.dom.bannerContainer.innerHTML = '';
    if (isVideo) {
      const vid = document.createElement('video');
      vid.src = url;
      vid.className = 'banner-media';
      vid.autoplay = true;
      vid.muted = true; // Muted in preview unless testing audio specifically
      vid.loop = true;
      this.dom.bannerContainer.appendChild(vid);
    } else {
      const img = document.createElement('img');
      img.src = url;
      img.className = 'banner-media';
      this.dom.bannerContainer.appendChild(img);
    }
  }

  updateTheme(hex) {
    document.documentElement.style.setProperty('--accent', hex);
    document.documentElement.style.setProperty('--accent-glow', hex + '66');
  }

  setupAccordions() {
    document.querySelectorAll('.accordion-header').forEach(header => {
      header.addEventListener('click', () => {
        const item = header.parentElement;
        // Close others
        document.querySelectorAll('.accordion-item').forEach(i => {
          if(i !== item) i.classList.remove('active');
        });
        item.classList.toggle('active');
      });
    });
  }

  setup3DTilt() {
    const card = this.dom.card;
    const container = document.getElementById('preview-container');

    container.addEventListener('mousemove', (e) => {
      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      
      const rotateX = ((y - centerY) / centerY) * -10; // Max 10deg
      const rotateY = ((x - centerX) / centerX) * 10;

      card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
    });

    container.addEventListener('mouseleave', () => {
      card.style.transform = `perspective(1000px) rotateX(0) rotateY(0)`;
    });
  }

  async saveProfile() {
    const btn = this.dom.saveBtn;
    btn.innerHTML = '<i class="ph-bold ph-spinner ph-spin"></i> Saving...';
    btn.disabled = true;

    try {
      const updates = {
        updated_at: new Date(),
        bio: this.dom.bioInp.value,
        visualizer_enabled: this.dom.visEnable.checked,
        visualizer_color: this.dom.visColor.value,
        theme_color: this.dom.accentInp.value
      };

      // Uploads
      if (this.filesToUpload.avatar) {
        updates.avatar = await this.uploadFile(this.filesToUpload.avatar, 'avatars');
      }
      if (this.filesToUpload.banner) {
        updates.banner_url = await this.uploadFile(this.filesToUpload.banner, 'banners');
      }

      const { error } = await sb.from("profiles").upsert({ id: this.user.id, ...updates });
      if(error) throw error;

      btn.innerHTML = '<i class="ph-bold ph-check"></i> Saved!';
      setTimeout(() => {
        btn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> Save Changes';
        btn.disabled = false;
      }, 2000);

    } catch (e) {
      alert("Error saving: " + e.message);
      btn.innerHTML = 'Error';
      btn.disabled = false;
    }
  }

  async uploadFile(file, bucket) {
    const ext = file.name.split('.').pop();
    const path = `${this.user.id}/${Date.now()}.${ext}`;
    const { error } = await sb.storage.from(bucket).upload(path, file, { upsert: true });
    if(error) throw error;
    const { data } = sb.storage.from(bucket).getPublicUrl(path);
    return data.publicUrl;
  }
}

document.addEventListener('DOMContentLoaded', () => new EditorApp());

</script>
</body>
</html>

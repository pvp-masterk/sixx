<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Architect Mode | /six</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* =========================================
   1. ARCHITECT THEME ENGINE
   ========================================= */
:root {
  --bg-void: #030303;
  --glass-surface: rgba(12, 12, 12, 0.75);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-highlight: rgba(255, 255, 255, 0.15);
  --accent: #7b2cbf;
  --accent-glow: rgba(123, 44, 191, 0.6);
  --text-main: #ffffff;
  --text-dim: #6b6b6b;
  --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
  --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg-void);
  color: var(--text-main);
  font-family: 'Inter', sans-serif;
  height: 100vh; width: 100vw; overflow: hidden;
  display: flex;
}

/* Background & Grid */
.viewport-bg {
  position: absolute; inset: 0; z-index: 0; overflow: hidden;
}
.grid-overlay {
  position: absolute; inset: 0; pointer-events: none;
  background-image: 
    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  mask-image: radial-gradient(circle at center, black 40%, transparent 80%);
}

/* The Live Background Media */
#bg-preview-layer {
  position: absolute; inset: 0; width: 100%; height: 100%;
  object-fit: cover; opacity: 0.5; z-index: -1;
  transition: filter 0.3s;
}

/* =========================================
   2. CENTRAL STAGE (The Card)
   ========================================= */
.stage {
  flex: 1; position: relative; z-index: 1;
  display: flex; align-items: center; justify-content: center;
  perspective: 1500px;
}

.profile-card {
  width: 420px;
  background: rgba(15, 15, 15, 0.8);
  backdrop-filter: blur(24px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  position: relative;
  transform-style: preserve-3d;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
  transition: transform 0.1s;
}

/* Card Internals */
.card-header { height: 160px; position: relative; overflow: hidden; border-radius: 24px 24px 0 0; }
.card-banner-img { width: 100%; height: 100%; object-fit: cover; }
.card-body { padding: 0 32px 32px; display: flex; flex-direction: column; align-items: center; text-align: center; }

.avatar-group {
  margin-top: -60px; position: relative; width: 120px; height: 120px;
  display: flex; justify-content: center; align-items: center;
}

/* Visualizer Canvas */
#vis-canvas {
  position: absolute; inset: -50px; width: 220px; height: 220px;
  pointer-events: none; z-index: 0;
}

.avatar-img {
  width: 100%; height: 100%; border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.1); background: #000;
  object-fit: cover; z-index: 2;
}

.username { font-size: 1.8rem; font-weight: 700; margin-top: 12px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
.bio { font-size: 0.9rem; color: #ccc; margin-top: 8px; line-height: 1.5; white-space: pre-wrap; }

/* =========================================
   3. HUD CONTROLS (Right Panel)
   ========================================= */
.hud-panel {
  width: 380px; height: 100%;
  background: var(--glass-surface);
  backdrop-filter: blur(40px);
  border-left: 1px solid var(--glass-border);
  display: flex; flex-direction: column;
  z-index: 10;
  transform: translateX(0); transition: transform 0.3s var(--ease-smooth);
}
.hud-collapsed .hud-panel { transform: translateX(100%); }

.hud-header {
  padding: 20px; border-bottom: 1px solid var(--glass-border);
  display: flex; justify-content: space-between; align-items: center;
}
.hud-title { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; }

.hud-scroll { flex: 1; overflow-y: auto; padding: 20px; }

/* Section Styling */
.section { margin-bottom: 30px; }
.section-label { 
  font-size: 0.7rem; font-weight: 700; color: var(--accent); 
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.section-label::after { content:""; height:1px; flex:1; background: var(--glass-border); }

/* Inputs */
.hud-input {
  width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
  border-radius: 8px; padding: 12px; color: #fff; font-family: inherit;
  transition: 0.2s; font-size: 0.85rem;
}
.hud-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }

/* CUSTOM COLOR PICKER */
.color-picker-container {
  display: flex; gap: 12px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);
}
.color-preview {
  width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
  background: var(--accent); box-shadow: 0 0 15px var(--accent-glow);
}
.spectrum-slider {
  flex: 1; height: 40px; border-radius: 8px; position: relative; cursor: crosshair;
  background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
}

/* ENHANCED UPLOADERS */
.drop-zone {
  position: relative;
  height: 100px;
  border: 1px dashed var(--glass-border);
  border-radius: 12px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: 0.3s; cursor: pointer;
  background: radial-gradient(circle, rgba(255,255,255,0.02), transparent);
  overflow: hidden;
}
.drop-zone:hover { border-color: var(--accent); background: rgba(123,44,191,0.05); }
.drop-zone i { font-size: 24px; color: var(--text-dim); margin-bottom: 8px; transition:0.3s; }
.drop-zone span { font-size: 0.75rem; color: var(--text-dim); }
/* Drag Active State */
.drop-zone.drag-over { border-color: #fff; background: rgba(255,255,255,0.1); transform: scale(0.98); }

/* Preview within Dropzone */
.file-preview-bg {
  position: absolute; inset:0; width:100%; height:100%; object-fit: cover; opacity: 0.3; pointer-events: none;
}

/* TOGGLES */
.switch-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
.switch-label { font-size: 0.85rem; color: #ddd; }
.switch {
  position: relative; width: 44px; height: 24px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; inset: 0; background-color: rgba(255,255,255,0.1); border-radius: 34px; transition: .3s;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #aaa; border-radius: 50%; transition: .3s var(--ease-elastic);
}
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(20px); background-color: #fff; }

/* ACTION BAR */
.hud-footer {
  padding: 20px; border-top: 1px solid var(--glass-border);
}
.btn-primary {
  width: 100%; padding: 16px; border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), #5a189a);
  color: #fff; font-weight: 600; border: none; cursor: pointer;
  box-shadow: 0 10px 30px -10px var(--accent-glow);
  transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 40px -10px var(--accent-glow); }

/* Loading State */
.loader { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite; display: none;}
@keyframes spin { to { transform: rotate(360deg); } }

/* Mobile */
@media(max-width: 900px) {
  body { flex-direction: column; overflow-y: auto; height: auto; }
  .stage { height: 500px; overflow: hidden; }
  .hud-panel { width: 100%; height: auto; }
  .profile-card { transform: scale(0.85); }
}
</style>
</head>
<body>

<!-- VIEWPORT LAYERS -->
<div class="viewport-bg">
  <div id="bg-container">
    <div style="background:radial-gradient(circle at center, #1a0b2e 0%, #000 100%); width:100%; height:100%;"></div>
  </div>
  <div class="grid-overlay"></div>
</div>

<!-- MAIN STAGE -->
<main class="stage" id="tilt-stage">
  <div class="profile-card" id="card-3d">
    
    <div class="card-header">
      <div id="banner-container" style="width:100%;height:100%"></div>
    </div>

    <div class="card-body">
      <div class="avatar-group">
        <canvas id="vis-canvas"></canvas>
        <img src="" id="ui-avatar" class="avatar-img">
      </div>
      
      <div id="ui-username" class="username">User</div>
      <div id="ui-bio" class="bio">Loading...</div>
    </div>
  
  </div>
</main>

<!-- RIGHT HUD -->
<aside class="hud-panel">
  <div class="hud-header">
    <span class="hud-title">/// ARCHITECT_V2</span>
    <button style="background:none; border:none; color:#fff; cursor:pointer;" onclick="window.location.href='/dashboard'"><i class="ph-bold ph-sign-out"></i></button>
  </div>

  <div class="hud-scroll">
    
    <!-- IDENTITY -->
    <div class="section">
      <div class="section-label"><i class="ph-bold ph-fingerprint"></i> Identity</div>
      <textarea id="inp-bio" class="hud-input" placeholder="Transmission..." rows="3"></textarea>
    </div>

    <!-- ASSETS -->
    <div class="section">
      <div class="section-label"><i class="ph-bold ph-cube"></i> Assets</div>
      
      <!-- Avatar Uploader -->
      <div style="margin-bottom:12px;">
        <label style="font-size:0.75rem; color:#888; margin-bottom:4px; display:block;">Avatar</label>
        <div class="drop-zone" id="dz-avatar">
          <i class="ph-bold ph-user-circle"></i>
          <span>Drop Image</span>
          <input type="file" hidden id="file-avatar" accept="image/*">
        </div>
      </div>

      <!-- Banner Uploader -->
      <div style="margin-bottom:12px;">
        <label style="font-size:0.75rem; color:#888; margin-bottom:4px; display:block;">Card Banner (Video/Image)</label>
        <div class="drop-zone" id="dz-banner">
          <i class="ph-bold ph-film-strip"></i>
          <span>Drop MP4 or GIF</span>
          <input type="file" hidden id="file-banner" accept="image/*,video/mp4,video/webm">
        </div>
      </div>

      <!-- Background Uploader -->
      <div>
        <label style="font-size:0.75rem; color:#888; margin-bottom:4px; display:block;">Global Background</label>
        <div class="drop-zone" id="dz-bg">
          <i class="ph-bold ph-globe"></i>
          <span>Drop Environment</span>
          <input type="file" hidden id="file-bg" accept="image/*,video/mp4">
        </div>
      </div>
    </div>

    <!-- CUSTOMIZATION -->
    <div class="section">
      <div class="section-label"><i class="ph-bold ph-faders"></i> Tuning</div>
      
      <!-- Custom Color Engine -->
      <div style="margin-bottom: 20px;">
        <label style="font-size:0.75rem; color:#888; margin-bottom:6px; display:block;">System Accent</label>
        <div class="color-picker-container">
          <div class="color-preview" id="color-dot"></div>
          <canvas id="spectrum-canvas" class="spectrum-slider" width="250" height="40"></canvas>
        </div>
      </div>

      <!-- Visualizer Config -->
      <div class="switch-row">
        <span class="switch-label">Audio Visualizer</span>
        <label class="switch">
          <input type="checkbox" id="inp-vis-enable">
          <span class="slider"></span>
        </label>
      </div>

      <!-- Test Audio Button -->
      <button id="btn-audio-test" style="width:100%; margin-top:10px; padding:10px; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:#fff; border-radius:8px; cursor:pointer;">
        <i class="ph-fill ph-play"></i> Test Audio Reactivity
      </button>

    </div>

  </div>

  <div class="hud-footer">
    <button class="btn-primary" id="btn-save">
      <span>Save Configuration</span>
      <div class="loader"></div>
    </button>
  </div>
</aside>

<!-- HIDDEN AUDIO -->
<audio id="demo-audio" src="https://assets.codepen.io/217233/bensound-sunny.mp3" loop crossorigin="anonymous"></audio>

<script>
/**
 * ==========================================
 * ARCHITECT ENGINE
 * ==========================================
 */

const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co", 
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  defaults: {
    avatar: "https://cdn.discordapp.com/embed/avatars/0.png",
    banner: "https://media.giphy.com/media/26BRy67X26yX1eLhm/giphy.gif"
  }
};
const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

/* --- CUSTOM COLOR PICKER CLASS --- */
class ColorEngine {
  constructor(canvasId, callback) {
    this.canvas = document.getElementById(canvasId);
    this.ctx = this.canvas.getContext('2d');
    this.callback = callback;
    this.width = this.canvas.width;
    this.height = this.canvas.height;
    
    this.drawSpectrum();
    this.setupEvents();
  }

  drawSpectrum() {
    const grad = this.ctx.createLinearGradient(0, 0, this.width, 0);
    grad.addColorStop(0, "red");
    grad.addColorStop(0.17, "yellow");
    grad.addColorStop(0.33, "lime");
    grad.addColorStop(0.5, "cyan");
    grad.addColorStop(0.66, "blue");
    grad.addColorStop(0.83, "magenta");
    grad.addColorStop(1, "red");
    this.ctx.fillStyle = grad;
    this.ctx.fillRect(0, 0, this.width, this.height);
  }

  setupEvents() {
    let isDragging = false;
    const pick = (e) => {
      const rect = this.canvas.getBoundingClientRect();
      const x = Math.max(0, Math.min(e.clientX - rect.left, this.width - 1));
      const p = this.ctx.getImageData(x, this.height/2, 1, 1).data;
      const hex = "#" + [p[0], p[1], p[2]].map(x => x.toString(16).padStart(2, '0')).join("");
      this.callback(hex);
    };

    this.canvas.addEventListener('mousedown', (e) => { isDragging = true; pick(e); });
    window.addEventListener('mousemove', (e) => { if(isDragging) pick(e); });
    window.addEventListener('mouseup', () => isDragging = false);
  }
}

/* --- VISUALIZER ENGINE --- */
class Visualizer {
  constructor(canvasId) {
    this.canvas = document.getElementById(canvasId);
    this.ctx = this.canvas.getContext('2d');
    this.active = false;
    this.color = '#7b2cbf';
    // High DPI Scale
    this.canvas.width = 440; 
    this.canvas.height = 440; 
  }

  setSource(audioEl) {
    if(this.source) return;
    try {
      const AC = window.AudioContext || window.webkitAudioContext;
      this.audioCtx = new AC();
      this.analyser = this.audioCtx.createAnalyser();
      this.source = this.audioCtx.createMediaElementSource(audioEl);
      this.source.connect(this.analyser);
      this.analyser.connect(this.audioCtx.destination);
      this.analyser.fftSize = 128;
      this.data = new Uint8Array(this.analyser.frequencyBinCount);
      this.active = true;
      this.loop();
    } catch(e) { console.log("Audio Init", e); }
  }

  loop() {
    if(!this.active) return;
    requestAnimationFrame(this.loop.bind(this));
    this.analyser.getByteFrequencyData(this.data);
    
    const ctx = this.ctx;
    const w = this.canvas.width;
    const h = this.canvas.height;
    const cx = w/2; const cy = h/2;
    const r = 120; // Base radius

    ctx.clearRect(0,0,w,h);
    ctx.beginPath();
    
    const bars = 40;
    const step = (Math.PI*2)/bars;

    for(let i=0; i<bars; i++) {
      const v = this.data[i];
      const len = (v/255) * 80;
      const angle = i * step;
      
      const x1 = cx + Math.cos(angle) * r;
      const y1 = cy + Math.sin(angle) * r;
      const x2 = cx + Math.cos(angle) * (r + len);
      const y2 = cy + Math.sin(angle) * (r + len);
      
      ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
    }
    
    ctx.strokeStyle = this.color;
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    ctx.shadowBlur = 20;
    ctx.shadowColor = this.color;
    ctx.stroke();
    ctx.shadowBlur = 0;
  }
}

/* --- MAIN APP --- */
class App {
  constructor() {
    this.state = {
      color: '#7b2cbf',
      files: {}
    };
    
    // Components
    this.vis = new Visualizer('vis-canvas');
    this.colorPicker = new ColorEngine('spectrum-canvas', (hex) => this.setColor(hex));
    
    this.init();
    this.setupInteractions();
    this.setupUploaders();
  }

  async init() {
    const { data: { user } } = await sb.auth.getUser();
    if(!user) return window.location.href = '/login';
    
    this.user = user;
    const { data } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();
    if(data) this.populate(data);
  }

  populate(d) {
    // Identity
    document.getElementById('ui-username').innerText = d.username;
    document.getElementById('ui-bio').innerText = d.bio || "System status: online.";
    document.getElementById('inp-bio').value = d.bio || "";
    document.getElementById('ui-avatar').src = d.avatar || CONFIG.defaults.avatar;
    
    // Theme
    this.setColor(d.theme_color || '#7b2cbf');
    document.getElementById('inp-vis-enable').checked = d.visualizer_enabled;
    
    // Media
    this.renderMedia('banner-container', d.banner_url || CONFIG.defaults.banner, '100%');
    
    // Background
    if(d.bg_value) {
      this.renderMedia('bg-container', d.bg_value, '100%', 'bg-preview-layer');
    }
  }

  setColor(hex) {
    this.state.color = hex;
    document.documentElement.style.setProperty('--accent', hex);
    document.documentElement.style.setProperty('--accent-glow', hex + '66');
    document.getElementById('color-dot').style.background = hex;
    this.vis.color = hex;
  }

  renderMedia(containerId, url, size, className='') {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    const isVid = url.match(/\.(mp4|webm)$/) || (this.state.files.bg && this.state.files.bg.type.startsWith('video'));
    
    if(isVid) {
      c.innerHTML = `<video src="${url}" autoplay muted loop playsinline class="${className}" style="width:100%;height:100%;object-fit:cover"></video>`;
    } else {
      c.innerHTML = `<img src="${url}" class="${className}" style="width:100%;height:100%;object-fit:cover">`;
    }
  }

  setupInteractions() {
    // Tilt Effect
    const stage = document.getElementById('tilt-stage');
    const card = document.getElementById('card-3d');
    stage.addEventListener('mousemove', (e) => {
      const w = window.innerWidth;
      const h = window.innerHeight;
      const x = (e.clientX - w/2) / w * 20;
      const y = (e.clientY - h/2) / h * -20;
      card.style.transform = `rotateX(${y}deg) rotateY(${x}deg)`;
    });

    // Bio Live Type
    document.getElementById('inp-bio').addEventListener('input', (e) => {
      document.getElementById('ui-bio').innerText = e.target.value;
    });

    // Audio Test
    document.getElementById('btn-audio-test').addEventListener('click', () => {
      const aud = document.getElementById('demo-audio');
      if(aud.paused) {
        aud.play();
        this.vis.setSource(aud);
      } else {
        aud.pause();
      }
    });

    // Save
    document.getElementById('btn-save').addEventListener('click', () => this.save());
  }

  setupUploaders() {
    const setup = (id, fileId, key) => {
      const zone = document.getElementById(id);
      const inp = document.getElementById(fileId);
      
      zone.addEventListener('click', () => inp.click());
      zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'););
      zone.addEventListener('drop', (e) => {
        e.preventDefault(); zone.classList.remove('drag-over');
        this.handleFile(e.dataTransfer.files[0], key);
      });
      inp.addEventListener('change', (e) => this.handleFile(e.target.files[0], key));
    };

    setup('dz-avatar', 'file-avatar', 'avatar');
    setup('dz-banner', 'file-banner', 'banner');
    setup('dz-bg', 'file-bg', 'bg');
  }

  handleFile(file, key) {
    if(!file) return;
    this.state.files[key] = file;
    const url = URL.createObjectURL(file);
    
    // Live Preview Logic
    if(key === 'avatar') document.getElementById('ui-avatar').src = url;
    if(key === 'banner') this.renderMedia('banner-container', url);
    if(key === 'bg') this.renderMedia('bg-container', url, '100%', 'bg-preview-layer');
    
    // Update Drop Zone UI
    const zone = document.getElementById(`dz-${key}`);
    zone.innerHTML = `<i class="ph-bold ph-check" style="color:var(--accent)"></i><span>${file.name.substring(0,15)}...</span>`;
    zone.style.borderColor = 'var(--accent)';
  }

  async save() {
    const btn = document.getElementById('btn-save');
    const loader = btn.querySelector('.loader');
    const span = btn.querySelector('span');
    
    span.style.display = 'none';
    loader.style.display = 'block';

    try {
      const updates = {
        updated_at: new Date(),
        bio: document.getElementById('inp-bio').value,
        theme_color: this.state.color,
        visualizer_enabled: document.getElementById('inp-vis-enable').checked
      };

      // Helper to upload
      const upload = async (file, bucket) => {
        const ext = file.name.split('.').pop();
        const path = `${this.user.id}/${Date.now()}.${ext}`;
        await sb.storage.from(bucket).upload(path, file);
        return sb.storage.from(bucket).getPublicUrl(path).data.publicUrl;
      };

      if(this.state.files.avatar) updates.avatar = await upload(this.state.files.avatar, 'avatars');
      if(this.state.files.banner) updates.banner_url = await upload(this.state.files.banner, 'banners');
      if(this.state.files.bg) {
        updates.bg_value = await upload(this.state.files.bg, 'backgrounds');
        updates.bg_type = this.state.files.bg.type.startsWith('video') ? 'video' : 'image';
      }

      await sb.from("profiles").upsert({ id: this.user.id, ...updates });
      
      span.innerText = "SAVED";
    } catch(e) {
      alert("Error: " + e.message);
      span.innerText = "ERROR";
    } finally {
      loader.style.display = 'none';
      span.style.display = 'block';
      setTimeout(() => span.innerText = "Save Configuration", 2000);
    }
  }
}

document.addEventListener('DOMContentLoaded', () => new App());

</script>
</body>
</html>

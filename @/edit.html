<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>/six - Edit Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<!-- EXTERNAL LIBRARIES -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<!-- FONTS -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel:wght@700&family=Orbitron:wght@700&family=Playfair+Display:wght@700&family=UnifrakturMaguntia&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
/* ======================= 1. CORE VARIABLES & RESET ======================= */
:root {
  --c-bg: #050505;
  --c-surface: #0a0a0a;
  --c-surface-hover: #111111;
  
  /* Dynamic Theme Variables */
  --c-accent: #7b2cbf;
  --c-accent-dark: #4a127a;
  --c-accent-glow: rgba(123, 44, 191, 0.4);
  
  --c-text-main: #ffffff;
  --c-text-sec: #888888;
  
  --border-light: rgba(255, 255, 255, 0.08);
  --border-hover: rgba(255, 255, 255, 0.15);
  
  --radius-xl: 32px;
  --radius-lg: 16px;
  --radius-sm: 8px;
  
  --font-main: 'Inter', sans-serif;
  --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Custom Font Declaration */
@font-face { font-family: 'Diecide Remain'; src: url('fonts/DeicideRemain.otf') format('opentype'); font-display: swap; }

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  background-color: var(--c-bg);
  color: var(--c-text-main);
  font-family: var(--font-main);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  padding: 40px 20px;
  overflow-x: hidden;
}

/* Texture Overlay */
body::after {
  content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 999;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhZWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==');
  opacity: 0.04;
}

/* ======================= 2. BACKGROUND ANIMATION ======================= */
.bg-fixed { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }

.bg-blob {
  position: absolute; border-radius: 50%; 
  filter: blur(100px); opacity: 0.4;
  will-change: transform; 
}

.bg-blob.one { 
  top: -20%; left: -10%; width: 60vw; height: 60vw; 
  background: radial-gradient(circle, var(--c-accent-dark) 0%, transparent 60%); 
  animation: float 25s infinite alternate ease-in-out;
}
.bg-blob.two { 
  bottom: -20%; right: -10%; width: 70vw; height: 70vw; 
  background: radial-gradient(circle, #1a0b2e 0%, transparent 60%); 
  animation: float 30s infinite alternate-reverse ease-in-out;
}

@keyframes float { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(50px, 30px, 0); } }

/* ======================= 3. MAIN LAYOUT ======================= */
.container {
  position: relative; z-index: 10;
  width: 100%; max-width: 600px;
  display: flex; flex-direction: column; gap: 24px;
}

/* --- SECTION: HEADER / PREVIEW --- */
.header-card {
  position: relative;
  background: rgba(10, 10, 10, 0.6);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xl);
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.banner-wrapper {
  width: 100%; height: 220px;
  background: #000;
  position: relative; cursor: pointer;
  overflow: hidden;
  group: hover;
}
.banner-display { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: transform 0.5s ease; }
.banner-wrapper:hover .banner-display { transform: scale(1.02); opacity: 0.6; }

/* Edit Overlay for Banner */
.banner-edit-overlay {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  gap: 8px;
  opacity: 0; transition: 0.3s;
  background: rgba(0,0,0,0.3);
}
.banner-wrapper:hover .banner-edit-overlay { opacity: 1; }
.edit-badge {
  padding: 8px 16px; background: rgba(0,0,0,0.7); 
  border-radius: 20px; font-size: 0.75rem; font-weight: 600; 
  backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
  display: flex; align-items: center; gap: 6px;
}

.profile-bar {
  padding: 0 24px 24px 24px;
  display: flex; align-items: flex-end; justify-content: space-between;
  margin-top: -50px; position: relative; z-index: 2;
}

.avatar-wrapper {
  width: 110px; height: 110px;
  border-radius: 50%;
  padding: 4px;
  background: #000; /* Matches body bg to look like cutout */
  position: relative; cursor: pointer;
  transition: transform 0.3s var(--ease-spring);
}
.avatar-wrapper:hover { transform: scale(1.05); }
.avatar-display {
  width: 100%; height: 100%; border-radius: 50%;
  object-fit: cover; background: #151515;
  border: 2px solid var(--border-light);
}
.avatar-edit-icon {
  position: absolute; inset: 0; 
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.5); border-radius: 50%;
  opacity: 0; transition: 0.2s; font-size: 24px;
}
.avatar-wrapper:hover .avatar-edit-icon { opacity: 1; }

/* --- SECTION: SETTINGS --- */
.settings-group {
  display: flex; flex-direction: column; gap: 16px;
  animation: slideUp 0.6s 0.1s var(--ease-spring) backwards;
}

@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.card-panel {
  background: rgba(15, 15, 15, 0.4);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: border-color 0.2s;
}
.card-panel:hover { border-color: var(--border-hover); }

.section-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px;
}
.section-label {
  font-size: 0.75rem; font-weight: 700; 
  text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--c-text-sec); display: flex; align-items: center; gap: 8px;
}
.section-label i { color: var(--c-accent); font-size: 1rem; }

/* Inputs */
.input-wrap { position: relative; }
textarea {
  width: 100%; min-height: 100px; padding: 16px;
  background: rgba(0,0,0,0.2); border: 1px solid var(--border-light);
  border-radius: var(--radius-sm); color: #fff;
  font-family: inherit; font-size: 0.95rem; resize: none;
  transition: 0.2s;
}
textarea:focus { border-color: var(--c-accent); background: rgba(0,0,0,0.4); }
textarea::placeholder { color: #444; }

/* Typography Select (New Trigger) */
.font-trigger-card {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px; background: rgba(255,255,255,0.02);
  border: 1px solid var(--border-light); border-radius: var(--radius-sm);
}
.current-font-preview {
  font-size: 1.5rem; line-height: 1;
  background: linear-gradient(90deg, #fff, #aaa);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.change-font-btn {
  padding: 8px 16px; font-size: 0.8rem; font-weight: 600;
  background: rgba(255,255,255,0.05); border: 1px solid var(--border-light);
  border-radius: 20px; color: var(--c-text-main); cursor: pointer;
  transition: 0.2s;
}
.change-font-btn:hover { background: var(--c-accent); border-color: var(--c-accent); }

/* Color & Aesthetic */
.split-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

.aesthetic-card {
  display: flex; align-items: center; gap: 12px;
  padding: 12px; border: 1px solid var(--border-light);
  border-radius: var(--radius-sm); background: rgba(255,255,255,0.01);
}
.color-swatch-display {
  width: 32px; height: 32px; border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.2);
  background: var(--c-accent); /* Updated via JS */
  box-shadow: 0 0 10px var(--c-accent-glow);
}
.aesthetic-info h4 { font-size: 0.85rem; font-weight: 500; margin-bottom: 2px; }
.aesthetic-info p { font-size: 0.65rem; color: var(--c-text-sec); }

/* Hidden input hack for color picker */
.color-input-wrapper { position: relative; overflow: hidden; width: 0; height: 0; }

/* Background Upload */
.bg-upload-zone {
  position: relative; height: 120px;
  border: 1px dashed var(--border-light);
  border-radius: var(--radius-sm);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 8px; cursor: pointer; transition: 0.3s; overflow: hidden;
  background: radial-gradient(circle at center, rgba(255,255,255,0.03), transparent 70%);
}
.bg-upload-zone:hover { border-color: var(--c-text-sec); background: rgba(255,255,255,0.02); }
.bg-upload-zone.drag-active { border-color: var(--c-accent); background: rgba(123,44,191,0.1); }
#mini-bg-preview { 
  position: absolute; inset: 0; width: 100%; height: 100%; 
  opacity: 0.3; object-fit: cover; pointer-events: none; filter: grayscale(0.5);
}

/* Roles */
.roles-grid { display: flex; flex-wrap: wrap; gap: 8px; }
.role-badge {
  padding: 8px 14px; background: rgba(255,255,255,0.03);
  border: 1px solid var(--border-light); border-radius: 6px;
  font-size: 0.75rem; color: var(--c-text-sec); cursor: pointer;
  display: flex; align-items: center; gap: 6px; transition: 0.2s;
  user-select: none;
}
.role-badge i { font-size: 1rem; }
.role-badge:hover { background: rgba(255,255,255,0.07); transform: translateY(-1px); }
.role-badge.active {
  background: var(--c-accent); border-color: var(--c-accent); color: #fff;
  box-shadow: 0 4px 12px var(--c-accent-glow);
}

/* Save Button */
.save-btn {
  margin-top: 8px; width: 100%; padding: 20px;
  background: linear-gradient(135deg, var(--c-accent-dark), var(--c-accent));
  border: none; border-radius: var(--radius-lg);
  color: #fff; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;
  cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.save-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px var(--c-accent-glow); }
.save-btn:disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

/* Loader */
.loader { 
  width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); 
  border-top-color: #fff; border-radius: 50%; 
  animation: spin 0.8s linear infinite; display: none; 
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- MODAL SYSTEM --- */
.modal-overlay {
  position: fixed; inset: 0; z-index: 5000;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
}
.modal-overlay.active { opacity: 1; pointer-events: auto; }

.modal-card {
  width: 100%; max-width: 480px;
  background: #0a0a0a; border: 1px solid var(--border-light);
  border-radius: 24px; padding: 0;
  box-shadow: 0 40px 100px rgba(0,0,0,0.8);
  display: flex; flex-direction: column;
  max-height: 85vh;
  transform: scale(0.95); transition: transform 0.3s var(--ease-spring);
}
.modal-overlay.active .modal-card { transform: scale(1); }

.modal-header {
  padding: 20px; border-bottom: 1px solid var(--border-light);
  display: flex; justify-content: space-between; align-items: center;
}
.modal-title { font-weight: 700; font-size: 1rem; color: #fff; }
.modal-close {
  background: transparent; border: none; color: var(--c-text-sec);
  font-size: 1.2rem; cursor: pointer; padding: 5px;
}
.modal-close:hover { color: #fff; }

.modal-content { padding: 20px; overflow-y: auto; }

/* Font Grid (Moved Inside Modal) */
.font-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.font-option {
  position: relative; padding: 20px 10px;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  text-align: center; cursor: pointer; transition: 0.2s;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.font-option:hover { background: rgba(255,255,255,0.06); transform: translateY(-2px); }
.font-option.active {
  background: rgba(123, 44, 191, 0.15); border-color: var(--c-accent);
}
.font-preview { font-size: 1.3rem; margin-bottom: 6px; color: #fff; }
.font-name { font-size: 0.6rem; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: 1px; }

/* Font Import (Specific Style) */
.font-import { border: 1px dashed var(--border-light); background: transparent; }
.font-import:hover { border-color: var(--c-accent); background: rgba(123,44,191,0.05); }

/* Import Font Uploader (Dynamic content) */
.modal-buffer { padding: 40px; text-align: center; }
.file-drop-box { 
  border: 2px dashed var(--border-light); padding: 40px; text-align: center;
  border-radius: var(--radius-lg); cursor: pointer; transition: 0.2s;
}
.file-drop-box:hover { border-color: var(--c-text-dim); }
.font-preview-live { font-size: 32px; font-weight: 700; margin-bottom: 10px; }

/* Toast */
.toast {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
  background: #111; border: 1px solid var(--border-light); padding: 12px 24px;
  border-radius: 50px; display: flex; align-items: center; gap: 10px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.8); opacity: 0; transition: all 0.5s var(--ease-spring);
  z-index: 6000; pointer-events: none;
}
.toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast i { font-size: 1.2rem; }
.toast.success i { color: #4ade80; }
.toast.error i { color: #ef4444; }

.hidden { display: none !important; }

/* Responsive */
@media (max-width: 480px) {
  .banner-wrapper { height: 160px; }
  .profile-bar { padding: 0 16px 16px 16px; margin-top: -40px; }
  .avatar-wrapper { width: 90px; height: 90px; }
  .font-grid { grid-template-columns: 1fr; }
}
  /* ================= USERNAME EFFECTS ================= */

.effect-card {
  padding: 16px;
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: 0.2s;
  text-align: center;
}

.effect-card:hover {
  background: rgba(255,255,255,0.07);
  transform: translateY(-2px);
}

.effect-card.active {
  background: rgba(123,44,191,0.15);
  border-color: var(--c-accent);
  box-shadow: 0 0 20px var(--c-accent-glow);
}

.effect-preview {
  font-size: 1.6rem;
  font-weight: 700;
}

/* previews */
.preview-glow {
  text-shadow: 0 0 15px var(--c-accent-glow);
}

.preview-rgb {
  animation: rgbShift 3s linear infinite;
}

@keyframes rgbShift {
  0% { text-shadow: 0 0 10px #ff3c3c; }
  33% { text-shadow: 0 0 10px #3cffb3; }
  66% { text-shadow: 0 0 10px #3c7bff; }
  100% { text-shadow: 0 0 10px #ff3c3c; }
}

.preview-gradient {
  background: linear-gradient(90deg, #7dd3fc, #c084fc, #f472b6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
/* Toggle Switch Container */
.toggle-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px; cursor: pointer; transition: 0.2s;
}
.toggle-row:hover { background: rgba(255,255,255,0.06); }

.toggle-label { display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 14px; }
.toggle-label i { color: var(--c-accent); font-size: 18px; }

/* The Switch */
.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }

.slider {
  position: absolute; cursor: pointer; inset: 0;
  background-color: #333; transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px;
  left: 3px; bottom: 3px; background-color: white;
  transition: .4s; border-radius: 50%;
}

/* Checked State */
input:checked + .slider { background-color: var(--c-accent); box-shadow: 0 0 10px var(--c-accent-glow); }
input:checked + .slider:before { transform: translateX(20px); }

.input-hint { font-size: 12px; color: #888; margin-top: 6px; margin-left: 4px; }
</style>
</head>
<body>

<div class="bg-fixed">
  <div class="bg-blob one"></div>
  <div class="bg-blob two"></div>
</div>

<div class="container">
  
  <!-- VISUAL IDENTITY HEADER -->
  <div class="header-card">
    <div class="banner-wrapper" id="drop-banner">
      <img id="prev-banner-img" class="banner-display" src="">
      <video id="prev-banner-video" class="banner-display hidden" autoplay muted loop playsinline></video>
      <input type="file" id="file-banner" hidden accept="image/*,video/mp4,video/webm">
      
      <div class="banner-edit-overlay">
        <div class="edit-badge"><i class="ph-bold ph-pencil-simple"></i> Edit Banner</div>
      </div>
    </div>

    <div class="profile-bar">
      <div class="avatar-wrapper" id="drop-avatar">
        <img id="prev-avatar" class="avatar-display" src="">
        <div class="avatar-edit-icon"><i class="ph-bold ph-camera"></i></div>
        <input type="file" id="file-avatar" hidden accept="image/*">
      </div>
      <!-- Decorative Profile Actions (Non-functional, for aesthetic balance) -->
      <div style="display:flex; gap:8px;">
        <!-- Placeholder for potential future links -->
      </div>
    </div>
  </div>

  <!-- CONTROL CENTER -->
  <div class="settings-group">
    
    <!-- BIO SECTION -->
    <div class="card-panel">
      <div class="section-header">
        <div class="section-label"><i class="ph-bold ph-user-focus"></i> Biography</div>
      </div>
      <div class="input-wrap">
        <textarea id="in-bio" placeholder="Tell the world who you are..."></textarea>
      </div>
    </div>

    <!-- TYPOGRAPHY SECTION (Replaced Grid with Trigger) -->
    <div class="card-panel">
      <div class="section-header">
        <div class="section-label"><i class="ph-bold ph-text-aa"></i> Typography</div>
      </div>
      <!-- USERNAME EFFECT -->
<div class="card-panel">
  <div class="section-header">
    <div class="section-label">
      <i class="ph-bold ph-sparkle"></i> Username Effect
    </div>
  </div>

  <div class="font-trigger-card">
    <div class="current-font-preview" id="effect-preview-label">
      /six
    </div>
    <button type="button" class="change-font-btn" id="btn-open-effect-modal">
      Change Effect
    </button>
  </div>

  <input type="hidden" id="in-username-effect" value="none">
</div>

      <div class="font-trigger-card">
        <div class="current-font-preview" id="font-preview-label" style="font-family: 'Cinzel', serif;">
          /six
        </div>
        <button type="button" class="change-font-btn" id="btn-open-font-modal">Change Font</button>
      </div>
      <!-- Hidden Input for Logic -->
      <input type="hidden" id="in-font" value="Cinzel">
    </div>

    <!-- AESTHETICS SECTION -->
    <div class="card-panel">
      <div class="section-header">
        <div class="section-label"><i class="ph-bold ph-palette"></i> Aesthetics</div>
      </div>
      
      <div class="split-row">
        <!-- Color Picker Trigger -->
        <label class="aesthetic-card" style="cursor: pointer;">
          <div class="color-swatch-display" id="theme-swatch"></div>
          <div class="aesthetic-info">
            <h4>Accent Color</h4>
            <p>UI & Glows</p>
          </div>
          <div class="color-input-wrapper">
            <input type="color" id="in-theme-color" value="#7b2cbf">
          </div>
        </label>

        <!-- Profile Background -->
        <div class="bg-upload-zone" id="drop-bg">
          <i class="ph ph-image" style="font-size: 24px; color: var(--c-text-sec);"></i>
          <span id="bg-filename" style="font-size: 0.75rem; color: var(--c-text-sec);">Profile BG</span>
          <input type="file" id="file-bg" accept="image/*,video/mp4,video/webm" hidden>
          <div id="mini-bg-preview"></div>
        </div>
        <div class="form-group">
  <label class="toggle-row">
    <span class="toggle-label">
      <i class="ph-bold ph-shield-star"></i> Show Rank Icon
    </span>
    <label class="switch">
      <input type="checkbox" id="input-show-role">
      <span class="slider round"></span>
    </label>
  </label>
  <p class="input-hint">Enable to display your highest rank next to your username.</p>
</div>
      </div>
    </div>
   
    <!-- SAVE BUTTON -->
    <button id="save-btn" class="save-btn">
      <div class="loader"></div>
      <span class="btn-text">Save Changes</span>
    </button>
  </div>

</div>

<!-- TOAST -->
<div id="toast" class="toast">
  <i class="ph-bold" id="toast-icon"></i>
  <span id="toast-msg">Notification</span>
</div>

<!-- FONT MODAL (Restructured) -->
<div class="modal-overlay" id="font-modal">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">Select Typography</span>
      <button class="modal-close" id="btn-close-font-modal"><i class="ph-bold ph-x"></i></button>
    </div>
    
    <div class="modal-content" id="font-modal-card">
      <!-- The JS will look for #font-grid to render items. We place it here. -->
      <div class="font-grid" id="font-grid">
        <!-- Items injected by JS -->
        <div class="font-option font-import" id="import-font">
          <i class="ph-bold ph-upload-simple" style="font-size: 24px; margin-bottom: 4px;"></i>
          <div class="font-name">Custom Import</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- USERNAME EFFECT MODAL -->
<div class="modal-overlay" id="effect-modal">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">Username Effects</span>
      <button class="modal-close" id="btn-close-effect-modal">
        <i class="ph-bold ph-x"></i>
      </button>
    </div>

    <div class="modal-content">
      <div class="font-grid" id="effect-grid"></div>
    </div>
  </div>
</div>

<script>
// --- CONFIGURATION ---
const CONFIG = {
  supabaseUrl: "https://tstsijdifhgmpaszqknr.supabase.co", 
  supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4",
  defaultAvatar: "https://cdn.discordapp.com/embed/avatars/0.png",
  defaultBanner: "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3R6cW55eGZ6eGZ6eGZ6eGZ6eGZ6eGZ6eGZ6eGZ6eGZ6eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/26BRy67X26yX1eLhm/giphy.gif",
  fonts: [
    { id: 'Diecide Remain', label: 'Signature', family: "'Diecide Remain', serif", featured: true },
    { id: 'Cinzel', label: 'Cinzel', family: "'Cinzel', serif" },
    { id: 'Orbitron', label: 'Cyber', family: "'Orbitron', sans-serif" },
    { id: 'UnifrakturMaguntia', label: 'Gothic', family: "'UnifrakturMaguntia', cursive" },
    { id: 'Playfair Display', label: 'Classy', family: "'Playfair Display', serif" },
    { id: 'Roboto Mono', label: 'Code', family: "'Roboto Mono', monospace" },
  ],
  effects: [
  { id: 'none', label: 'None' },
  { id: 'glow', label: 'Glow' },
  { id: 'rgb', label: 'RGB' },
  { id: 'gradient', label: 'Gradient' }
]

};
 
let currentUsername = '/six';

const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
let currentProfileId = null;
const staging = { avatar: null, banner: null, background: null };
const fontBufferHTML = `
  <div class="modal-buffer">
    <div class="loader" style="display:block; margin:0 auto;"></div>
    <div class="buffer-text" style="margin-top:10px; color:#888;">Preparing font importerâ€¦</div>
  </div>
`;
const fontImporterHTML = `
  <div class="modal-buffer">
    <div class="font-preview-live" id="font-preview">
      ${escapeHtml(currentUsername)}
    </div>
    <div class="file-drop-box" id="drop-font">
      <i class="ph ph-file-arrow-up" style="font-size:32px; color:#888;"></i>
      <div style="margin-top:10px; color:#888;">Drop font file (TTF/OTF)</div>
      <input type="file" id="file-font" hidden>
    </div>
    <button class="save-btn" id="confirm-font" style="margin-top:20px;">
      <span class="btn-text">Use This Font</span>
    </button>
  </div>
`;

// Elements
const els = {
  dropBanner: document.getElementById('drop-banner'),
  dropAvatar: document.getElementById('drop-avatar'),
  dropBg: document.getElementById('drop-bg'),
  fileBanner: document.getElementById('file-banner'),
  fileAvatar: document.getElementById('file-avatar'),
  fileBg: document.getElementById('file-bg'),
  prevBannerImg: document.getElementById('prev-banner-img'),
  prevBannerVid: document.getElementById('prev-banner-video'),
  prevAvatar: document.getElementById('prev-avatar'),
  miniBgPreview: document.getElementById('mini-bg-preview'),
  bio: document.getElementById('in-bio'),
  color: document.getElementById('in-theme-color'),
  themeSwatch: document.getElementById('theme-swatch'),
  fontGrid: document.getElementById('font-grid'),
  fontInput: document.getElementById('in-font'),
  fontPreviewLabel: document.getElementById('font-preview-label'), // New Element
  btn: document.getElementById('save-btn'),
  loader: document.querySelector('.loader'),
  btnText: document.querySelector('.btn-text'),
  // Modal Elements
  fontModal: document.getElementById('font-modal'),
  btnOpenFont: document.getElementById('btn-open-font-modal'),
  btnCloseFont: document.getElementById('btn-close-font-modal')
};

/* ================= LOGIC ================= */

(async function init() {
  setLoading(true, "Loading Profile...");
  const { data: { user } } = await sb.auth.getUser();
  if (!user) return showToast("Login required", "error");

  const { data } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();
  if (data) {
    currentProfileId = data.id;
    populateUI(data);
  } else {
    currentProfileId = user.id;
    els.prevAvatar.src = CONFIG.defaultAvatar;
    els.prevBannerImg.src = CONFIG.defaultBanner;
    renderFonts('Cinzel');
  }

const roleInput = document.getElementById('input-show-role');
if(roleInput) {
    roleInput.checked = profile.show_role_icon !== false; 
}
  setupInteractions();
  setLoading(false);
})();

function populateUI(data) {
  els.bio.value = data.bio || "";
  els.color.value = data.theme_color || "#7b2cbf";
  updateThemeEngine(els.color.value);

  // Images
  els.prevAvatar.src = data.avatar || CONFIG.defaultAvatar;
  if (data.banner_url && data.banner_url.match(/\.(mp4|webm)$/)) {
    els.prevBannerImg.classList.add('hidden');
    els.prevBannerVid.classList.remove('hidden');
    els.prevBannerVid.src = data.banner_url;
  } else {
    els.prevBannerImg.src = data.banner_url || CONFIG.defaultBanner;
  }

  // Background Preview
  if (data.bg_value) {
    els.miniBgPreview.innerHTML = data.bg_type === 'video' 
      ? `<video src="${data.bg_value}" autoplay muted loop style="width:100%;height:100%;object-fit:cover"></video>` 
      : `<img src="${data.bg_value}" style="width:100%;height:100%;object-fit:cover">`;
  }

  // Fonts & Roles
  renderFonts(data.username_font || 'Cinzel');
}
function escapeHtml(str = '') {
  return str.replace(/[&<>"']/g, m => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[m]));
}
function renderFonts(activeId) {
  // Clear but keep the Import button logic
  els.fontGrid.innerHTML = ''; 
  
  // Re-add import button functionality requires structure; 
  // We'll rebuild the grid entirely based on CONFIG
  
  // Update the hidden input and visual label
  els.fontInput.value = activeId;
  const activeFontObj = CONFIG.fonts.find(f => f.id === activeId);
  if (activeFontObj) {
    els.fontPreviewLabel.style.fontFamily = activeFontObj.family;
  } else if (activeId === 'custom') {
    els.fontPreviewLabel.style.fontFamily = 'PreviewFont, sans-serif'; // Fallback for custom
  }

  CONFIG.fonts.forEach(f => {
    const el = document.createElement('div');
    el.className = `font-option ${f.id === activeId ? 'active' : ''}`;
    el.innerHTML = `
      <div class="font-preview" style="font-family:${f.family}">Aa</div>
      <div class="font-name">${f.label}</div>
    `;
    el.onclick = () => {
      document.querySelectorAll('.font-option').forEach(d => d.classList.remove('active'));
      el.classList.add('active');
      els.fontInput.value = f.id;
      els.fontPreviewLabel.style.fontFamily = f.family;
    };
    els.fontGrid.appendChild(el);
  });
  
  // Append Import Button at the end
  const importBtn = document.createElement('div');
  importBtn.className = 'font-option font-import';
  importBtn.id = 'import-font';
  importBtn.innerHTML = `
      <i class="ph-bold ph-upload-simple" style="font-size: 20px; margin-bottom: 4px;"></i>
      <div class="font-name">Import</div>
  `;
  els.fontGrid.appendChild(importBtn);
}
function renderEffects(active) {
  const grid = document.getElementById('effect-grid');
  grid.innerHTML = '';

  CONFIG.effects.forEach(e => {
    const div = document.createElement('div');
    div.className = `effect-card ${e.id === active ? 'active' : ''}`;
    div.innerHTML = `
      <div class="effect-preview preview-${e.id}">
        ${escapeHtml(currentUsername)}
      </div>
      <div class="font-name">${e.label}</div>
    `;

    div.onclick = () => {
      document.querySelectorAll('.effect-card').forEach(c => c.classList.remove('active'));
      div.classList.add('active');
      document.getElementById('in-username-effect').value = e.id;
      document.getElementById('effect-preview-label').className = `current-font-preview preview-${e.id}`;
    };

    grid.appendChild(div);
  });
}

/* ================= INTERACTION ================= */

function setupInteractions() {
  els.color.addEventListener('input', (e) => updateThemeEngine(e.target.value));
document.getElementById('btn-open-effect-modal').onclick = () => {
  renderEffects(document.getElementById('in-username-effect').value);
  document.getElementById('effect-modal').classList.add('active');
};

document.getElementById('btn-close-effect-modal').onclick = () => {
  document.getElementById('effect-modal').classList.remove('active');
};

  // Drag & Drop Helpers
  const setupDD = (zone, input, cb) => {
    zone.onclick = () => input.click();
    input.onchange = () => handleFile(input.files[0], cb);
    zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('drag-active'); };
    zone.ondragleave = () => zone.classList.remove('drag-active');
    zone.ondrop = (e) => {
      e.preventDefault(); zone.classList.remove('drag-active');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], cb);
    };
  };

  setupDD(els.dropBanner, els.fileBanner, (f, url) => {
    staging.banner = f;
    if (f.type.startsWith('video')) {
       els.prevBannerImg.classList.add('hidden');
       els.prevBannerVid.classList.remove('hidden');
       els.prevBannerVid.src = url;
    } else {
       els.prevBannerVid.classList.add('hidden');
       els.prevBannerImg.classList.remove('hidden');
       els.prevBannerImg.src = url;
    }
  });

  setupDD(els.dropAvatar, els.fileAvatar, (f, url) => {
    staging.avatar = f; els.prevAvatar.src = url;
  });

  setupDD(els.dropBg, els.fileBg, (f, url) => {
    staging.background = f;
    document.getElementById('bg-filename').innerText = f.name.substring(0, 15) + (f.name.length > 15 ? "..." : "");
    els.miniBgPreview.innerHTML = f.type.startsWith('video') 
      ? `<video src="${url}" autoplay muted loop style="width:100%;height:100%;object-fit:cover"></video>` 
      : `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
  });

  els.btn.addEventListener('click', saveProfile);
  
  // Font Modal Toggles
  els.btnOpenFont.addEventListener('click', () => {
    els.fontModal.classList.add('active');
  });
  els.btnCloseFont.addEventListener('click', () => {
    els.fontModal.classList.remove('active');
    // If user was in import mode, reset to grid on close? 
    // For now, simple close is fine.
  });
}

function handleFile(file, cb) {
  if (!file) return;
  if (file.size > 15 * 1024 * 1024) return showToast("File too large (Max 15MB)", "error");
  cb(file, URL.createObjectURL(file));
}

// Advanced Theme Engine
function updateThemeEngine(hex) {
  // Update CSS Vars
  document.documentElement.style.setProperty('--c-accent', hex);
  document.documentElement.style.setProperty('--c-accent-glow', hex + '66');
  
  // Update Visual Swatch
  if(els.themeSwatch) els.themeSwatch.style.background = hex;
  
  const darkHex = adjustBrightness(hex, -60); 
  document.documentElement.style.setProperty('--c-accent-dark', darkHex);
}

function adjustBrightness(col, amt) {
    var usePound = false;
    if (col[0] == "#") { col = col.slice(1); usePound = true; }
    var num = parseInt(col,16);
    var r = (num >> 16) + amt;
    var b = ((num >> 8) & 0x00FF) + amt;
    var g = (num & 0x0000FF) + amt;
    if (r > 255) r = 255; else if  (r < 0) r = 0;
    if (b > 255) b = 255; else if  (b < 0) b = 0;
    if (g > 255) g = 255; else if (g < 0) g = 0;
    return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
}

/* ================= SAVING ================= */

async function saveProfile() {
  if (!currentProfileId) return;
  setLoading(true, "Uploading...");
const showRole = document.getElementById('input-show-role').checked;
  try {
    const updates = {
      username_effect: document.getElementById('in-username-effect').value,
      updated_at: new Date(),
      bio: els.bio.value,
      theme_color: els.color.value,
      username_font: els.fontInput.value,
      show_role_icon: showRole, 
      updated_at: new Date(),
    };

    if (staging.avatar) updates.avatar = await upload(staging.avatar, 'avatars');
    if (staging.banner) updates.banner_url = await upload(staging.banner, 'banners');
    if (staging.background) {
      updates.bg_value = await upload(staging.background, 'backgrounds');
      updates.bg_type = staging.background.type.startsWith('video') ? 'video' : 'image';
    }
    if (staging.customFont) {
      updates.custom_font_url = await upload(staging.customFont, 'fonts');
      updates.username_font = 'custom';
    }

    const { error } = await sb.from("profiles").upsert({ id: currentProfileId, ...updates });
    if (error) throw new Error(error.message || "Upload failed");

    showToast("Profile Updated!", "success");
    staging.avatar = null; staging.banner = null; staging.background = null;
  } catch (err) {
    console.error(err);
    showToast(err.message, "error");
  }
  setLoading(false);
}

async function upload(file, bucket) {
  const ext = file.name.split('.').pop();
  const path = `${currentProfileId}/${Date.now()}.${ext}`;

  const { error } = await sb
    .storage
    .from(bucket)
    .upload(path, file, {
      upsert: true,
      contentType: file.type, 
      cacheControl: '3600'
    });

  if (error) {
    console.error('UPLOAD ERROR:', error);
    throw error;
  }

  const { data } = sb.storage.from(bucket).getPublicUrl(path);
  return data.publicUrl;
}


function setLoading(isLoading, text) {
  if(!text) text = "Save Changes";
  els.btn.disabled = isLoading;
  els.btnText.textContent = text;
  els.loader.style.display = isLoading ? "block" : "none";
}

function showToast(msg, type) {
  document.getElementById('toast-msg').innerText = msg;
  const t = document.getElementById('toast');
  t.className = `toast active ${type}`;
  document.getElementById('toast-icon').className = type === 'success' ? 'ph-bold ph-check-circle' : 'ph-bold ph-warning-circle';
  setTimeout(() => t.classList.remove('active'), 3500);
}

// ============ FONT IMPORT LOGIC (Preserved & Adapted) ============

function setupFontImporter() {
  const drop = document.getElementById('drop-font');
  const input = document.getElementById('file-font');
  const preview = document.getElementById('font-preview');

  if (!drop || !input || !preview) return;

  drop.onclick = () => input.click();

  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;

    const allowed = ['font/ttf','font/otf','font/woff','font/woff2','application/font-woff','application/font-woff2'];
    if (!allowed.includes(file.type) && !file.name.match(/\.(ttf|otf|woff2?)$/i)) {
      showToast("Unsupported font format", "error");
      return;
    }
    if (file.size > 2 * 1024 * 1024) {
      showToast("Font too large (max 2MB)", "error");
      return;
    }

    const url = URL.createObjectURL(file);
    const font = new FontFace('PreviewFont', `url(${url})`);

    font.load().then(() => {
      document.fonts.add(font);
      preview.style.fontFamily = 'PreviewFont';

      staging.customFont = file;
      els.fontInput.value = 'custom';
      
      // Update the main preview label too
      els.fontPreviewLabel.style.fontFamily = 'PreviewFont';
      showToast("Font loaded", "success");
    }).catch((e) => {
      console.error(e);
      showToast("Invalid font file", "error");
    });
  };
  
  // Handle Confirmation within Import Modal
  document.getElementById('confirm-font')?.addEventListener('click', () => {
     els.fontModal.classList.remove('active');
     // Re-render grid to show "Custom" state? 
     // For now, we rely on the main "Save" button to commit the file.
  });
}

document.addEventListener('click', (e) => {
  // Check if we clicked the Import card inside the modal
  if (!e.target.closest('#import-font')) return;
  
  // We are already inside the modal, so we just swap the content of modal-card
  const modalCard = document.getElementById('font-modal-card');
  modalCard.innerHTML = fontBufferHTML;

  setTimeout(() => {
    modalCard.innerHTML = fontImporterHTML;
    setupFontImporter();
  }, 500);
});

// Modal Overlay Click to Close
const modal = document.getElementById('font-modal');
modal.onclick = (e) => {
  if (e.target === modal) modal.classList.remove('active');
};

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>/six - Profile</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root {
  --primary: #7b2cbf;
  --primary-dark: #5a189a;
  --primary-light: rgba(123, 44, 191, 0.1);
  --secondary: #9d4edd;
  --text: #e8e6f3;
  --text-muted: #a1a1aa;
  --bg: #050006;
  --card-bg: rgba(20, 10, 30, 0.6);
  --border: rgba(255, 255, 255, 0.08);
  --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  overflow-x: hidden;
}

/* Background Effects */
.bg-glow {
  position: fixed;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(123, 44, 191, 0.15) 0%, transparent 70%);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: -1;
  pointer-events: none;
}

/* Profile Card */
.profile-card {
  width: 100%;
  max-width: 480px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 40px 30px;
  text-align: center;
  position: relative;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  animation: slideUp 0.6s ease-out;
}

/* --- EDIT BUTTON (New Addition) --- */
.edit-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  color: var(--text-muted);
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex; /* Hidden by default via JS if not owner */
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  z-index: 10;
}

.edit-btn:hover {
  background: rgba(123, 44, 191, 0.2);
  color: #fff;
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(123, 44, 191, 0.2);
}

/* Avatar */
.avatar-wrapper {
  position: relative;
  width: 110px;
  height: 110px;
  margin: 0 auto 20px;
}

.avatar-img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255,255,255,0.1);
  background: #1a1a1a;
  transition: var(--transition);
}

.avatar-wrapper:hover .avatar-img {
  border-color: var(--primary);
  box-shadow: 0 0 20px rgba(123, 44, 191, 0.3);
}

/* Text Info */
.user-name {
  font-size: 1.5rem;
  font-weight: 700;
  color: #fff;
  margin-bottom: 4px;
}

.user-tag {
  font-size: 0.9rem;
  color: var(--text-muted);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: color 0.2s;
}
.user-tag:hover { color: var(--primary); }
.user-tag i { font-size: 0.8rem; opacity: 0.7; }

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin: 25px 0;
  padding: 15px 0;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

.stat-box {
  padding: 5px;
}

.stat-val {
  font-size: 1.1rem;
  font-weight: 700;
  color: #fff;
  display: block;
}

.stat-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Badges */
.badges-section {
  text-align: left;
  margin-top: 20px;
}

.section-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 12px;
  display: block;
}

.badges-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.badge {
  width: 32px;
  height: 32px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: var(--transition);
}
.badge img { width: 20px; height: 20px; object-fit: contain; }

/* Tooltip for Badge */
.badge::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(-5px);
  background: #000;
  color: #fff;
  padding: 5px 10px;
  font-size: 10px;
  border-radius: 4px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: 0.2s;
  border: 1px solid #333;
}
.badge:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); }
.badge:hover::after { opacity: 1; transform: translateX(-50%) translateY(-10px); }

/* Buttons */
.logout-btn {
  margin-top: 30px;
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(239, 68, 68, 0.3);
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.logout-btn:hover {
  background: rgba(239, 68, 68, 0.2);
  box-shadow: 0 5px 20px rgba(239, 68, 68, 0.15);
}

/* Loading Overlay */
.loader-overlay {
  position: absolute;
  inset: 0;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 24px;
  z-index: 50;
  transition: opacity 0.5s;
}
.spinner {
  width: 40px; height: 40px;
  border: 3px solid rgba(255,255,255,0.1);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* Utility: Hidden class */
.hidden { display: none !important; }
</style>
</head>
<body>

<div class="bg-glow"></div>

<div class="profile-card">
  <!-- Loading State -->
  <div id="loader" class="loader-overlay">
    <div class="spinner"></div>
  </div>

  <!-- EDIT BUTTON (Positioned Top Right) -->
  <a id="edit-btn" href="#" class="edit-btn hidden" title="Edit Profile">
    <i class="fa-solid fa-pen"></i>
  </a>

  <!-- Avatar -->
  <div class="avatar-wrapper">
    <img id="avatar" class="avatar-img" src="https://cdn.discordapp.com/embed/avatars/0.png" alt="Avatar">
  </div>

  <!-- Info -->
  <h1 id="name" class="user-name">...</h1>
  <div class="user-tag" onclick="copyId()" title="Click to Copy ID">
    @<span id="username-display">...</span>
    <i class="fa-regular fa-copy"></i>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-box">
      <span class="stat-val">0</span>
      <span class="stat-label">Likes</span>
    </div>
    <div class="stat-box">
      <span class="stat-val">0</span>
      <span class="stat-label">Views</span>
    </div>
    <div class="stat-box">
      <span class="stat-val" id="join-date">-</span>
      <span class="stat-label">Joined</span>
    </div>
  </div>

  <!-- Badges -->
  <div class="badges-section">
    <span class="section-label">ACHIEVEMENTS / ROLES</span>
    <div id="badges-container" class="badges-container">
      <!-- Badges injected via JS -->
    </div>
  </div>

  <button onclick="logout()" class="logout-btn">
    <i class="fa-solid fa-power-off"></i> Logout
  </button>
</div>

<script>
// --- CONFIGURATION ---
const SUPABASE_URL = "https://tstsijdifhgmpaszqknr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdHNpamRpZmhnbXBhc3pxa25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzA1NTIsImV4cCI6MjA3ODU0NjU1Mn0.8AvcLNL-6PIlfw2FUeLcMC9atefZmZAyUQBOquGpVo4";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// DOM Elements
const els = {
  loader: document.getElementById('loader'),
  editBtn: document.getElementById('edit-btn'),
  avatar: document.getElementById('avatar'),
  name: document.getElementById('name'),
  username: document.getElementById('username-display'),
  joinDate: document.getElementById('join-date'),
  badges: document.getElementById('badges-container')
};

// --- LOGIC ---

async function initProfile() {
  // 1. Check Authentication
  const { data: { session } } = await sb.auth.getSession();
  
  // If not logged in, redirect to login page (adjust '/' to your login path)
  if (!session) {
    window.location.href = "/";
    return;
  }

  const currentUser = session.user;
  
  // 2. Determine who we are viewing
  // URL Pattern: /profile.html?username=abc OR /@abc
  let targetUsername = getUsernameFromUrl();
  let isOwnProfile = false;

  // If no username in URL, we view our own profile
  if (!targetUsername) {
    // We need to fetch our own username from DB because auth.user doesn't usually store the custom username
    const { data: myProfile } = await sb.from('profiles').select('username').eq('id', currentUser.id).single();
    if(myProfile) targetUsername = myProfile.username;
    isOwnProfile = true;
  } 

  console.log("Viewing:", targetUsername);

  // 3. Fetch Profile Data
  // We use 'maybeSingle()' so it doesn't throw a 406 error if not found
  const { data: profile, error } = await sb
    .from('profiles')
    .select('*')
    .eq('username', targetUsername)
    .maybeSingle();

  if (error || !profile) {
    alert("User not found!");
    els.loader.style.display = 'none';
    return;
  }

  // 4. Update UI
  renderProfile(profile);

  // 5. Check Ownership for Edit Button
  // If the fetched profile ID matches the logged-in user's ID
  if (profile.id === currentUser.id) {
    els.editBtn.classList.remove('hidden');
    // Set the link to the edit page
    els.editBtn.href = `/@${profile.username}/edit`; // Or "edit-profile.html"
  } else {
    els.editBtn.classList.add('hidden');
  }

  // Hide Loader
  setTimeout(() => {
    els.loader.style.opacity = '0';
    setTimeout(() => els.loader.style.display = 'none', 500);
  }, 500);
}

// --- HELPER FUNCTIONS ---

function renderProfile(data) {
  els.avatar.src = data.avatar || "https://cdn.discordapp.com/embed/avatars/0.png";
  els.name.textContent = data.display_name || data.username || "User"; // Handle display name if you have it
  els.username.textContent = data.username;
  
  // Format Date (e.g., "Oct 2023")
  const date = new Date(data.created_at || Date.now());
  els.joinDate.textContent = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

  // Render Roles/Badges
  els.badges.innerHTML = '';
  if (data.roles && Array.isArray(data.roles)) {
    data.roles.forEach(role => {
      const badge = createBadge(role);
      if(badge) els.badges.appendChild(badge);
    });
  } else {
    els.badges.innerHTML = '<span style="font-size:0.8rem; opacity:0.5; font-style:italic;">No badges yet.</span>';
  }
}

function createBadge(roleName) {
  // Map role names to Icons (You can use images or FontAwesome)
  const map = {
    'Founder': { icon: 'fa-crown', color: '#fbbf24' },
    'Admin': { icon: 'fa-shield-halved', color: '#ef4444' },
    'Verified': { icon: 'fa-check-circle', color: '#3b82f6' },
    'Member': { icon: 'fa-user', color: '#a1a1aa' }
  };

  const config = map[roleName] || { icon: 'fa-certificate', color: '#fff' };

  const div = document.createElement('div');
  div.className = 'badge';
  div.setAttribute('data-tooltip', roleName);
  div.innerHTML = `<i class="fa-solid ${config.icon}" style="color: ${config.color}"></i>`;
  
  return div;
}

function getUsernameFromUrl() {
  const path = window.location.pathname;
  // Handle /@username format
  if (path.includes('/@')) {
    const parts = path.split('/@');
    return parts[1] ? parts[1].split('/')[0] : null;
  }
  // Handle ?username= format
  const params = new URLSearchParams(window.location.search);
  return params.get('username');
}

function copyId() {
  const txt = els.username.textContent;
  navigator.clipboard.writeText(txt).then(() => {
    alert("Username copied: " + txt);
  });
}

async function logout() {
  await sb.auth.signOut();
  window.location.href = "/";
}

// Start
initProfile();
</script>

</body>
</html>

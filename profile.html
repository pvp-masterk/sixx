<!-- profile-app.html -->
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>/six ‚Äî Profiles</title>

<!-- Supabase JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/supabase.min.js"></script>

<style>
/* Minimal styles to match your theme; paste your existing theme CSS to integrate */
:root{
  --bg:#050006; --glass-bg: rgba(255,255,255,0.06);
  --accent1:#9d4edd; --accent2:#7b2cbf;
  --glass-border: rgba(255,255,255,0.12);
}
body{font-family:Inter, sans-serif;background:var(--bg);color:#e8e6f3;margin:0;min-height:100vh;}
.app-wrap{display:flex;min-height:100vh;}
/* Sidebar */
.sidebar{
  width:84px;
  padding:18px 12px;
  display:flex;flex-direction:column;gap:14px;
  background:linear-gradient(180deg, rgba(20,6,40,0.6), rgba(10,3,20,0.6));
  border-right:1px solid rgba(160,100,255,0.06);
  backdrop-filter: blur(8px);
}
.side-btn{
  width:60px;height:60px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;border:1px solid transparent;
  transition:all .18s;
  color:#fff;font-weight:700;
  background:rgba(255,255,255,0.02);
  box-shadow:0 6px 18px rgba(0,0,0,0.6);
}
.side-btn:hover{transform:translateY(-6px)}
.side-btn.active{
  box-shadow:0 10px 40px rgba(150,0,255,0.35), inset 0 -6px 40px rgba(120,0,255,0.12);
  background:linear-gradient(180deg,var(--accent1),var(--accent2));
  border-color: rgba(255,255,255,0.08);
}

/* Main area */
.main{
  flex:1;padding:36px;
}
.header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;
}
.card{
  background: linear-gradient(145deg, rgba(40,15,70,0.4), rgba(20,5,40,0.25));
  border:1px solid var(--glass-border); border-radius:16px;padding:18px;
  backdrop-filter: blur(8px) saturate(140%);
}
.profile-grid{display:flex;gap:22px;align-items:flex-start}
.avatar{
  width:132px;height:132px;border-radius:18px;overflow:hidden;border:2px solid rgba(180,120,255,0.35);
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.1)); display:flex;align-items:center;justify-content:center;
}
.avatar img{width:100%;height:100%;object-fit:cover}
.info{flex:1}
.h1{font-size:22px;color:var(--accent1);font-weight:800;margin-bottom:6px;}
.meta{color:#d9ccff;margin-bottom:12px;}

.form-row{display:flex;gap:10px;margin-top:8px}
.input{padding:10px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.03);color:#fff;flex:1}
.btn{padding:10px 16px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;cursor:pointer;font-weight:700}
.small{font-size:13px;color:#cdb7ff}
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:16px}
.ach-card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.center{display:flex;align-items:center;justify-content:center}
.notice{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);color:#d9ccff}
</style>
</head>
<body>
<div class="app-wrap">
  <!-- Sidebar (put on every page) -->
  <nav class="sidebar" id="sidebar">
    <div class="side-btn" data-href="/index.html" title="Home">üè†</div>
    <div class="side-btn" data-href="/achievements.html" title="Achievements">üèÜ</div>
    <div class="side-btn" data-href="/members.html" title="Members">üë•</div>
    <div style="flex:1"></div>
    <div class="side-btn" id="profileBtn" title="Profile">üôÇ</div>
  </nav>

  <main class="main">
    <div class="header">
      <div>
        <div style="font-weight:900;font-size:18px">/six ‚Äî Profiles</div>
        <div class="small">Sign in to edit your profile</div>
      </div>
      <div id="authArea" class="center">
        <button class="btn" id="btnSignIn">Sign In / Up</button>
      </div>
    </div>

    <div id="content">
      <div class="card">
        <div class="profile-grid">
          <div class="avatar" id="avatarWrap"><img id="avatarImg" src="https://i.imgur.com/8Km9tLL.png" alt="avatar"></div>
          <div class="info">
            <div class="h1" id="displayName">Guest</div>
            <div class="meta" id="usernameMeta">Not signed in</div>
            <div id="bio" class="small">No bio yet.</div>

            <div style="margin-top:12px" id="profileControls">
              <div class="form-row">
                <input id="displayNameInput" class="input" placeholder="Display name (editable)" />
                <input type="file" id="avatarFile" accept="image/*" />
                <button class="btn" id="saveProfileBtn">Save</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="height:18px"></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Achievements</div>
          <div class="small" id="xpCount">XP: 0</div>
        </div>
        <div id="achievementsArea" class="ach-grid">
          <div class="notice">Loading achievements‚Ä¶</div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* ---------- CONFIG (replace with your values) ---------- */
const SUPABASE_URL = 'https://YOUR-SUPABASE-URL.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- util helpers ---------- */
const $ = sel => document.querySelector(sel);
const $all = sel => Array.from(document.querySelectorAll(sel));

/* ---------- Sidebar link behavior (put the same snippet on every page) ---------- */
(function initSidebar(){
  const btns = $all('.side-btn');
  btns.forEach(b=>{
    b.addEventListener('click', ()=> {
      const href = b.dataset.href;
      if(href) location.href = href;
    });
  });
  // highlight active tab (simple)
  const path = location.pathname;
  btns.forEach(b=>{
    if(b.dataset.href && path.endsWith(b.dataset.href.replace('/', ''))) {
      b.classList.add('active');
    }
  });
})();

/* ---------- Auth UI ---------- */
const btnSignIn = $('#btnSignIn');
const authArea = $('#authArea');

async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  updateAuthUI(session);
  return session;
}
function updateAuthUI(session) {
  if (!session) {
    authArea.innerHTML = '<button class="btn" id="btnSignIn">Sign In / Up</button>';
    $('#btnSignIn').addEventListener('click', showSignInModal);
    $('#profileControls').style.display = 'none';
  } else {
    const user = session.user;
    authArea.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <span class="small">${user.email ?? user.user_metadata.full_name ?? user.id}</span>
        <button class="btn" id="btnSignOut">Sign out</button>
      </div>`;
    $('#btnSignOut').addEventListener('click', async ()=> {
      await supabase.auth.signOut();
      location.reload();
    });
    $('#profileControls').style.display = 'block';
  }
}

/* Quick modal-ish sign in (magic link) */
function showSignInModal(){
  const email = prompt('Enter your email for magic link sign-in:');
  if(!email) return;
  supabase.auth.signInWithOtp({ email })
    .then(r=> {
      if (r.error) alert('Sign-in error: ' + r.error.message);
      else alert('Magic link sent ‚Äî check your email.');
    });
}

/* ---------- Profile load + edit ---------- */
let currentProfile = null;
async function loadProfile() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    // show public placeholder
    $('#displayName').innerText = 'Guest';
    $('#usernameMeta').innerText = 'Not signed in';
    $('#bio').innerText = 'Sign in to create and edit your profile.';
    $('#avatarImg').src = 'https://i.imgur.com/8Km9tLL.png';
    $('#profileControls').style.display = 'none';
    return;
  }

  const userId = session.user.id;
  // fetch profile by user_id
  const { data, error } = await supabase.from('profiles').select('*').eq('user_id', userId).single();
  if (error && error.code !== 'PGRST116') {
    console.error(error);
  }

  if (data) {
    currentProfile = data;
    $('#displayName').innerText = data.display_name || data.username || session.user.email;
    $('#usernameMeta').innerText = data.username ? `@${data.username}` : session.user.email;
    $('#bio').innerText = data.bio || 'No bio yet.';
    $('#displayNameInput').value = data.display_name || '';
    if (data.avatar_path) {
      const { data: urlData } = await supabase.storage.from('avatars').getPublicUrl(data.avatar_path);
      $('#avatarImg').src = urlData.publicUrl;
    }
    $('#profileControls').style.display = 'block';
  } else {
    // create a basic profile if none exists
    const usernameGuess = session.user.email?.split('@')[0] || session.user.id.slice(0,6);
    const insert = {
      user_id: session.user.id,
      username: usernameGuess,
      display_name: session.user.user_metadata?.full_name || usernameGuess
    };
    const r = await supabase.from('profiles').insert(insert).select().single();
    currentProfile = r.data;
    loadProfile(); // reload
  }
}

/* Save profile + upload avatar */
$('#saveProfileBtn').addEventListener('click', async () => {
  const display_name = $('#displayNameInput').value.trim();
  const file = $('#avatarFile').files[0];

  if (!currentProfile) return alert('Profile not loaded.');

  // upload file first (if any)
  let avatar_path = currentProfile.avatar_path;
  if (file) {
    const ext = file.name.split('.').pop();
    const filename = `${currentProfile.user_id}/${Date.now()}.${ext}`;
    const { data, error } = await supabase.storage.from('avatars').upload(filename, file, { upsert: true });
    if (error) return alert('Upload error: ' + error.message);
    avatar_path = data.path;
  }

  const updates = {
    display_name,
    avatar_path,
    updated_at: new Date().toISOString()
  };
  const { error } = await supabase.from('profiles').update(updates).eq('user_id', currentProfile.user_id);
  if (error) return alert('Save error: ' + error.message);

  alert('Profile saved');
  loadProfile();
});

/* ---------- Achievements listing ---------- */
async function loadAchievements() {
  const { data, error } = await supabase.from('achievements').select('*').order('created_at', { ascending: false }).limit(50);
  const area = $('#achievementsArea');
  if (error) {
    area.innerHTML = '<div class="notice">Failed to load achievements.</div>';
    return;
  }
  if (!data.length) {
    area.innerHTML = '<div class="notice">No achievements posted yet.</div>';
    return;
  }
  area.innerHTML = '';
  for (const a of data) {
    const card = document.createElement('div');
    card.className = 'ach-card';
    card.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:64px;height:64px;border-radius:8px;overflow:hidden;background:#111">
          <img src="${a.image_url || 'https://i.imgur.com/8Km9tLL.png'}" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div>
          <div style="font-weight:800">${a.title}</div>
          <div class="small">${a.description || ''}</div>
        </div>
      </div>`;
    area.appendChild(card);
  }
}

/* ---------- Initialization ---------- */
(async function init(){
  const session = await checkSession();
  await loadAchievements();
  if (session) await loadProfile();

  // subscribe to auth changes
  supabase.auth.onAuthStateChange(async (event, session) => {
    updateAuthUI(session);
    if (session) await loadProfile();
    else {
      currentProfile = null;
      $('#displayName').innerText = 'Guest';
      $('#usernameMeta').innerText = 'Not signed in';
      $('#bio').innerText = 'Sign in to create and edit your profile.';
      $('#avatarImg').src = 'https://i.imgur.com/8Km9tLL.png';
    }
  });
})();
</script>
</body>
</html>
